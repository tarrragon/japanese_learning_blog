# v1.0.9：輸入練習 JS 邏輯（DDD + BDD）

## 目標

以事件驅動和 DDD 概念開發輸入練習的核心邏輯，並以 BDD 方式撰寫測試。實現完整的輸入驗證、狀態管理和語音朗讀功能。

## 技術決策

| 項目 | 決策 | 理由 |
|------|------|------|
| 架構模式 | 事件驅動 + DDD | 邏輯清晰、易於測試、UI 解耦 |
| 測試框架 | Vitest | 快速、與 Vite 整合良好、支援 BDD |
| 朗讀功能 | Web Speech API | 瀏覽器原生支援、無需額外依賴 |
| 建置工具 | Vite | 快速開發、原生 ES modules |

---

## 驗收條件

### AC-1: Domain 模型完整

- [ ] 定義 `Character` value object（假名 + 羅馬字對應）
- [ ] 定義 `Question` entity（題目文字 + 字元列表）
- [ ] 定義 `TypingSession` aggregate root（管理整體輸入狀態）
- [ ] 定義 `InputBuffer` value object（暫存輸入的羅馬字）
- [ ] Domain 邏輯與 UI 完全分離
- [ ] 羅馬字到假名的轉換邏輯正確

### AC-2: 事件系統

- [ ] 定義 `KeyPressed` 事件
- [ ] 定義 `RomajiMatched` 事件
- [ ] 定義 `CharacterCompleted` 事件
- [ ] 定義 `CharacterMistaken` 事件
- [ ] 定義 `SessionCompleted` 事件
- [ ] 定義 `SpeechRequested` 事件
- [ ] 事件可被監聽和處理
- [ ] 事件驅動 UI 更新

### AC-3: BDD 測試覆蓋

- [ ] 每個 Domain Event 有對應的行為測試
- [ ] 測試描述使用 Given-When-Then 格式
- [ ] 核心邏輯測試覆蓋率 > 80%
- [ ] 測試可在 CI 環境執行

### AC-4: 朗讀功能

- [ ] 每次按鍵觸發對應假名朗讀
- [ ] 使用 Web Speech API
- [ ] 朗讀不阻塞輸入
- [ ] 支援日文語音（ja-JP）

### AC-5: UI 整合

- [ ] 事件正確驅動 UI 狀態更新
- [ ] 虛擬鍵盤正確高亮當前目標鍵
- [ ] 按下的鍵有視覺反饋
- [ ] 輸入反饋即時（< 50ms）

---

## Domain 設計

### 核心概念圖

```
┌─────────────────────────────────────────────────────────────────┐
│ Domain Layer                                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌────────────────┐         ┌────────────────┐                 │
│  │ TypingSession  │────────▶│   Question     │                 │
│  │                │         │                │                 │
│  │ - question     │         │ - text         │                 │
│  │ - currentIndex │         │ - characters[] │                 │
│  │ - inputBuffer  │         │                │                 │
│  │ - startTime    │         └────────────────┘                 │
│  │ - events[]     │                │                           │
│  └────────────────┘                │                           │
│         │                          ▼                           │
│         │                  ┌────────────────┐                 │
│         │                  │   Character    │                 │
│         │                  │                │                 │
│         │                  │ - kana         │                 │
│         │                  │ - romaji[]     │                 │
│         │                  │ - state        │                 │
│         │                  └────────────────┘                 │
│         │                                                      │
│         ▼                                                      │
│  ┌────────────────┐         ┌────────────────┐                │
│  │  InputBuffer   │         │   RomajiMap    │                │
│  │                │────────▶│                │                │
│  │ - keys[]       │         │ - あ: [a]      │                │
│  │ - tryMatch()   │         │ - か: [ka]     │                │
│  └────────────────┘         │ - し: [si,shi] │                │
│                             └────────────────┘                │
│                                                                │
└─────────────────────────────────────────────────────────────────┘
```

### Character 狀態機

```
     ┌─────────────────────────────────────────┐
     │                                         │
     ▼                                         │
┌─────────┐    輸入正確    ┌───────────┐      │
│ PENDING │──────────────▶│ COMPLETED │      │
└─────────┘               └───────────┘      │
     │                                        │
     │ 成為當前目標                            │
     ▼                                        │
┌─────────┐    輸入正確    ┌───────────┐      │
│ CURRENT │──────────────▶│ COMPLETED │──────┘
└─────────┘               └───────────┘
     │                          (下一個字元變 CURRENT)
     │ 輸入錯誤
     ▼
┌─────────┐
│ CURRENT │ (保持 CURRENT，觸發錯誤事件)
└─────────┘
```

### Domain Events 規格

| 事件 | 觸發條件 | 資料 | 用途 |
|------|----------|------|------|
| `KeyPressed` | 使用者按下鍵盤 | `{ key, timestamp }` | 記錄所有輸入 |
| `RomajiMatched` | 輸入匹配當前假名的部分羅馬字 | `{ character, romaji, isPartial }` | 更新 InputBuffer 狀態 |
| `CharacterCompleted` | 完成一個假名輸入 | `{ character, duration }` | 推進到下一個字元 |
| `CharacterMistaken` | 輸入錯誤 | `{ expected, actual }` | 顯示錯誤反饋 |
| `SessionCompleted` | 完成整個題目 | `{ totalTime, accuracy, wpm }` | 顯示結果統計 |
| `SpeechRequested` | 需要朗讀 | `{ text }` | 觸發語音朗讀 |

---

## 羅馬字對應表

### 基本五十音

```javascript
const ROMAJI_MAP = {
  // 母音
  'あ': ['a'], 'い': ['i'], 'う': ['u'], 'え': ['e'], 'お': ['o'],

  // か行
  'か': ['ka'], 'き': ['ki'], 'く': ['ku'], 'け': ['ke'], 'こ': ['ko'],

  // さ行（多種輸入方式）
  'さ': ['sa'], 'し': ['si', 'shi'], 'す': ['su'], 'せ': ['se'], 'そ': ['so'],

  // た行
  'た': ['ta'], 'ち': ['ti', 'chi'], 'つ': ['tu', 'tsu'], 'て': ['te'], 'と': ['to'],

  // な行
  'な': ['na'], 'に': ['ni'], 'ぬ': ['nu'], 'ね': ['ne'], 'の': ['no'],

  // は行
  'は': ['ha'], 'ひ': ['hi'], 'ふ': ['hu', 'fu'], 'へ': ['he'], 'ほ': ['ho'],

  // ま行
  'ま': ['ma'], 'み': ['mi'], 'む': ['mu'], 'め': ['me'], 'も': ['mo'],

  // や行
  'や': ['ya'], 'ゆ': ['yu'], 'よ': ['yo'],

  // ら行
  'ら': ['ra'], 'り': ['ri'], 'る': ['ru'], 'れ': ['re'], 'ろ': ['ro'],

  // わ行
  'わ': ['wa'], 'を': ['wo'], 'ん': ['n', 'nn'],

  // 濁音
  'が': ['ga'], 'ぎ': ['gi'], 'ぐ': ['gu'], 'げ': ['ge'], 'ご': ['go'],
  'ざ': ['za'], 'じ': ['zi', 'ji'], 'ず': ['zu'], 'ぜ': ['ze'], 'ぞ': ['zo'],
  'だ': ['da'], 'ぢ': ['di'], 'づ': ['du', 'dzu'], 'で': ['de'], 'ど': ['do'],
  'ば': ['ba'], 'び': ['bi'], 'ぶ': ['bu'], 'べ': ['be'], 'ぼ': ['bo'],

  // 半濁音
  'ぱ': ['pa'], 'ぴ': ['pi'], 'ぷ': ['pu'], 'ぺ': ['pe'], 'ぽ': ['po'],

  // 拗音
  'きゃ': ['kya'], 'きゅ': ['kyu'], 'きょ': ['kyo'],
  'しゃ': ['sya', 'sha'], 'しゅ': ['syu', 'shu'], 'しょ': ['syo', 'sho'],
  'ちゃ': ['tya', 'cha'], 'ちゅ': ['tyu', 'chu'], 'ちょ': ['tyo', 'cho'],
  'にゃ': ['nya'], 'にゅ': ['nyu'], 'にょ': ['nyo'],
  'ひゃ': ['hya'], 'ひゅ': ['hyu'], 'ひょ': ['hyo'],
  'みゃ': ['mya'], 'みゅ': ['myu'], 'みょ': ['myo'],
  'りゃ': ['rya'], 'りゅ': ['ryu'], 'りょ': ['ryo'],
  'ぎゃ': ['gya'], 'ぎゅ': ['gyu'], 'ぎょ': ['gyo'],
  'じゃ': ['zya', 'ja', 'jya'], 'じゅ': ['zyu', 'ju', 'jyu'], 'じょ': ['zyo', 'jo', 'jyo'],
  'びゃ': ['bya'], 'びゅ': ['byu'], 'びょ': ['byo'],
  'ぴゃ': ['pya'], 'ぴゅ': ['pyu'], 'ぴょ': ['pyo'],

  // 促音（小っ）- 特殊處理：重複下一個子音
  'っ': ['xtu', 'ltu'], // 單獨輸入時

  // 片假名（同樣的對應）
  // ...

  // 標點符號
  '、': [','], '。': ['.'], '？': ['?'], '！': ['!'],
  '「': ['['], '」': [']'],
};
```

### 促音處理邏輯

```javascript
// 促音（っ）後接子音時，重複該子音
// 例：「かった」= katta, 「ちょっと」= chotto

function processSmallTsu(nextChar, input) {
  // 取得下一個字元的第一個子音
  const nextRomaji = ROMAJI_MAP[nextChar][0];
  const consonant = nextRomaji[0]; // 取得子音

  // 促音 = 重複子音
  return consonant;
}
```

---

## 實作步驟

### Step 1: 專案初始化

```
1.1 初始化 Node.js 專案
    - npm init / 更新 package.json
    - 安裝 Vite 和 Vitest

1.2 設定目錄結構
    src/
    ├── domain/
    ├── services/
    └── ui/
    tests/
    ├── domain/
    └── integration/

1.3 設定 Vite 配置
    - 輸出到 static/js/
    - 支援 ES modules

1.4 設定 Vitest 配置
    - BDD 風格（describe/it）
    - 覆蓋率報告
```

### Step 2: Domain 模型建立

```
2.1 建立 Character value object
    - src/domain/Character.js
    - 包含 kana, romaji[], state
    - 不可變（immutable）

2.2 建立 Question entity
    - src/domain/Question.js
    - 從文字建立（Question.fromText()）
    - 包含字元列表

2.3 建立 TypingSession aggregate root
    - src/domain/TypingSession.js
    - 管理輸入狀態
    - 發出 Domain Events

2.4 建立 InputBuffer value object
    - src/domain/InputBuffer.js
    - 暫存輸入的鍵
    - 嘗試匹配羅馬字

2.5 建立 RomajiMap
    - src/domain/RomajiMap.js
    - 完整的假名到羅馬字對應
```

### Step 3: Event 系統建立

```
3.1 定義 DomainEvent 基礎介面
    - src/domain/events/DomainEvent.js
    - 包含 type, timestamp, data

3.2 實作各個具體事件
    - KeyPressed.js
    - RomajiMatched.js
    - CharacterCompleted.js
    - CharacterMistaken.js
    - SessionCompleted.js
    - SpeechRequested.js

3.3 建立 EventEmitter 機制
    - src/services/EventBus.js
    - on(eventType, handler)
    - emit(event)

3.4 連接 TypingSession 到 EventBus
    - Session 發出事件到 EventBus
    - UI 訂閱 EventBus 更新畫面
```

### Step 4: BDD 測試撰寫

```
4.1 Character 測試
    tests/domain/Character.test.js
    - 建立時狀態為 PENDING
    - 可取得羅馬字選項
    - 狀態轉換正確

4.2 TypingSession 測試
    tests/domain/TypingSession.test.js
    - 按正確鍵觸發 RomajiMatched
    - 完成字元觸發 CharacterCompleted
    - 按錯鍵觸發 CharacterMistaken
    - 完成題目觸發 SessionCompleted

4.3 InputBuffer 測試
    tests/domain/InputBuffer.test.js
    - 可累積輸入
    - 可嘗試匹配
    - 可重置

4.4 整合測試
    tests/integration/TypingFlow.test.js
    - 完整輸入流程
    - 事件順序正確
```

### Step 5: 朗讀功能實作

```
5.1 封裝 Web Speech API
    - src/services/SpeechService.js
    - speak(text, lang)
    - 檢查瀏覽器支援

5.2 訂閱 SpeechRequested 事件
    - EventBus.on('SpeechRequested', ...)
    - 呼叫 SpeechService.speak()

5.3 實作按鍵即朗讀
    - 每完成一個假名就朗讀該假名
    - 使用 ja-JP 語音
    - 非阻塞（async）

5.4 處理邊界情況
    - 瀏覽器不支援時的 fallback
    - 快速連續輸入時的處理
```

### Step 6: UI 整合

```
6.1 建立 PracticeController
    - src/ui/PracticeController.js
    - 連接 DOM 和 TypingSession

6.2 訂閱 Domain Events 更新 UI
    - RomajiMatched → 更新 InputBuffer 顯示
    - CharacterCompleted → 更新字元狀態、移動當前指標
    - CharacterMistaken → 顯示錯誤效果
    - SessionCompleted → 顯示結果畫面

6.3 連接鍵盤事件
    - document.addEventListener('keydown', ...)
    - 過濾修飾鍵（Ctrl, Alt 等）
    - 轉發到 TypingSession

6.4 建立 KeyboardRenderer
    - src/ui/KeyboardRenderer.js
    - 根據當前目標高亮按鍵
    - 根據按下狀態顯示效果
```

---

## BDD 測試範例

### Character.test.js

```javascript
import { describe, it, expect } from 'vitest';
import { Character, CharacterState } from '../src/domain/Character';

describe('Character', () => {
  describe('建立時', () => {
    it('狀態應為 PENDING', () => {
      // Given: 無前置條件
      // When: 建立一個字元
      const char = new Character('あ');

      // Then: 狀態應為 PENDING
      expect(char.state).toBe(CharacterState.PENDING);
    });

    it('應包含正確的羅馬字選項', () => {
      // Given: 無前置條件
      // When: 建立「し」字元
      const char = new Character('し');

      // Then: 羅馬字選項應包含 'si' 和 'shi'
      expect(char.romaji).toContain('si');
      expect(char.romaji).toContain('shi');
    });
  });
});
```

### TypingSession.test.js

```javascript
import { describe, it, expect, vi } from 'vitest';
import { TypingSession } from '../src/domain/TypingSession';
import { Question } from '../src/domain/Question';

describe('TypingSession', () => {
  describe('當使用者按下正確的鍵', () => {
    it('應該觸發 RomajiMatched 事件', () => {
      // Given: 一個包含「あ」的題目
      const question = Question.fromText('あ');
      const session = new TypingSession(question);
      const handler = vi.fn();
      session.on('RomajiMatched', handler);

      // When: 使用者按下 'a'
      session.handleKeyPress('a');

      // Then: 應觸發 RomajiMatched 事件
      expect(handler).toHaveBeenCalledTimes(1);
      expect(handler).toHaveBeenCalledWith(
        expect.objectContaining({ romaji: 'a' })
      );
    });
  });

  describe('當完成一個假名輸入', () => {
    it('應該觸發 CharacterCompleted 和 SpeechRequested 事件', () => {
      // Given: 一個包含「か」的題目
      const question = Question.fromText('か');
      const session = new TypingSession(question);
      const completedHandler = vi.fn();
      const speechHandler = vi.fn();
      session.on('CharacterCompleted', completedHandler);
      session.on('SpeechRequested', speechHandler);

      // When: 使用者依序按下 'k' 和 'a'
      session.handleKeyPress('k');
      session.handleKeyPress('a');

      // Then: 應觸發 CharacterCompleted
      expect(completedHandler).toHaveBeenCalledTimes(1);

      // And: 應觸發 SpeechRequested
      expect(speechHandler).toHaveBeenCalledWith(
        expect.objectContaining({ text: 'か' })
      );
    });
  });

  describe('當使用者按下錯誤的鍵', () => {
    it('應該觸發 CharacterMistaken 事件', () => {
      // Given: 一個包含「あ」的題目
      const question = Question.fromText('あ');
      const session = new TypingSession(question);
      const handler = vi.fn();
      session.on('CharacterMistaken', handler);

      // When: 使用者按下 'k'（錯誤）
      session.handleKeyPress('k');

      // Then: 應觸發 CharacterMistaken 事件
      expect(handler).toHaveBeenCalledTimes(1);
      expect(handler).toHaveBeenCalledWith(
        expect.objectContaining({
          expected: expect.arrayContaining(['a']),
          actual: 'k'
        })
      );
    });
  });

  describe('當完成整個題目', () => {
    it('應該觸發 SessionCompleted 事件並包含統計', () => {
      // Given: 一個包含「あい」的題目
      const question = Question.fromText('あい');
      const session = new TypingSession(question);
      const handler = vi.fn();
      session.on('SessionCompleted', handler);

      // When: 使用者完成輸入
      session.handleKeyPress('a'); // あ
      session.handleKeyPress('i'); // い

      // Then: 應觸發 SessionCompleted 並包含統計
      expect(handler).toHaveBeenCalledTimes(1);
      expect(handler).toHaveBeenCalledWith(
        expect.objectContaining({
          totalTime: expect.any(Number),
          accuracy: expect.any(Number)
        })
      );
    });
  });
});
```

---

## 預計新增/修改檔案

```
japanese_learning_blog/
├── package.json                       # [新增/修改] Node.js 配置
├── vite.config.js                     # [新增] Vite 建置配置
├── vitest.config.js                   # [新增] 測試配置
├── src/                               # [新增] 前端原始碼
│   ├── domain/                        # Domain Layer
│   │   ├── Character.js
│   │   ├── Question.js
│   │   ├── TypingSession.js
│   │   ├── InputBuffer.js
│   │   ├── RomajiMap.js
│   │   └── events/
│   │       ├── DomainEvent.js
│   │       ├── KeyPressed.js
│   │       ├── RomajiMatched.js
│   │       ├── CharacterCompleted.js
│   │       ├── CharacterMistaken.js
│   │       ├── SessionCompleted.js
│   │       └── SpeechRequested.js
│   ├── services/                      # Application Services
│   │   ├── SpeechService.js
│   │   └── EventBus.js
│   └── ui/                            # UI Layer
│       ├── PracticeController.js
│       └── KeyboardRenderer.js
├── tests/                             # [新增] 測試目錄
│   ├── domain/
│   │   ├── Character.test.js
│   │   ├── Question.test.js
│   │   ├── TypingSession.test.js
│   │   └── InputBuffer.test.js
│   └── integration/
│       └── TypingFlow.test.js
├── static/
│   └── js/
│       └── practice.js                # [新增] 建置輸出（bundle）
└── layouts/
    └── practice/
        └── list.html                  # [修改] 載入 practice.js
```

---

## 測試重點

### 單元測試（自動化）

```bash
# 執行所有測試
npm test

# 執行覆蓋率報告
npm run test:coverage

# 監聽模式
npm run test:watch
```

### 手動測試

```
□ 正確輸入流程
  - 輸入「あ」→ 按 a → 顯示綠色完成 + 朗讀
  - 輸入「か」→ 按 k → 等待 → 按 a → 完成

□ 錯誤處理
  - 按錯鍵 → 顯示錯誤效果（紅色閃爍）
  - 錯誤後可繼續輸入

□ 多種輸入方式
  - 「し」→ 按 si 或 shi 都可以
  - 「ふ」→ 按 hu 或 fu 都可以

□ 促音處理
  - 「かった」→ katta
  - 「ちょっと」→ chotto

□ 朗讀功能
  - 每完成一個假名就朗讀
  - 快速輸入時朗讀正常

□ 鍵盤視覺回饋
  - 目標鍵高亮（綠色邊框）
  - 按下時有視覺效果
```

---

## 風險與注意事項

### 潛在問題

1. **Web Speech API 支援**
   - Safari 支援較差
   - 解決：檢測支援度，提供 fallback

2. **羅馬字對應完整性**
   - 拗音、促音組合眾多
   - 解決：建立完整測試案例

3. **輸入延遲**
   - DOM 更新可能造成延遲
   - 解決：使用 requestAnimationFrame

4. **片假名支援**
   - 目前專注平假名
   - v1.1.0+ 可擴展

### 效能考量

- Domain 邏輯為純函數，易於優化
- UI 更新使用批次處理
- 事件處理使用非同步

---

## 相關資源

- [Vitest 文檔](https://vitest.dev/)
- [Web Speech API](https://developer.mozilla.org/en-US/docs/Web/API/Web_Speech_API)
- [Domain-Driven Design Patterns](https://martinfowler.com/tags/domain%20driven%20design.html)
- v1.0.8 的 UI 結構

---

**建立日期**：2024-12-17
**前置版本**：v1.0.8
**預計開發分支**：`feature/v1.0.9-typing-logic`
