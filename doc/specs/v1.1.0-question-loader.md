# v1.1.0：卡片題目載入系統整合

## 目標

建立從 Zettelkasten 卡片隨機載入練習題目的系統，完成輸入練習功能的完整閉環。這是 v1.1.0 的里程碑版本，標誌著日文學習應用系統的完成。

## 技術決策

| 項目 | 決策 | 理由 |
|------|------|------|
| 題目來源 | 卡片的「日文解釋」區塊 | 自然日文、難度適中、與卡片內容關聯 |
| 資料格式 | JSON 題庫 | 前端易於處理、支援篩選和查詢 |
| 產生時機 | Hugo 建置時 | 自動化、與部署流程整合 |
| 載入方式 | 前端隨機選取 | 無需後端、即時響應 |

---

## 驗收條件

### AC-1: 題庫產生

- [ ] 建置腳本可從卡片提取日文解釋區塊
- [ ] 產生羅馬字對應（自動轉換或使用現有工具）
- [ ] 產生結構化的 JSON 題庫檔案
- [ ] 題目包含必要 metadata（來源卡片、JLPT 等級等）
- [ ] 建置過程無錯誤

### AC-2: 隨機載入

- [ ] 進入練習頁面自動載入隨機題目
- [ ] 題目顯示正確（日文 + 羅馬拼音）
- [ ] 載入過程有適當的 loading 狀態
- [ ] 網路錯誤時有適當的錯誤提示

### AC-3: 題目切換

- [ ] 提供「下一題」按鈕
- [ ] 提供「重新開始」按鈕
- [ ] 可選：提供 JLPT 等級篩選
- [ ] 切換時有平滑的過渡效果

### AC-4: 完成回饋

- [ ] 完成題目後顯示統計（時間、正確率、WPM）
- [ ] 顯示題目來源卡片連結
- [ ] 可直接開始下一題
- [ ] 可返回查看來源卡片

### AC-5: 端到端整合

- [ ] Hugo 建置時自動產生題庫
- [ ] GitHub Actions workflow 包含題庫產生步驟
- [ ] 練習頁面正確載入題庫
- [ ] 完整輸入流程可運作
- [ ] 部署後功能正常

---

## 題庫設計

### JSON 格式規格

```json
{
  "version": "1.1.0",
  "generated": "2024-12-17T10:00:00Z",
  "questions": [
    {
      "id": "noun-001",
      "text": "「朝ごはん」とは、朝に食べる食事のことです。",
      "romaji": "「asagohan」toha,asanitaberushokujiinokotodesu。",
      "characters": [
        { "kana": "「", "romaji": ["「"] },
        { "kana": "朝", "romaji": ["asa"] },
        { "kana": "ご", "romaji": ["go"] },
        { "kana": "は", "romaji": ["ha"] },
        { "kana": "ん", "romaji": ["n", "nn"] }
        // ...
      ],
      "source": {
        "path": "/noun/001_asagohan/",
        "title": "朝ごはん（早餐）",
        "category": "noun",
        "jlpt": "n5"
      },
      "metadata": {
        "characterCount": 24,
        "difficulty": "easy",
        "hasKanji": true
      }
    }
  ],
  "stats": {
    "totalQuestions": 433,
    "byJlpt": {
      "n5": 120,
      "n4": 150,
      "n3": 100,
      "n2": 50,
      "n1": 13
    },
    "byCategory": {
      "noun": 73,
      "verb-ru": 25,
      "verb-u": 30,
      "grammar": 136
      // ...
    }
  }
}
```

### 題目來源：日文解釋區塊

從卡片的「## 日文解釋」或「## 日文」區塊提取：

```markdown
## 日文解釋

「朝ごはん」とは、朝に食べる食事のことで、一日の最初の食事を指します。
「朝」（あさ、morning）と「ごはん」（meal/rice）を組み合わせた言葉です。
```

提取規則：
1. 取第一段落（150-300 字為佳）
2. 移除括號內的英文註解
3. 保留日文標點符號

---

## 實作步驟

### Step 1: 題庫產生腳本

```
1.1 建立 Python 腳本結構
    scripts/generate-question-bank.py
    - 掃描 zettelkasten/ 目錄
    - 解析 Markdown 檔案
    - 提取日文解釋區塊

1.2 實作日文到羅馬字轉換
    方案 A：使用 pykakasi 套件
    方案 B：使用現有的 RomajiMap（從 JS 移植）
    方案 C：呼叫外部 API（不推薦）

1.3 產生字元分解
    - 將文字分解為單一字元
    - 為每個字元產生羅馬字選項
    - 處理漢字（需要讀音資訊）

1.4 輸出 JSON 格式
    - 寫入 static/data/questions.json
    - 包含統計資訊
    - 壓縮輸出（minify）

1.5 錯誤處理
    - 跳過無法處理的卡片
    - 記錄警告訊息
    - 產生處理報告
```

### Step 2: 題庫整合到 Hugo

```
2.1 修改 GitHub Actions workflow
    - 在 Hugo 建置前執行題庫產生腳本
    - 確保 Python 環境可用
    - 安裝必要套件（pykakasi 等）

2.2 設定題庫檔案位置
    - static/data/questions.json
    - 建置後自動複製到 public/

2.3 本地開發支援
    - 提供手動執行指令
    - 支援增量更新（可選）
```

### Step 3: 前端題目載入

```
3.1 建立 QuestionLoader service
    src/services/QuestionLoader.js
    - fetch('/data/questions.json')
    - 快取機制
    - 錯誤處理

3.2 實作隨機選取邏輯
    - 真隨機：Math.random()
    - 避免連續重複
    - 支援過濾條件

3.3 實作 JLPT 等級篩選
    - 提供下拉選單或按鈕
    - 預設「全部」
    - 記住使用者選擇（localStorage）

3.4 處理載入狀態
    - 顯示 loading 動畫
    - 載入失敗時顯示錯誤
    - 提供重試按鈕
```

### Step 4: UI 整合

```
4.1 連接 QuestionLoader 到 TypingSession
    - 頁面載入時取得題目
    - 題目完成後可載入下一題
    - 傳遞題目到 TypingSession

4.2 實作題目切換 UI
    <div class="practice-controls">
      <button id="btn-next">下一題</button>
      <button id="btn-restart">重新開始</button>
      <select id="jlpt-filter">
        <option value="all">全部</option>
        <option value="n5">N5</option>
        <option value="n4">N4</option>
        ...
      </select>
    </div>

4.3 實作完成回饋 UI
    <div class="practice-result">
      <h2>完成！</h2>
      <div class="stats">
        <span>時間：{time}秒</span>
        <span>正確率：{accuracy}%</span>
        <span>速度：{wpm} WPM</span>
      </div>
      <a href="{sourcePath}">查看來源卡片 →</a>
      <button id="btn-next-after">下一題</button>
    </div>

4.4 加入過渡動畫
    - 題目切換時的 fade 效果
    - 結果顯示時的彈出效果
```

### Step 5: 端到端測試

```
5.1 本地完整流程測試
    - hugo server 啟動
    - 練習頁面載入題目
    - 完成輸入
    - 切換下一題
    - JLPT 篩選

5.2 建置並部署測試
    - 本地 hugo build
    - 檢查 public/data/questions.json
    - 推送並觀察 GitHub Actions

5.3 線上功能驗證
    - 訪問部署後的網站
    - 測試所有功能
    - 檢查錯誤日誌

5.4 效能優化
    - 題庫檔案大小檢查
    - 載入時間測量
    - 必要時實作分頁載入
```

---

## 預計新增/修改檔案

```
japanese_learning_blog/
├── scripts/
│   └── generate-question-bank.py      # [新增] 題庫產生腳本
├── static/
│   └── data/
│       └── questions.json             # [新增] 題庫檔案（建置產生）
├── src/
│   └── services/
│       └── QuestionLoader.js          # [新增] 題目載入服務
├── layouts/
│   └── practice/
│       └── list.html                  # [修改] 加入控制 UI 和結果顯示
├── assets/
│   └── css/
│       └── practice.css               # [修改] 加入新 UI 樣式
├── .github/
│   └── workflows/
│       └── hugo.yml                   # [修改] 加入題庫產生步驟
└── pyproject.toml                     # [修改] 加入新依賴（pykakasi）
```

### generate-question-bank.py 結構

```python
#!/usr/bin/env python3
# /// script
# requires-python = ">=3.11"
# dependencies = [
#     "pykakasi",
#     "pyyaml",
# ]
# ///

"""
題庫產生腳本

用法：
    uv run scripts/generate-question-bank.py
    uv run scripts/generate-question-bank.py --output static/data/questions.json
    uv run scripts/generate-question-bank.py --verbose
"""

import argparse
import json
from pathlib import Path
from datetime import datetime

import pykakasi
import yaml


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('--output', default='static/data/questions.json')
    parser.add_argument('--verbose', action='store_true')
    args = parser.parse_args()

    # 掃描卡片
    cards = scan_cards(Path('zettelkasten'))

    # 產生題目
    questions = []
    for card in cards:
        question = process_card(card)
        if question:
            questions.append(question)

    # 輸出 JSON
    output = {
        'version': '1.1.0',
        'generated': datetime.utcnow().isoformat() + 'Z',
        'questions': questions,
        'stats': calculate_stats(questions)
    }

    Path(args.output).parent.mkdir(parents=True, exist_ok=True)
    with open(args.output, 'w', encoding='utf-8') as f:
        json.dump(output, f, ensure_ascii=False, separators=(',', ':'))

    print(f'Generated {len(questions)} questions to {args.output}')


if __name__ == '__main__':
    main()
```

### 更新後的 hugo.yml

```yaml
name: Deploy Hugo site to Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

# ... 權限設定 ...

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      HUGO_VERSION: 0.121.0
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 新增：設定 Python 環境
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 新增：安裝 uv
      - name: Install uv
        run: pip install uv

      # 新增：產生題庫
      - name: Generate Question Bank
        run: uv run scripts/generate-question-bank.py

      - name: Install Hugo CLI
        run: |
          wget -O ${{ runner.temp }}/hugo.deb https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.deb \
          && sudo dpkg -i ${{ runner.temp }}/hugo.deb

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v4

      - name: Build with Hugo
        env:
          HUGO_ENVIRONMENT: production
        run: |
          hugo \
            --minify \
            --baseURL "${{ steps.pages.outputs.base_url }}/"

      # ... 後續步驟 ...
```

---

## 測試重點

### 題庫產生測試

```bash
# 本地執行
uv run scripts/generate-question-bank.py --verbose

# 檢查輸出
cat static/data/questions.json | python -m json.tool | head -50

# 驗證格式
python -c "import json; json.load(open('static/data/questions.json'))"
```

### 前端載入測試

```
□ 頁面載入時顯示 loading
□ 載入成功後顯示題目
□ 網路錯誤時顯示錯誤訊息
□ 重試按鈕可正常運作
```

### 功能測試

```
□ 隨機載入
  - 每次重新整理載入不同題目
  - 連續點「下一題」不會重複

□ JLPT 篩選
  - 選擇 N5 只顯示 N5 題目
  - 選擇「全部」顯示所有題目
  - 篩選後點「下一題」維持篩選

□ 完成回饋
  - 顯示正確的統計
  - 來源卡片連結可點擊
  - 可繼續下一題

□ 重新開始
  - 進度歸零
  - 可重新輸入同一題
```

### 效能測試

```
□ 題庫檔案大小 < 500KB
□ 首次載入時間 < 3秒
□ 切換題目 < 100ms
```

---

## 風險與注意事項

### 潛在問題

1. **漢字讀音**
   - 同一個漢字可能有多種讀音
   - 解決：使用 pykakasi 的上下文分析，或提供多種讀音選項

2. **題庫檔案大小**
   - 433+ 張卡片可能產生較大的 JSON
   - 解決：壓縮輸出、只保留必要欄位、考慮分頁

3. **特殊字元處理**
   - 括號、引號、特殊標點
   - 解決：建立完整的標點符號對應表

4. **羅馬字轉換準確度**
   - pykakasi 可能有錯誤
   - 解決：建立驗證機制、人工校正常見錯誤

### 後續擴展（v1.1.x+）

- 支援片假名
- 支援例句作為題目
- 使用者練習紀錄
- 錯誤統計和複習推薦
- 多人排行榜

---

## 相關資源

- [pykakasi](https://pykakasi.readthedocs.io/) - Python 日文轉羅馬字
- v1.0.9 的輸入邏輯
- 現有卡片的格式規範

---

**建立日期**：2024-12-17
**前置版本**：v1.0.9
**預計開發分支**：`feature/v1.1.0-question-loader`
**里程碑**：日文學習應用系統 v1.1.0 完成
