var Q={"あ":["a"],"い":["i"],"う":["u"],"え":["e"],"お":["o"],"ア":["a"],"イ":["i"],"ウ":["u"],"エ":["e"],"オ":["o"],"か":["ka"],"き":["ki"],"く":["ku"],"け":["ke"],"こ":["ko"],"カ":["ka"],"キ":["ki"],"ク":["ku"],"ケ":["ke"],"コ":["ko"],"さ":["sa"],"し":["si","shi"],"す":["su"],"せ":["se"],"そ":["so"],"サ":["sa"],"シ":["si","shi"],"ス":["su"],"セ":["se"],"ソ":["so"],"た":["ta"],"ち":["ti","chi"],"つ":["tu","tsu"],"て":["te"],"と":["to"],"タ":["ta"],"チ":["ti","chi"],"ツ":["tu","tsu"],"テ":["te"],"ト":["to"],"な":["na"],"に":["ni"],"ぬ":["nu"],"ね":["ne"],"の":["no"],"ナ":["na"],"ニ":["ni"],"ヌ":["nu"],"ネ":["ne"],"ノ":["no"],"は":["ha"],"ひ":["hi"],"ふ":["hu","fu"],"へ":["he"],"ほ":["ho"],"ハ":["ha"],"ヒ":["hi"],"フ":["hu","fu"],"ヘ":["he"],"ホ":["ho"],"ま":["ma"],"み":["mi"],"む":["mu"],"め":["me"],"も":["mo"],"マ":["ma"],"ミ":["mi"],"ム":["mu"],"メ":["me"],"モ":["mo"],"や":["ya"],"ゆ":["yu"],"よ":["yo"],"ヤ":["ya"],"ユ":["yu"],"ヨ":["yo"],"ら":["ra"],"り":["ri"],"る":["ru"],"れ":["re"],"ろ":["ro"],"ラ":["ra"],"リ":["ri"],"ル":["ru"],"レ":["re"],"ロ":["ro"],"わ":["wa"],"を":["wo"],"ん":["n","nn"],"ワ":["wa"],"ヲ":["wo"],"ン":["n","nn"],"が":["ga"],"ぎ":["gi"],"ぐ":["gu"],"げ":["ge"],"ご":["go"],"ガ":["ga"],"ギ":["gi"],"グ":["gu"],"ゲ":["ge"],"ゴ":["go"],"ざ":["za"],"じ":["zi","ji"],"ず":["zu"],"ぜ":["ze"],"ぞ":["zo"],"ザ":["za"],"ジ":["zi","ji"],"ズ":["zu"],"ゼ":["ze"],"ゾ":["zo"],"だ":["da"],"ぢ":["di"],"づ":["du","dzu"],"で":["de"],"ど":["do"],"ダ":["da"],"ヂ":["di"],"ヅ":["du","dzu"],"デ":["de"],"ド":["do"],"ば":["ba"],"び":["bi"],"ぶ":["bu"],"べ":["be"],"ぼ":["bo"],"バ":["ba"],"ビ":["bi"],"ブ":["bu"],"ベ":["be"],"ボ":["bo"],"ぱ":["pa"],"ぴ":["pi"],"ぷ":["pu"],"ぺ":["pe"],"ぽ":["po"],"パ":["pa"],"ピ":["pi"],"プ":["pu"],"ペ":["pe"],"ポ":["po"],"きゃ":["kya"],"きゅ":["kyu"],"きょ":["kyo"],"しゃ":["sya","sha"],"しゅ":["syu","shu"],"しょ":["syo","sho"],"ちゃ":["tya","cha"],"ちゅ":["tyu","chu"],"ちょ":["tyo","cho"],"にゃ":["nya"],"にゅ":["nyu"],"にょ":["nyo"],"ひゃ":["hya"],"ひゅ":["hyu"],"ひょ":["hyo"],"みゃ":["mya"],"みゅ":["myu"],"みょ":["myo"],"りゃ":["rya"],"りゅ":["ryu"],"りょ":["ryo"],"ぎゃ":["gya"],"ぎゅ":["gyu"],"ぎょ":["gyo"],"じゃ":["zya","ja","jya"],"じゅ":["zyu","ju","jyu"],"じょ":["zyo","jo","jyo"],"びゃ":["bya"],"びゅ":["byu"],"びょ":["byo"],"ぴゃ":["pya"],"ぴゅ":["pyu"],"ぴょ":["pyo"],"っ":["xtu","ltu","xtsu","ltsu"],"ッ":["xtu","ltu","xtsu","ltsu"],"ぁ":["xa","la"],"ぃ":["xi","li"],"ぅ":["xu","lu"],"ぇ":["xe","le"],"ぉ":["xo","lo"],"ゃ":["xya","lya"],"ゅ":["xyu","lyu"],"ょ":["xyo","lyo"],"、":[","],"。":["."],"？":["?"],"！":["!"],"「":["["],"」":["]"],"ー":["-"]};function A(z){return Q[z]||[]}function q(z,F){return F.some((G)=>G.startsWith(z))}function E(z,F){return F.includes(z)}var L={PENDING:"pending",CURRENT:"current",COMPLETED:"completed"};class U{#z;#F;#G;constructor(z,F=L.PENDING,G=null){this.#z=z,this.#F=G||A(z),this.#G=F}get kana(){return this.#z}get romaji(){return this.#F}get state(){return this.#G}setCurrent(){return new U(this.#z,L.CURRENT,this.#F)}setCompleted(){return new U(this.#z,L.COMPLETED,this.#F)}matchesRomaji(z){return E(z,this.#F)}isPartialMatch(z){return q(z,this.#F)}}var M=["きゃ","きゅ","きょ","しゃ","しゅ","しょ","ちゃ","ちゅ","ちょ","にゃ","にゅ","にょ","ひゃ","ひゅ","ひょ","みゃ","みゅ","みょ","りゃ","りゅ","りょ","ぎゃ","ぎゅ","ぎょ","じゃ","じゅ","じょ","びゃ","びゅ","びょ","ぴゃ","ぴゅ","ぴょ","キャ","キュ","キョ","シャ","シュ","ショ","チャ","チュ","チョ","ニャ","ニュ","ニョ","ヒャ","ヒュ","ヒョ","ミャ","ミュ","ミョ","リャ","リュ","リョ","ギャ","ギュ","ギョ","ジャ","ジュ","ジョ","ビャ","ビュ","ビョ","ピャ","ピュ","ピョ"];function R(z){let F=[],G=0;while(G<z.length){if(G+1<z.length){let V=z.slice(G,G+2);if(M.includes(V)||Q[V]){F.push(V),G+=2;continue}}F.push(z[G]),G+=1}return F}var B=["な","に","ぬ","ね","の","にゃ","にゅ","にょ","ナ","ニ","ヌ","ネ","ノ","ニャ","ニュ","ニョ"];function S(z){return z==="ん"||z==="ン"}function I(z){return B.includes(z)}class X{#z;#F;#G;constructor(z,F,G=0){this.#z=z,this.#F=F,this.#G=G}static fromText(z){let G=R(z).map((V,Z,Y)=>{let N=null;if(S(V)&&Z<Y.length-1){let P=Y[Z+1];if(I(P))N=["nn"]}let J=new U(V,L.PENDING,N);return Z===0?J.setCurrent():J});return new X(z,G,0)}get text(){return this.#z}get characters(){return this.#F}get currentIndex(){return this.#G}getCurrentCharacter(){if(this.#G>=this.#F.length)return null;return this.#F[this.#G]}advance(){if(this.isCompleted())return this;let z=this.#F.map((F,G)=>{if(G===this.#G)return F.setCompleted();else if(G===this.#G+1)return F.setCurrent();return F});return new X(this.#z,z,this.#G+1)}isCompleted(){return this.#G>=this.#F.length}getProgress(){if(this.#F.length===0)return 1;return this.#G/this.#F.length}}var $={COMPLETE:"COMPLETE",PARTIAL:"PARTIAL",MISMATCH:"MISMATCH"};class W{#z;constructor(z=""){this.#z=z}get value(){return this.#z}get length(){return this.#z.length}isEmpty(){return this.#z.length===0}add(z){return new W(this.#z+z)}reset(){return new W}tryMatch(z){if(z.matchesRomaji(this.#z))return{type:$.COMPLETE};if(z.isPartialMatch(this.#z))return{type:$.PARTIAL};return{type:$.MISMATCH}}}class _{#z;#F;#G;#V;#$;#W;constructor(z){this.#z=z,this.#F=new W,this.#G=new Date,this.#V=new Map,this.#$=0,this.#W=0}get question(){return this.#z}get startTime(){return this.#G}get inputBuffer(){return this.#F}on(z,F){if(!this.#V.has(z))this.#V.set(z,[]);this.#V.get(z).push(F)}#Z(z,F){let G=this.#V.get(z);if(G)G.forEach((V)=>V(F))}handleKeyPress(z){if(this.#z.isCompleted())return;this.#$++,this.#Z("KeyPressed",{key:z,timestamp:Date.now()});let F=this.#z.getCurrentCharacter();if(!F)return;let G=this.#F.add(z);switch(G.tryMatch(F).type){case $.COMPLETE:this.#J(F,G);break;case $.PARTIAL:this.#L(G);break;case $.MISMATCH:this.#Y(F,z);break}}#J(z,F){if(this.#Z("RomajiMatched",{romaji:F.value,isPartial:!1}),this.#Z("CharacterCompleted",{character:z,duration:Date.now()-this.#G.getTime()}),this.#Z("SpeechRequested",{text:z.kana}),this.#z=this.#z.advance(),this.#F=new W,this.#z.isCompleted())this.#U()}#L(z){this.#F=z,this.#Z("RomajiMatched",{romaji:z.value,isPartial:!0})}#Y(z,F){this.#W++,this.#Z("CharacterMistaken",{expected:z.romaji,actual:F}),this.#F=new W}#U(){let F=new Date().getTime()-this.#G.getTime(),G=this.#$-this.#W,V=this.#$>0?G/this.#$:1;this.#Z("SessionCompleted",{totalTime:F,accuracy:V,totalKeystrokes:this.#$,mistakes:this.#W})}getCurrentCharacter(){return this.#z.getCurrentCharacter()}getHintRomaji(){let z=this.getCurrentCharacter();if(!z||z.romaji.length===0)return"";return z.romaji[0]}getProgress(){return this.#z.getProgress()}}class w{#z;#F;#G;constructor(z={}){this.#z=z.lang||"ja-JP",this.#F=z.rate||1,this.#G=z.speechSynthesis}get lang(){return this.#z}isSupported(){return this.#G!==void 0&&this.#G!==null}speak(z){return new Promise((F,G)=>{if(!this.isSupported()){F();return}let V=this.#V(z);V.lang=this.#z,V.rate=this.#F,V.onend=()=>F(),V.onerror=(Z)=>G(Z),this.#G.speak(V)})}cancel(){if(this.isSupported())this.#G.cancel()}#V(z){if(typeof SpeechSynthesisUtterance!=="undefined")return new SpeechSynthesisUtterance(z);return{text:z,lang:"",rate:1,onend:null,onerror:null}}}class D{#z;#F;#G;#V;constructor(z){let F=X.fromText(z.text);this.#z=new _(F),this.#F=new w({speechSynthesis:typeof speechSynthesis!=="undefined"?speechSynthesis:void 0}),this.#G=z.elements,this.#V=z.keyboardRenderer,this.#$(),this.#W(),this.#Z()}#$(){this.#z.on("RomajiMatched",(z)=>{this.#Y(z.romaji)}),this.#z.on("CharacterCompleted",(z)=>{this.#Z(),this.#X()}),this.#z.on("SpeechRequested",(z)=>{this.#F.speak(z.text)}),this.#z.on("CharacterMistaken",(z)=>{this.#N(),this.#Y("")}),this.#z.on("SessionCompleted",(z)=>{this.#Q(z)})}#W(){document.addEventListener("keydown",(z)=>{if(z.ctrlKey||z.altKey||z.metaKey)return;if(z.key.length!==1)return;z.preventDefault();let F=z.key.toLowerCase();this.#V?.showKeyPress(F),this.#z.handleKeyPress(F)})}#Z(){this.#J(),this.#L(),this.#U()}#J(){let z=this.#G.textContainer;if(!z)return;let F=this.#z.question.characters;z.innerHTML=F.map((G,V)=>{return`<span class="char ${`char-${G.state}`}">${G.kana}</span>`}).join("")}#L(){let z=this.#G.romajiContainer;if(!z)return;let F=this.#z.question.characters;z.innerHTML=F.map((G,V)=>{let Z=`romaji-${G.state}`,Y=G.romaji[0]||"";return`<span class="romaji ${Z}">${Y}</span>`}).join("")}#Y(z){let F=this.#G.bufferDisplay;if(F)F.textContent=z}#U(){if(!this.#V)return;let z=this.#z.getHintRomaji(),F=z?z[0]:null;this.#V.highlightKey(F)}#X(){let z=this.#G.textContainer;if(!z)return;z.classList.add("flash-success"),setTimeout(()=>z.classList.remove("flash-success"),200)}#N(){let z=this.#G.textContainer;if(!z)return;z.classList.add("flash-error"),setTimeout(()=>z.classList.remove("flash-error"),200)}#Q(z){let F=this.#G.resultContainer;if(!F)return;let G=Math.round(z.accuracy*100),V=(z.totalTime/1000).toFixed(1);F.innerHTML=`
      <div class="result-box">
        <h2>完成！</h2>
        <div class="result-stats">
          <div class="stat">
            <span class="stat-value">${G}%</span>
            <span class="stat-label">準確率</span>
          </div>
          <div class="stat">
            <span class="stat-value">${V}s</span>
            <span class="stat-label">時間</span>
          </div>
          <div class="stat">
            <span class="stat-value">${z.totalKeystrokes}</span>
            <span class="stat-label">按鍵數</span>
          </div>
        </div>
        <button class="retry-btn" onclick="location.reload()">再試一次</button>
      </div>
    `,F.style.display="flex"}getProgress(){return this.#z.getProgress()}}class H{#z;#F;constructor(z){this.#z=z,this.#F=null}highlightKey(z){if(this.#F)this.#F.classList.remove("key-target");if(!z){this.#F=null;return}let F=this.#z.querySelector(`[data-key="${z}"]`);if(F)F.classList.add("key-target"),this.#F=F}showKeyPress(z){let F=this.#z.querySelector(`[data-key="${z}"]`);if(!F)return;F.classList.add("key-pressed"),setTimeout(()=>{F.classList.remove("key-pressed")},100)}clearHighlights(){this.#z.querySelectorAll(".key").forEach((F)=>{F.classList.remove("key-target","key-pressed")}),this.#F=null}}var K=["あいうえお","かきくけこ","さしすせそ","たちつてと","なにぬねの","はひふへほ","まみむめも","やゆよ","らりるれろ","わをん","がぎぐげご","ざじずぜぞ","だぢづでど","ばびぶべぼ","ぱぴぷぺぽ","きゃきゅきょ","しゃしゅしょ","ちゃちゅちょ","こんにちは","ありがとう","おはよう","さようなら","いただきます","ごちそうさま"];function g(){let z=Math.floor(Math.random()*K.length);return K[z]}function O(){let z=document.getElementById("practice-text"),F=document.getElementById("practice-romaji"),G=document.getElementById("keyboard");if(!z||!F||!G){console.error("找不到必要的 DOM 元素");return}let V=document.getElementById("result-container");if(!V)V=document.createElement("div"),V.id="result-container",V.className="result-container",V.style.display="none",document.querySelector(".practice-container")?.appendChild(V);let Z=document.getElementById("buffer-display");if(!Z)Z=document.createElement("div"),Z.id="buffer-display",Z.className="buffer-display",F.parentNode?.insertBefore(Z,F.nextSibling);let Y=new H(G),J=new URLSearchParams(window.location.search).get("text")||g(),P=new D({text:J,elements:{textContainer:z,romajiContainer:F,resultContainer:V,bufferDisplay:Z},keyboardRenderer:Y});console.log("練習文字:",J)}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",O);else O();
