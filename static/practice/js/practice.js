var U={"あ":["a"],"い":["i"],"う":["u"],"え":["e"],"お":["o"],"ア":["a"],"イ":["i"],"ウ":["u"],"エ":["e"],"オ":["o"],"か":["ka"],"き":["ki"],"く":["ku"],"け":["ke"],"こ":["ko"],"カ":["ka"],"キ":["ki"],"ク":["ku"],"ケ":["ke"],"コ":["ko"],"さ":["sa"],"し":["si","shi"],"す":["su"],"せ":["se"],"そ":["so"],"サ":["sa"],"シ":["si","shi"],"ス":["su"],"セ":["se"],"ソ":["so"],"た":["ta"],"ち":["ti","chi"],"つ":["tu","tsu"],"て":["te"],"と":["to"],"タ":["ta"],"チ":["ti","chi"],"ツ":["tu","tsu"],"テ":["te"],"ト":["to"],"な":["na"],"に":["ni"],"ぬ":["nu"],"ね":["ne"],"の":["no"],"ナ":["na"],"ニ":["ni"],"ヌ":["nu"],"ネ":["ne"],"ノ":["no"],"は":["ha"],"ひ":["hi"],"ふ":["hu","fu"],"へ":["he"],"ほ":["ho"],"ハ":["ha"],"ヒ":["hi"],"フ":["hu","fu"],"ヘ":["he"],"ホ":["ho"],"ま":["ma"],"み":["mi"],"む":["mu"],"め":["me"],"も":["mo"],"マ":["ma"],"ミ":["mi"],"ム":["mu"],"メ":["me"],"モ":["mo"],"や":["ya"],"ゆ":["yu"],"よ":["yo"],"ヤ":["ya"],"ユ":["yu"],"ヨ":["yo"],"ら":["ra"],"り":["ri"],"る":["ru"],"れ":["re"],"ろ":["ro"],"ラ":["ra"],"リ":["ri"],"ル":["ru"],"レ":["re"],"ロ":["ro"],"わ":["wa"],"を":["wo"],"ん":["n","nn"],"ワ":["wa"],"ヲ":["wo"],"ン":["n","nn"],"が":["ga"],"ぎ":["gi"],"ぐ":["gu"],"げ":["ge"],"ご":["go"],"ガ":["ga"],"ギ":["gi"],"グ":["gu"],"ゲ":["ge"],"ゴ":["go"],"ざ":["za"],"じ":["zi","ji"],"ず":["zu"],"ぜ":["ze"],"ぞ":["zo"],"ザ":["za"],"ジ":["zi","ji"],"ズ":["zu"],"ゼ":["ze"],"ゾ":["zo"],"だ":["da"],"ぢ":["di"],"づ":["du","dzu"],"で":["de"],"ど":["do"],"ダ":["da"],"ヂ":["di"],"ヅ":["du","dzu"],"デ":["de"],"ド":["do"],"ば":["ba"],"び":["bi"],"ぶ":["bu"],"べ":["be"],"ぼ":["bo"],"バ":["ba"],"ビ":["bi"],"ブ":["bu"],"ベ":["be"],"ボ":["bo"],"ぱ":["pa"],"ぴ":["pi"],"ぷ":["pu"],"ぺ":["pe"],"ぽ":["po"],"パ":["pa"],"ピ":["pi"],"プ":["pu"],"ペ":["pe"],"ポ":["po"],"きゃ":["kya"],"きゅ":["kyu"],"きょ":["kyo"],"しゃ":["sya","sha"],"しゅ":["syu","shu"],"しょ":["syo","sho"],"ちゃ":["tya","cha"],"ちゅ":["tyu","chu"],"ちょ":["tyo","cho"],"にゃ":["nya"],"にゅ":["nyu"],"にょ":["nyo"],"ひゃ":["hya"],"ひゅ":["hyu"],"ひょ":["hyo"],"みゃ":["mya"],"みゅ":["myu"],"みょ":["myo"],"りゃ":["rya"],"りゅ":["ryu"],"りょ":["ryo"],"ぎゃ":["gya"],"ぎゅ":["gyu"],"ぎょ":["gyo"],"じゃ":["zya","ja","jya"],"じゅ":["zyu","ju","jyu"],"じょ":["zyo","jo","jyo"],"びゃ":["bya"],"びゅ":["byu"],"びょ":["byo"],"ぴゃ":["pya"],"ぴゅ":["pyu"],"ぴょ":["pyo"],"っ":["xtu","ltu","xtsu","ltsu"],"ッ":["xtu","ltu","xtsu","ltsu"],"ぁ":["xa","la"],"ぃ":["xi","li"],"ぅ":["xu","lu"],"ぇ":["xe","le"],"ぉ":["xo","lo"],"ゃ":["xya","lya"],"ゅ":["xyu","lyu"],"ょ":["xyo","lyo"],"、":[","],"。":["."],"？":["?"],"！":["!"],"「":["["],"」":["]"],"ー":["-"],"〜":["~"],"ティ":["thi","texi","teli"],"ディ":["dhi","dexi","deli"],"ファ":["fa","huxa","hula"],"フィ":["fi","huxi","huli"],"フェ":["fe","huxe","hule"],"フォ":["fo","huxo","hulo"],"ウィ":["wi","uxi","uli"],"ウェ":["we","uxe","ule"],"ウォ":["wo","uxo","ulo"],"ヴァ":["va","vuxa"],"ヴィ":["vi","vuxi"],"ヴ":["vu"],"ヴェ":["ve","vuxe"],"ヴォ":["vo","vuxo"],"ゐ":["wi"],"ヰ":["wi"],"ゑ":["we"],"ヱ":["we"]};function E(z){return U[z]||[]}function b(z,G){return G.some((V)=>V.startsWith(z))}function v(z,G){return G.includes(z)}var q=["っ","ッ"],m=["、","。","？","！","「","」","ー","〜"];function j(z){return m.includes(z)}function C(z){return q.includes(z)}function h(z){if(z.startsWith("ch"))return"c";if(z.startsWith("sh"))return"s";if(z.startsWith("ts"))return"t";if(z.startsWith("th"))return"t";if(z.startsWith("dh"))return"d";let G=z[0];return["a","i","u","e","o"].includes(G)?null:G}function P(z){return z.length>=2&&q.includes(z[0])}function y(z){if(!P(z))return[];let G=z.slice(1),V=E(G);if(V.length===0)return[];let Z=[];for(let W of V){let X=h(W);if(X)Z.push(X+W)}let $=["xtu","ltu"];for(let W of $)for(let X of V)Z.push(W+X);return Z}var H={PENDING:"pending",CURRENT:"current",COMPLETED:"completed"};class w{#z;#G;#V;constructor(z,G=H.PENDING,V=null){if(this.#z=z,V)this.#G=V;else if(P(z))this.#G=y(z);else this.#G=E(z);this.#V=G}get kana(){return this.#z}get romaji(){return this.#G}get state(){return this.#V}setCurrent(){return new w(this.#z,H.CURRENT,this.#G)}setCompleted(){return new w(this.#z,H.COMPLETED,this.#G)}matchesRomaji(z){return v(z,this.#G)}isPartialMatch(z){return b(z,this.#G)}isPunctuation(){return j(this.#z)}}var f=["きゃ","きゅ","きょ","しゃ","しゅ","しょ","ちゃ","ちゅ","ちょ","にゃ","にゅ","にょ","ひゃ","ひゅ","ひょ","みゃ","みゅ","みょ","りゃ","りゅ","りょ","ぎゃ","ぎゅ","ぎょ","じゃ","じゅ","じょ","びゃ","びゅ","びょ","ぴゃ","ぴゅ","ぴょ","キャ","キュ","キョ","シャ","シュ","ショ","チャ","チュ","チョ","ニャ","ニュ","ニョ","ヒャ","ヒュ","ヒョ","ミャ","ミュ","ミョ","リャ","リュ","リョ","ギャ","ギュ","ギョ","ジャ","ジュ","ジョ","ビャ","ビュ","ビョ","ピャ","ピュ","ピョ","ティ","ディ","ファ","フィ","フェ","フォ","ウィ","ウェ","ウォ","ヴァ","ヴィ","ヴェ","ヴォ"];function d(z,G){if(G>=z.length)return null;if(G+1<z.length){let V=z.slice(G,G+2);if(f.includes(V)||U[V])return V}return z[G]}function l(z){let G=E(z);if(G.length===0)return!1;let V=["a","i","u","e","o"];return G.some((Z)=>!V.includes(Z[0]))}function u(z){let G=[],V=0;while(V<z.length){if(C(z[V])&&V+1<z.length){let Z=d(z,V+1);if(Z&&l(Z)){G.push(z[V]+Z),V+=1+Z.length;continue}}if(V+1<z.length){let Z=z.slice(V,V+2);if(f.includes(Z)||U[Z]){G.push(Z),V+=2;continue}}G.push(z[V]),V+=1}return G}var c=["な","に","ぬ","ね","の","にゃ","にゅ","にょ","あ","い","う","え","お","や","ゆ","よ","ナ","ニ","ヌ","ネ","ノ","ニャ","ニュ","ニョ","ア","イ","ウ","エ","オ","ヤ","ユ","ヨ"];function o(z){return z==="ん"||z==="ン"}function i(z){return c.includes(z)}class F{#z;#G;#V;constructor(z,G,V=0){this.#z=z,this.#G=G,this.#V=V}static fromText(z){let V=u(z).map((Z,$,W)=>{let X=null;if(o(Z))if($===W.length-1)X=["n","nn"];else{let B=W[$+1];if(i(B))X=["nn","n'"]}let Y=new w(Z,H.PENDING,X);return $===0?Y.setCurrent():Y});return new F(z,V,0)}static fromQuestionData(z){let G=z.characters.map((Z,$)=>{let W=new w(Z.kana,H.PENDING,Z.romaji);return $===0?W.setCurrent():W}),V=new F(z.text,G,0);return V._id=z.id,V._displayCharacters=z.characters,V._source=z.source,V._metadata=z.metadata,V}get id(){return this._id}get displayCharacters(){return this._displayCharacters}get source(){return this._source}get metadata(){return this._metadata}get text(){return this.#z}get characters(){return this.#G}get currentIndex(){return this.#V}getCurrentCharacter(){if(this.#V>=this.#G.length)return null;return this.#G[this.#V]}advance(){if(this.isCompleted())return this;let z=this.#G.map((G,V)=>{if(V===this.#V)return G.setCompleted();else if(V===this.#V+1)return G.setCurrent();return G});return new F(this.#z,z,this.#V+1)}isCompleted(){return this.#V>=this.#G.length}getProgress(){if(this.#G.length===0)return 1;return this.#V/this.#G.length}}var _={COMPLETE:"COMPLETE",PARTIAL:"PARTIAL",MISMATCH:"MISMATCH"};class A{#z;constructor(z=""){this.#z=z}get value(){return this.#z}get length(){return this.#z.length}isEmpty(){return this.#z.length===0}add(z){return new A(this.#z+z)}reset(){return new A}tryMatch(z){if(z.matchesRomaji(this.#z))return{type:_.COMPLETE};if(z.isPartialMatch(this.#z))return{type:_.PARTIAL};return{type:_.MISMATCH}}}class O{#z;#G;#V;#$;#Z;#X;constructor(z){this.#z=z,this.#G=new A,this.#V=new Date,this.#$=new Map,this.#Z=0,this.#X=0,this.#Y()}#Y(){let z=[];while(!this.#z.isCompleted()){let G=this.#z.getCurrentCharacter();if(!G||!G.isPunctuation())break;z.push(G),this.#z=this.#z.advance()}return z}get question(){return this.#z}get startTime(){return this.#V}get inputBuffer(){return this.#G}on(z,G){if(!this.#$.has(z))this.#$.set(z,[]);this.#$.get(z).push(G)}#W(z,G){let V=this.#$.get(z);if(V)V.forEach((Z)=>Z(G))}handleKeyPress(z){if(this.#z.isCompleted())return;this.#Z++,this.#W("KeyPressed",{key:z,timestamp:Date.now()});let G=this.#z.getCurrentCharacter();if(!G)return;let V=this.#G.add(z);switch(V.tryMatch(G).type){case _.COMPLETE:this.#F(G,V);break;case _.PARTIAL:this.#J(V);break;case _.MISMATCH:this.#_(G,z);break}}#F(z,G){this.#W("RomajiMatched",{romaji:G.value,isPartial:!1}),this.#z=this.#z.advance(),this.#G=new A,this.#W("CharacterCompleted",{character:z,duration:Date.now()-this.#V.getTime()}),this.#W("SpeechRequested",{text:z.kana});let V=this.#Y();for(let Z of V)this.#W("CharacterCompleted",{character:Z,duration:Date.now()-this.#V.getTime(),skipped:!0});if(this.#z.isCompleted())this.#A()}#J(z){this.#G=z,this.#W("RomajiMatched",{romaji:z.value,isPartial:!0})}#_(z,G){this.#X++,this.#W("CharacterMistaken",{expected:z.romaji,actual:G}),this.#G=new A}#A(){let G=new Date().getTime()-this.#V.getTime(),V=this.#Z-this.#X,Z=this.#Z>0?V/this.#Z:1;this.#W("SessionCompleted",{totalTime:G,accuracy:Z,totalKeystrokes:this.#Z,mistakes:this.#X})}getCurrentCharacter(){return this.#z.getCurrentCharacter()}getHintRomaji(){let z=this.getCurrentCharacter();if(!z||z.romaji.length===0)return"";return z.romaji[0]}getProgress(){return this.#z.getProgress()}}class S{#z;#G;#V;constructor(z={}){this.#z=z.lang||"ja-JP",this.#G=z.rate||1,this.#V=z.speechSynthesis}get lang(){return this.#z}isSupported(){return this.#V!==void 0&&this.#V!==null}speak(z){return new Promise((G,V)=>{if(!this.isSupported()){G();return}let Z=this.#$(z);Z.lang=this.#z,Z.rate=this.#G,Z.onend=()=>G(),Z.onerror=($)=>V($),this.#V.speak(Z)})}cancel(){if(this.isSupported())this.#V.cancel()}#$(z){if(typeof SpeechSynthesisUtterance!=="undefined")return new SpeechSynthesisUtterance(z);return{text:z,lang:"",rate:1,onend:null,onerror:null}}}var g=null;class N{#z;#G;#V;#$;#Z;#X;#Y;constructor(z){let G;if(z.questionData)G=F.fromQuestionData(z.questionData),this.#Z=z.questionData;else G=F.fromText(z.text),this.#Z=null;this.#z=new O(G),this.#G=new S({speechSynthesis:typeof speechSynthesis!=="undefined"?speechSynthesis:void 0}),this.#V=z.elements,this.#$=z.keyboardRenderer,this.#X=z.onNextQuestion||null,this.#W(),this.#F(),this.#J()}#W(){this.#z.on("RomajiMatched",(z)=>{this.#H(z.romaji)}),this.#z.on("CharacterCompleted",(z)=>{this.#J(),this.#N()}),this.#z.on("SpeechRequested",(z)=>{this.#G.speak(z.text)}),this.#z.on("CharacterMistaken",(z)=>{this.#U(),this.#H("")}),this.#z.on("SessionCompleted",(z)=>{this.#Q(z)})}#F(){if(g)document.removeEventListener("keydown",g);this.#Y=(z)=>{if(z.ctrlKey||z.altKey||z.metaKey)return;if(z.key.length!==1)return;z.preventDefault();let G=z.key.toLowerCase();this.#$?.showKeyPress(G),this.#z.handleKeyPress(G)},document.addEventListener("keydown",this.#Y),g=this.#Y}#J(){this.#_(),this.#w(),this.#E()}#_(){let z=this.#V.textContainer;if(!z)return;let G=this.#z.question.characters,V;if(this.#Z)V=this.#Z.characters.map(($,W)=>{let X=G[W];return`<span class="char ${X?`char-${X.state}`:"char-pending"}" data-index="${W}">${$.display}</span>`}).join("");else V=G.map((Z,$)=>{return`<span class="char ${`char-${Z.state}`}" data-index="${$}">${Z.kana}</span>`}).join("");z.innerHTML=V,this.#A()}#A(){let z=this.#V.textContainer;if(!z)return;let G=this.#z.question.currentIndex,V=z.querySelector(`[data-index="${G}"]`);if(V){let Z=z.parentElement?.getBoundingClientRect(),$=V.getBoundingClientRect();if(Z){let W=Z.width/3,X=V.offsetLeft,Y=Math.max(0,X-W);z.style.transform=`translateX(-${Y}px)`}}}#w(){let z=this.#V.romajiContainer;if(!z)return;let G=this.#z.question.characters;z.innerHTML=G.map((V,Z)=>{let $=`romaji-${V.state}`,W=V.romaji[0]||"";return`<span class="romaji ${$}" data-index="${Z}">${W}</span>`}).join(""),this.#L()}#L(){let z=this.#V.romajiContainer;if(!z)return;let G=this.#z.question.currentIndex,V=z.querySelector(`[data-index="${G}"]`);if(V){let Z=z.parentElement?.getBoundingClientRect();if(Z){let $=Z.width/3,W=V.offsetLeft,X=Math.max(0,W-$);z.style.transform=`translateX(-${X}px)`}}}#H(z){let G=this.#V.bufferDisplay;if(G)G.textContent=z}#E(){if(!this.#$)return;let z=this.#z.getHintRomaji(),G=null;if(z){for(let V of z)if(/[a-z]/i.test(V)){G=V.toLowerCase();break}}this.#$.highlightKey(G)}#N(){let z=this.#V.textContainer;if(!z)return;z.classList.add("flash-success"),setTimeout(()=>z.classList.remove("flash-success"),200)}#U(){let z=this.#V.textContainer;if(!z)return;z.classList.add("flash-error"),setTimeout(()=>z.classList.remove("flash-error"),200)}#Q(z){let G=this.#V.resultContainer;if(!G)return;let V=Math.round(z.accuracy*100),Z=(z.totalTime/1000).toFixed(1),$="";if(this.#Z?.source){let X=this.#Z.source;$=`
        <a href="${X.path}" class="source-link" target="_blank">
          查看來源卡片：${X.title} →
        </a>
      `}let W=this.#X?'<button class="next-btn" id="next-question-btn">下一題</button>':"";if(G.innerHTML=`
      <div class="result-box">
        <h2>完成！</h2>
        <div class="result-stats">
          <div class="stat">
            <span class="stat-value">${V}%</span>
            <span class="stat-label">準確率</span>
          </div>
          <div class="stat">
            <span class="stat-value">${Z}s</span>
            <span class="stat-label">時間</span>
          </div>
          <div class="stat">
            <span class="stat-value">${z.totalKeystrokes}</span>
            <span class="stat-label">按鍵數</span>
          </div>
        </div>
        ${$}
        <div class="result-actions">
          ${W}
          <button class="retry-btn" onclick="location.reload()">重新開始</button>
        </div>
      </div>
    `,G.style.display="flex",this.#X){let X=document.getElementById("next-question-btn");if(X)X.addEventListener("click",()=>{this.#X()})}}getProgress(){return this.#z.getProgress()}}class R{#z;#G;constructor(z){this.#z=z,this.#G=null}highlightKey(z){if(this.#G)this.#G.classList.remove("key-target");if(!z){this.#G=null;return}let G=this.#z.querySelector(`[data-key="${z}"]`);if(G)G.classList.add("key-target"),this.#G=G}showKeyPress(z){let G=this.#z.querySelector(`[data-key="${z}"]`);if(!G)return;G.classList.add("key-pressed"),setTimeout(()=>{G.classList.remove("key-pressed")},100)}clearHighlights(){this.#z.querySelectorAll(".key").forEach((G)=>{G.classList.remove("key-target","key-pressed")}),this.#G=null}}class Q{constructor(z){if(!z){let V=window.location.pathname.match(/^(.*?)\/[^\/]+\/?$/);z=`${V?V[1]:""}/data/questions.json`}this.dataUrl=z,this.questionBank=null,this.recentIds=new Set,this.maxRecentHistory=10}async load(){if(this.questionBank)return this.questionBank;try{let z=await fetch(this.dataUrl);if(!z.ok)throw new Error(`載入題庫失敗: ${z.status} ${z.statusText}`);return this.questionBank=await z.json(),console.log(`題庫載入完成: ${this.questionBank.questions.length} 題`),this.questionBank}catch(z){throw console.error("題庫載入錯誤:",z),z}}isLoaded(){return this.questionBank!==null}getAllQuestions(){return this.questionBank?.questions||[]}filterQuestions(z={}){let G=this.getAllQuestions();if(z.jlpt&&z.jlpt!=="all")G=G.filter((V)=>V.source.jlpt===z.jlpt);if(z.category&&z.category!=="all")G=G.filter((V)=>V.source.category===z.category);if(z.difficulty&&z.difficulty!=="all")G=G.filter((V)=>V.metadata.difficulty===z.difficulty);return G}getRandomQuestion(z={}){let G=this.filterQuestions(z);if(G.length===0)return null;let V=G.filter((W)=>!this.recentIds.has(W.id));if(V.length===0)this.recentIds.clear(),V=G;let Z=Math.floor(Math.random()*V.length),$=V[Z];if(this.recentIds.add($.id),this.recentIds.size>this.maxRecentHistory){let W=this.recentIds.values().next().value;this.recentIds.delete(W)}return $}getQuestionById(z){return this.getAllQuestions().find((G)=>G.id===z)||null}getStats(){return this.questionBank?.stats||null}getJlptLevels(){let z=this.getStats();if(!z?.byJlpt)return["n5","n4","n3","n2","n1"];return Object.keys(z.byJlpt).sort()}getCategories(){let z=this.getStats();if(!z?.byCategory)return[];return Object.keys(z.byCategory).sort()}resetHistory(){this.recentIds.clear()}}var Hz=new Q;var k=["あいうえお","かきくけこ","さしすせそ","たちつてと","なにぬねの","はひふへほ","まみむめも","やゆよ","らりるれろ","わをん","がぎぐげご","ざじずぜぞ","だぢづでど","ばびぶべぼ","ぱぴぷぺぽ","きゃきゅきょ","しゃしゅしょ","ちゃちゅちょ","こんにちは","ありがとう","おはよう","さようなら","いただきます","ごちそうさま"],L=null,I=null,D=null,J={},T={jlpt:"all"};function s(){let z=Math.floor(Math.random()*k.length);return k[z]}function n(){let z=J.textContainer;if(z)z.innerHTML='<span class="loading">載入題庫中...</span>'}function p(z){let G=J.textContainer;if(G)G.innerHTML=`
      <div class="error-message">
        <p>${z}</p>
        <button onclick="location.reload()">重新載入</button>
      </div>
    `}function r(){let z=document.querySelector(".practice-container");if(!z)return;if(document.getElementById("practice-controls"))return;let G=document.createElement("div");G.id="practice-controls",G.className="practice-controls",G.innerHTML=`
    <div class="control-group">
      <label for="jlpt-filter">JLPT 等級：</label>
      <select id="jlpt-filter">
        <option value="all">全部</option>
        <option value="n5">N5</option>
        <option value="n4">N4</option>
        <option value="n3">N3</option>
        <option value="n2">N2</option>
        <option value="n1">N1</option>
      </select>
    </div>
    <div class="control-group">
      <button id="btn-next" class="control-btn">下一題</button>
      <button id="btn-kana-mode" class="control-btn secondary">假名模式</button>
    </div>
  `;let V=z.querySelector(".practice-area")||z.firstChild;z.insertBefore(G,V);let Z=document.getElementById("jlpt-filter");if(Z){let X=localStorage.getItem("practice-jlpt-filter");if(X)Z.value=X,T.jlpt=X;Z.addEventListener("change",(Y)=>{T.jlpt=Y.target.value,localStorage.setItem("practice-jlpt-filter",Y.target.value),M()})}let $=document.getElementById("btn-next");if($)$.addEventListener("click",M);let W=document.getElementById("btn-kana-mode");if(W)W.addEventListener("click",()=>{K()})}async function M(){if(!L||!L.isLoaded()){console.error("題庫尚未載入");return}if(J.resultContainer)J.resultContainer.style.display="none";let z=L.getRandomQuestion(T);if(!z){p("找不到符合條件的題目");return}I=new N({questionData:z,elements:J,keyboardRenderer:D,onNextQuestion:M}),console.log("載入題目:",z.id,z.text.substring(0,30)+"...")}function K(){if(J.resultContainer)J.resultContainer.style.display="none";let z=s();I=new N({text:z,elements:J,keyboardRenderer:D,onNextQuestion:K}),console.log("假名模式:",z)}async function x(){let z=document.getElementById("practice-text"),G=document.getElementById("practice-romaji"),V=document.getElementById("keyboard");if(!z||!G||!V){console.error("找不到必要的 DOM 元素");return}let Z=document.getElementById("result-container");if(!Z)Z=document.createElement("div"),Z.id="result-container",Z.className="result-container",Z.style.display="none",document.querySelector(".practice-container")?.appendChild(Z);let $=document.getElementById("buffer-display");if(!$)$=document.createElement("div"),$.id="buffer-display",$.className="buffer-display",G.parentNode?.insertBefore($,G.nextSibling);J={textContainer:z,romajiContainer:G,resultContainer:Z,bufferDisplay:$},D=new R(V),r();let W=new URLSearchParams(window.location.search),X=W.get("text"),Y=W.get("mode");if(X){I=new N({text:X,elements:J,keyboardRenderer:D}),console.log("URL 模式:",X);return}if(Y==="kana"){K();return}n();try{L=new Q,await L.load(),console.log("題庫載入完成:",L.getStats()),M()}catch(B){console.error("題庫載入失敗:",B),p("題庫載入失敗，切換到假名模式"),setTimeout(()=>{K()},2000)}}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",x);else x();
