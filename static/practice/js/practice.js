(()=>{var{defineProperty:v,getOwnPropertyNames:Nz,getOwnPropertyDescriptor:Lz}=Object,Qz=Object.prototype.hasOwnProperty;var s=new WeakMap,wz=(z)=>{var Z=s.get(z),$;if(Z)return Z;if(Z=v({},"__esModule",{value:!0}),z&&typeof z==="object"||typeof z==="function")Nz(z).map((V)=>!Qz.call(Z,V)&&v(Z,V,{get:()=>z[V],enumerable:!($=Lz(z,V))||$.enumerable}));return s.set(z,Z),Z};var S=(z,Z)=>{for(var $ in Z)v(z,$,{get:Z[$],enumerable:!0,configurable:!0,set:(V)=>Z[$]=()=>V})};var A=(z,Z)=>()=>(z&&(Z=z(z=0)),Z);class w{#z;constructor(z=""){this.#z=z}get value(){return this.#z}get length(){return this.#z.length}isEmpty(){return this.#z.length===0}add(z){return new w(this.#z+z)}reset(){return new w}tryMatch(z){if(z.matchesRomaji(this.#z))return{type:Q.COMPLETE};if(z.isPartialMatch(this.#z))return{type:Q.PARTIAL};return{type:Q.MISMATCH}}}var Q;var n=A(()=>{Q={COMPLETE:"COMPLETE",PARTIAL:"PARTIAL",MISMATCH:"MISMATCH"}});var t={};S(t,{TypingSession:()=>E});class E{#z;#Z;#$;#V;#J;#X;constructor(z){this.#z=z,this.#Z=new w,this.#$=new Date,this.#V=new Map,this.#J=0,this.#X=0,this.#F()}#F(){let z=[];while(!this.#z.isCompleted()){let Z=this.#z.getCurrentCharacter();if(!Z||!Z.isPunctuation())break;z.push(Z),this.#z=this.#z.advance()}return z}get question(){return this.#z}get startTime(){return this.#$}get inputBuffer(){return this.#Z}on(z,Z){if(!this.#V.has(z))this.#V.set(z,[]);this.#V.get(z).push(Z)}#W(z,Z){let $=this.#V.get(z);if($)$.forEach((V)=>V(Z))}handleKeyPress(z){if(this.#z.isCompleted())return;this.#J++,this.#W("KeyPressed",{key:z,timestamp:Date.now()});let Z=this.#z.getCurrentCharacter();if(!Z)return;let $=this.#Z.add(z);switch($.tryMatch(Z).type){case Q.COMPLETE:this.#Y(Z,$);break;case Q.PARTIAL:this.#G($);break;case Q.MISMATCH:this.#N(Z,z);break}}#Y(z,Z){this.#W("RomajiMatched",{romaji:Z.value,isPartial:!1}),this.#z=this.#z.advance(),this.#Z=new w,this.#W("CharacterCompleted",{character:z,duration:Date.now()-this.#$.getTime()}),this.#W("SpeechRequested",{text:z.kana});let $=this.#F();for(let V of $)this.#W("CharacterCompleted",{character:V,duration:Date.now()-this.#$.getTime(),skipped:!0});if(this.#z.isCompleted())this.#_()}#G(z){this.#Z=z,this.#W("RomajiMatched",{romaji:z.value,isPartial:!0})}#N(z,Z){this.#X++,this.#W("CharacterMistaken",{expected:z.romaji,actual:Z}),this.#Z=new w}#_(){let Z=new Date().getTime()-this.#$.getTime(),$=this.#J-this.#X,V=this.#J>0?$/this.#J:1;this.#W("SessionCompleted",{totalTime:Z,accuracy:V,totalKeystrokes:this.#J,mistakes:this.#X})}getCurrentCharacter(){return this.#z.getCurrentCharacter()}getHintRomaji(){let z=this.getCurrentCharacter();if(!z||z.romaji.length===0)return"";return z.romaji[0]}getProgress(){return this.#z.getProgress()}handleDirectInput(z){if(!z||this.#z.isCompleted())return{matchedCount:0,consumedLength:0};let Z=0,$=0;while($<z.length&&!this.#z.isCompleted()){let V=this.#z.getCurrentCharacter();if(!V)break;let{kana:W,display:J}=V,X=z.substring($),F=!1,_=0;if(X.startsWith(J))F=!0,_=J.length;else if(X.startsWith(W))F=!0,_=W.length;if(F){this.#J++,this.#z=this.#z.advance(),this.#W("CharacterCompleted",{character:V,duration:Date.now()-this.#$.getTime()}),this.#W("SpeechRequested",{text:V.kana});let Yz=this.#F();for(let _z of Yz)this.#W("CharacterCompleted",{character:_z,duration:Date.now()-this.#$.getTime(),skipped:!0});Z++,$+=_}else break}if(this.#z.isCompleted())this.#_();return{matchedCount:Z,consumedLength:$}}}var j=A(()=>{n()});function H(z){return R[z]||[]}function e(z,Z){return Z.some(($)=>$.startsWith(z))}function zz(z,Z){return Z.includes(z)}function $z(z){return Uz.includes(z)}function Vz(z){return Zz.includes(z)}function Bz(z){if(z.startsWith("ch"))return"c";if(z.startsWith("sh"))return"s";if(z.startsWith("ts"))return"t";if(z.startsWith("th"))return"t";if(z.startsWith("dh"))return"d";let Z=z[0];return["a","i","u","e","o"].includes(Z)?null:Z}function b(z){return z.length>=2&&Zz.includes(z[0])}function Wz(z){if(!b(z))return[];let Z=z.slice(1),$=H(Z);if($.length===0)return[];let V=[];for(let J of $){let X=Bz(J);if(X)V.push(X+J)}let W=["xtu","ltu"];for(let J of W)for(let X of $)V.push(J+X);return V}var R,Zz,Uz;var f=A(()=>{R={"あ":["a"],"い":["i"],"う":["u"],"え":["e"],"お":["o"],"ア":["a"],"イ":["i"],"ウ":["u"],"エ":["e"],"オ":["o"],"か":["ka"],"き":["ki"],"く":["ku"],"け":["ke"],"こ":["ko"],"カ":["ka"],"キ":["ki"],"ク":["ku"],"ケ":["ke"],"コ":["ko"],"さ":["sa"],"し":["si","shi"],"す":["su"],"せ":["se"],"そ":["so"],"サ":["sa"],"シ":["si","shi"],"ス":["su"],"セ":["se"],"ソ":["so"],"た":["ta"],"ち":["ti","chi"],"つ":["tu","tsu"],"て":["te"],"と":["to"],"タ":["ta"],"チ":["ti","chi"],"ツ":["tu","tsu"],"テ":["te"],"ト":["to"],"な":["na"],"に":["ni"],"ぬ":["nu"],"ね":["ne"],"の":["no"],"ナ":["na"],"ニ":["ni"],"ヌ":["nu"],"ネ":["ne"],"ノ":["no"],"は":["ha"],"ひ":["hi"],"ふ":["hu","fu"],"へ":["he"],"ほ":["ho"],"ハ":["ha"],"ヒ":["hi"],"フ":["hu","fu"],"ヘ":["he"],"ホ":["ho"],"ま":["ma"],"み":["mi"],"む":["mu"],"め":["me"],"も":["mo"],"マ":["ma"],"ミ":["mi"],"ム":["mu"],"メ":["me"],"モ":["mo"],"や":["ya"],"ゆ":["yu"],"よ":["yo"],"ヤ":["ya"],"ユ":["yu"],"ヨ":["yo"],"ら":["ra"],"り":["ri"],"る":["ru"],"れ":["re"],"ろ":["ro"],"ラ":["ra"],"リ":["ri"],"ル":["ru"],"レ":["re"],"ロ":["ro"],"わ":["wa"],"を":["wo"],"ん":["nn","n"],"ワ":["wa"],"ヲ":["wo"],"ン":["nn","n"],"が":["ga"],"ぎ":["gi"],"ぐ":["gu"],"げ":["ge"],"ご":["go"],"ガ":["ga"],"ギ":["gi"],"グ":["gu"],"ゲ":["ge"],"ゴ":["go"],"ざ":["za"],"じ":["zi","ji"],"ず":["zu"],"ぜ":["ze"],"ぞ":["zo"],"ザ":["za"],"ジ":["zi","ji"],"ズ":["zu"],"ゼ":["ze"],"ゾ":["zo"],"だ":["da"],"ぢ":["di"],"づ":["du","dzu"],"で":["de"],"ど":["do"],"ダ":["da"],"ヂ":["di"],"ヅ":["du","dzu"],"デ":["de"],"ド":["do"],"ば":["ba"],"び":["bi"],"ぶ":["bu"],"べ":["be"],"ぼ":["bo"],"バ":["ba"],"ビ":["bi"],"ブ":["bu"],"ベ":["be"],"ボ":["bo"],"ぱ":["pa"],"ぴ":["pi"],"ぷ":["pu"],"ぺ":["pe"],"ぽ":["po"],"パ":["pa"],"ピ":["pi"],"プ":["pu"],"ペ":["pe"],"ポ":["po"],"きゃ":["kya"],"きゅ":["kyu"],"きょ":["kyo"],"しゃ":["sya","sha"],"しゅ":["syu","shu"],"しょ":["syo","sho"],"ちゃ":["tya","cha"],"ちゅ":["tyu","chu"],"ちょ":["tyo","cho"],"にゃ":["nya"],"にゅ":["nyu"],"にょ":["nyo"],"ひゃ":["hya"],"ひゅ":["hyu"],"ひょ":["hyo"],"みゃ":["mya"],"みゅ":["myu"],"みょ":["myo"],"りゃ":["rya"],"りゅ":["ryu"],"りょ":["ryo"],"ぎゃ":["gya"],"ぎゅ":["gyu"],"ぎょ":["gyo"],"じゃ":["zya","ja","jya"],"じゅ":["zyu","ju","jyu"],"じょ":["zyo","jo","jyo"],"びゃ":["bya"],"びゅ":["byu"],"びょ":["byo"],"ぴゃ":["pya"],"ぴゅ":["pyu"],"ぴょ":["pyo"],"っ":["xtu","ltu","xtsu","ltsu"],"ッ":["xtu","ltu","xtsu","ltsu"],"ぁ":["xa","la"],"ぃ":["xi","li"],"ぅ":["xu","lu"],"ぇ":["xe","le"],"ぉ":["xo","lo"],"ゃ":["xya","lya"],"ゅ":["xyu","lyu"],"ょ":["xyo","lyo"],"、":[","],"。":["."],"？":["?"],"！":["!"],"「":["["],"」":["]"],"ー":["-"],"〜":["~"],"ティ":["thi","texi","teli"],"ディ":["dhi","dexi","deli"],"ファ":["fa","huxa","hula"],"フィ":["fi","huxi","huli"],"フェ":["fe","huxe","hule"],"フォ":["fo","huxo","hulo"],"ウィ":["wi","uxi","uli"],"ウェ":["we","uxe","ule"],"ウォ":["wo","uxo","ulo"],"ヴァ":["va","vuxa"],"ヴィ":["vi","vuxi"],"ヴ":["vu"],"ヴェ":["ve","vuxe"],"ヴォ":["vo","vuxo"],"ゐ":["wi"],"ヰ":["wi"],"ゑ":["we"],"ヱ":["we"]};Zz=["っ","ッ"],Uz=["、","。","？","！","「","」","（","）","(",")","ー","〜","～","*"]});class O{#z;#Z;#$;#V;constructor(z,Z=D.PENDING,$=null,V=null){if(this.#z=z,this.#V=V||z,$)this.#Z=$;else if(b(z))this.#Z=Wz(z);else this.#Z=H(z);this.#$=Z}get kana(){return this.#z}get romaji(){return this.#Z}get state(){return this.#$}get display(){return this.#V}setCurrent(){return new O(this.#z,D.CURRENT,this.#Z,this.#V)}setCompleted(){return new O(this.#z,D.COMPLETED,this.#Z,this.#V)}matchesRomaji(z){return zz(z,this.#Z)}isPartialMatch(z){return e(z,this.#Z)}isPunctuation(){return $z(this.#z)}matchesKana(z){return this.#z===z}matchesDisplay(z){return this.#V===z}}var D;var Jz=A(()=>{f();D={PENDING:"pending",CURRENT:"current",COMPLETED:"completed"}});var Fz={};S(Fz,{Question:()=>N});function Dz(z,Z){if(Z>=z.length)return null;if(Z+1<z.length){let $=z.slice(Z,Z+2);if(Xz.includes($)||R[$])return $}return z[Z]}function Oz(z){let Z=H(z);if(Z.length===0)return!1;let $=["a","i","u","e","o"];return Z.some((V)=>!$.includes(V[0]))}function Pz(z){let Z=[],$=0;while($<z.length){if(Vz(z[$])&&$+1<z.length){let V=Dz(z,$+1);if(V&&Oz(V)){Z.push(z[$]+V),$+=1+V.length;continue}}if($+1<z.length){let V=z.slice($,$+2);if(Xz.includes(V)||R[V]){Z.push(V),$+=2;continue}}Z.push(z[$]),$+=1}return Z}function Hz(z){return z==="ん"||z==="ン"}function Kz(z){return Az.includes(z)}class N{#z;#Z;#$;constructor(z,Z,$=0){this.#z=z,this.#Z=Z,this.#$=$}static fromText(z){let $=Pz(z).map((V,W,J)=>{let X=null;if(Hz(V))if(W===J.length-1)X=["n","nn"];else{let _=J[W+1];if(Kz(_))X=["nn","n'"]}let F=new O(V,D.PENDING,X);return W===0?F.setCurrent():F});return new N(z,$,0)}static fromQuestionData(z){let Z=z.characters.map((V,W)=>{let J=new O(V.kana,D.PENDING,V.romaji,V.display);return W===0?J.setCurrent():J}),$=new N(z.text,Z,0);return $._id=z.id,$._displayCharacters=z.characters,$._source=z.source,$._metadata=z.metadata,$}get id(){return this._id}get displayCharacters(){return this._displayCharacters}get source(){return this._source}get metadata(){return this._metadata}get text(){return this.#z}get characters(){return this.#Z}get currentIndex(){return this.#$}getCurrentCharacter(){if(this.#$>=this.#Z.length)return null;return this.#Z[this.#$]}advance(){if(this.isCompleted())return this;let z=this.#Z.map((Z,$)=>{if($===this.#$)return Z.setCompleted();else if($===this.#$+1)return Z.setCurrent();return Z});return new N(this.#z,z,this.#$+1)}isCompleted(){return this.#$>=this.#Z.length}getProgress(){if(this.#Z.length===0)return 1;return this.#$/this.#Z.length}}var Xz,Az;var M=A(()=>{Jz();f();Xz=["きゃ","きゅ","きょ","しゃ","しゅ","しょ","ちゃ","ちゅ","ちょ","にゃ","にゅ","にょ","ひゃ","ひゅ","ひょ","みゃ","みゅ","みょ","りゃ","りゅ","りょ","ぎゃ","ぎゅ","ぎょ","じゃ","じゅ","じょ","びゃ","びゅ","びょ","ぴゃ","ぴゅ","ぴょ","キャ","キュ","キョ","シャ","シュ","ショ","チャ","チュ","チョ","ニャ","ニュ","ニョ","ヒャ","ヒュ","ヒョ","ミャ","ミュ","ミョ","リャ","リュ","リョ","ギャ","ギュ","ギョ","ジャ","ジュ","ジョ","ビャ","ビュ","ビョ","ピャ","ピュ","ピョ","ティ","ディ","ファ","フィ","フェ","フォ","ウィ","ウェ","ウォ","ヴァ","ヴィ","ヴェ","ヴォ"];Az=["な","に","ぬ","ね","の","にゃ","にゅ","にょ","あ","い","う","え","お","や","ゆ","よ","ナ","ニ","ヌ","ネ","ノ","ニャ","ニュ","ニョ","ア","イ","ウ","エ","オ","ヤ","ユ","ヨ"]});var vz={};S(vz,{init:()=>o,app:()=>K});class q{#z;#Z;#$;constructor(z,Z){this.#z=Z,this.#Z=new Set,this.#$=z}getState(){return this.#z}dispatch(z){if(!z||typeof z.type!=="string")throw Error("Action must have a type property");let Z=this.#z;if(this.#z=this.#$(this.#z,z),Z!==this.#z)this.#V(z)}subscribe(z){if(typeof z!=="function")throw Error("Listener must be a function");return this.#Z.add(z),()=>{this.#Z.delete(z)}}#V(z){this.#Z.forEach((Z)=>{try{Z(this.#z,z)}catch($){console.error("Store listener error:",$)}})}getListenerCount(){return this.#Z.size}}var G={SET_PRACTICE_MODE:"SET_PRACTICE_MODE",SET_INPUT_MODE:"SET_INPUT_MODE",TOGGLE_ROMAJI_HINT:"TOGGLE_ROMAJI_HINT",TOGGLE_KEYBOARD:"TOGGLE_KEYBOARD",SET_FILTER:"SET_FILTER",START_LOADING:"START_LOADING",LOAD_QUESTION_SUCCESS:"LOAD_QUESTION_SUCCESS",LOAD_QUESTION_FAILURE:"LOAD_QUESTION_FAILURE",COMPLETE_SESSION:"COMPLETE_SESSION",RESET_SESSION:"RESET_SESSION"},Y={setPracticeMode:(z)=>({type:G.SET_PRACTICE_MODE,payload:z}),setInputMode:(z)=>({type:G.SET_INPUT_MODE,payload:z}),toggleRomajiHint:()=>({type:G.TOGGLE_ROMAJI_HINT}),toggleKeyboard:()=>({type:G.TOGGLE_KEYBOARD}),setFilter:(z,Z)=>({type:G.SET_FILTER,payload:{key:z,value:Z}}),startLoading:()=>({type:G.START_LOADING}),loadQuestionSuccess:(z)=>({type:G.LOAD_QUESTION_SUCCESS,payload:z}),loadQuestionFailure:(z)=>({type:G.LOAD_QUESTION_FAILURE,payload:z}),completeSession:(z)=>({type:G.COMPLETE_SESSION,payload:z}),resetSession:()=>({type:G.RESET_SESSION})};function r(z,Z){switch(Z.type){case G.SET_PRACTICE_MODE:return{...z,practiceMode:Z.payload};case G.SET_INPUT_MODE:return{...z,inputMode:Z.payload};case G.TOGGLE_ROMAJI_HINT:return{...z,uiSettings:{...z.uiSettings,showRomajiHint:!z.uiSettings.showRomajiHint}};case G.TOGGLE_KEYBOARD:return{...z,uiSettings:{...z.uiSettings,showKeyboard:!z.uiSettings.showKeyboard}};case G.SET_FILTER:return{...z,filters:{...z.filters,[Z.payload.key]:Z.payload.value}};case G.START_LOADING:return{...z,status:"loading",error:null};case G.LOAD_QUESTION_SUCCESS:return{...z,status:"practicing",currentQuestion:Z.payload,error:null};case G.LOAD_QUESTION_FAILURE:return{...z,status:"error",error:Z.payload};case G.COMPLETE_SESSION:return{...z,status:"completed",result:Z.payload};case G.RESET_SESSION:return{...z,status:"idle",currentQuestion:null,result:null,error:null};default:return z}}var a={practiceMode:"question",inputMode:"romaji",uiSettings:{showRomajiHint:!0,showKeyboard:!0},filters:{jlpt:"all"},status:"idle",currentQuestion:null,result:null,error:null};j();class B{static get id(){throw Error("Must implement static id getter")}static get displayName(){throw Error("Must implement static displayName getter")}static get description(){return""}static get requiresQuestionLoader(){return!1}static get supportedInputModes(){return["romaji","direct"]}constructor(z){if(new.target===B)throw Error("PracticeMode is abstract and cannot be instantiated directly");this.store=z.store,this.questionLoader=z.questionLoader,this.speechService=z.speechService,this.session=null}async initialize(){throw Error("Must implement initialize()")}async loadNextQuestion(){throw Error("Must implement loadNextQuestion()")}createSession(z){return this.session=new E(z),this.session}setupSessionListeners(z){z.on("SpeechRequested",(Z)=>{this.speechService?.speak(Z.text)}),z.on("SessionCompleted",(Z)=>{this.onSessionCompleted(Z)}),z.on("CharacterMistaken",(Z)=>{this.onCharacterMistaken(Z)})}onCharacterCompleted(z){}onSessionCompleted(z){this.store.dispatch(Y.completeSession(z))}onCharacterMistaken(z){}dispose(){this.session=null}getUIConfig(){return{showFilters:!1,showSourceLink:!1}}}M();class g extends B{static get id(){return"question"}static get displayName(){return"題庫模式"}static get description(){return"從卡片庫中隨機選取例句練習"}static get requiresQuestionLoader(){return!0}async initialize(){if(!this.questionLoader)throw Error("QuestionMode requires a QuestionLoader");if(!this.questionLoader.isLoaded())this.store.dispatch(Y.startLoading()),await this.questionLoader.load()}async loadNextQuestion(){let Z=this.store.getState().filters,$=this.questionLoader.getRandomQuestion(Z);if(!$)throw Error("找不到符合條件的題目");return this.store.dispatch(Y.loadQuestionSuccess($)),N.fromQuestionData($)}getUIConfig(){return{showFilters:!0,showSourceLink:!0}}}M();var C=["あいうえお","かきくけこ","さしすせそ","たちつてと","なにぬねの","はひふへほ","まみむめも","やゆよ","らりるれろ","わをん","がぎぐげご","ざじずぜぞ","だぢづでど","ばびぶべぼ","ぱぴぷぺぽ","きゃきゅきょ","しゃしゅしょ","ちゃちゅちょ","こんにちは","ありがとう","おはよう","さようなら","いただきます","ごちそうさま"];class I extends B{static get id(){return"kana"}static get displayName(){return"假名模式"}static get description(){return"練習基礎假名輸入"}static get requiresQuestionLoader(){return!1}async initialize(){}async loadNextQuestion(){let z=this.#z();return this.store.dispatch(Y.loadQuestionSuccess({text:z})),N.fromText(z)}#z(){let z=Math.floor(Math.random()*C.length);return C[z]}getUIConfig(){return{showFilters:!1,showSourceLink:!1}}static getPracticeTexts(){return[...C]}}class Gz{#z=new Map;#Z=null;#$=null;constructor(){this.register(g),this.register(I)}register(z){if(!z.id)throw Error("Mode class must have a static id property");this.#z.set(z.id,z)}unregister(z){this.#z.delete(z)}setDependencies(z){this.#$=z}getAvailableModes(){return Array.from(this.#z.values()).map((z)=>({id:z.id,displayName:z.displayName,description:z.description}))}hasMode(z){return this.#z.has(z)}getModeClass(z){return this.#z.get(z)}async switchMode(z){if(!this.#$)throw Error("Dependencies not set. Call setDependencies() first.");if(this.#Z)this.#Z.dispose(),this.#Z=null;let Z=this.#z.get(z);if(!Z)throw Error(`Unknown mode: ${z}`);return this.#Z=new Z(this.#$),await this.#Z.initialize(),this.#Z}getCurrentMode(){return this.#Z}getCurrentModeId(){if(!this.#Z)return null;return this.#Z.constructor.id}reset(){if(this.#Z)this.#Z.dispose(),this.#Z=null;this.#$=null}}var U=new Gz;class P{#z=null;#Z=null;constructor(){if(new.target===P)throw Error("InputHandler is abstract and cannot be instantiated directly");this.isActive=!1}setSession(z){this.#z=z}get session(){return this.#z}setUpdateCallback(z){this.#Z=z}triggerUpdate(){if(this.#Z)this.#Z()}activate(){this.isActive=!0}deactivate(){this.isActive=!1}dispose(){this.deactivate(),this.#z=null,this.#Z=null}updateHighlight(){}}class k extends P{#z;#Z=null;constructor(z=null){super();this.#z=z}activate(){if(this.deactivate(),super.activate(),typeof document>"u")return;this.#Z=this.#$.bind(this),document.addEventListener("keydown",this.#Z)}deactivate(){if(super.deactivate(),this.#Z&&typeof document<"u")document.removeEventListener("keydown",this.#Z),this.#Z=null}#$(z){if(!this.isActive||!this.session)return;if(z.ctrlKey||z.altKey||z.metaKey)return;if(z.key.length!==1)return;z.preventDefault();let Z=z.key.toLowerCase();this.#z?.showKeyPress(Z),this.session.handleKeyPress(Z),this.triggerUpdate()}updateHighlight(){if(!this.session||!this.#z)return;let z=this.session.getHintRomaji(),Z=null;if(z){for(let $ of z)if(/[a-z]/i.test($)){Z=$.toLowerCase();break}}this.#z.highlightKey(Z)}dispose(){this.deactivate(),this.#z?.highlightKey(null),super.dispose()}setKeyboardRenderer(z){this.#z=z}}class x extends P{#z;#Z=null;#$=null;constructor(z=null){super();this.#z=z}setInputElement(z){this.#z=z}activate(){if(this.deactivate(),super.activate(),!this.#z){console.warn("DirectInputHandler: Input element not set");return}this.#Z=this.#V.bind(this),this.#$=this.#V.bind(this),this.#z.addEventListener("input",this.#Z),this.#z.addEventListener("compositionend",this.#$),this.#z.value="",setTimeout(()=>{this.#z?.focus()},100)}deactivate(){if(super.deactivate(),this.#z){if(this.#Z)this.#z.removeEventListener("input",this.#Z);if(this.#$)this.#z.removeEventListener("compositionend",this.#$)}this.#Z=null,this.#$=null}#V(z){if(!this.isActive||!this.session||!this.#z)return;let Z=this.#z.value;if(!Z)return;let $=this.session.handleDirectInput(Z);if($.matchedCount>0)this.#z.value=Z.substring($.consumedLength),this.triggerUpdate()}dispose(){if(this.deactivate(),this.#z)this.#z.value="";super.dispose()}focus(){this.#z?.focus()}getInputElement(){return this.#z}}class y{#z;#Z;constructor(z={}){this.#z=z.keyboardRenderer||null,this.#Z=z.mobileInputElement||null}setKeyboardRenderer(z){this.#z=z}setMobileInputElement(z){this.#Z=z}create(z){switch(z){case"romaji":return new k(this.#z);case"direct":return new x(this.#Z);default:throw Error(`Unknown input mode: ${z}`)}}static getSupportedModes(){return["romaji","direct"]}}class h{#z;constructor(z){this.#z=z}render(z,Z=null){if(!this.#z||!z)return;let $=z.characters,V;if(Z?.characters)V=Z.characters.map((W,J)=>{let X=$[J];return`<span class="char ${X?`char-${X.state}`:"char-pending"}" data-index="${J}">${W.display}</span>`}).join("");else V=$.map((W,J)=>{return`<span class="char ${`char-${W.state}`}" data-index="${J}">${W.kana}</span>`}).join("");this.#z.innerHTML=V,this.#Z(z.currentIndex)}#Z(z){let Z=this.#z?.querySelector(`[data-index="${z}"]`);if(!Z)return;let $=this.#z.parentElement?.getBoundingClientRect();if(!$)return;let V=$.width/3,W=Z.offsetLeft,J=Math.max(0,W-V);this.#z.style.transform=`translateX(-${J}px)`}clear(){if(this.#z)this.#z.innerHTML="",this.#z.style.transform=""}getContainer(){return this.#z}}class m{#z;constructor(z){this.#z=z}render(z){if(!this.#z||!z)return;let $=z.characters.map((V,W)=>{let J=`romaji-${V.state}`,X=V.romaji[0]||"";return`<span class="romaji ${J}" data-index="${W}">${X}</span>`}).join("");this.#z.innerHTML=$,this.#Z(z.currentIndex)}#Z(z){let Z=this.#z?.querySelector(`[data-index="${z}"]`);if(!Z)return;let $=this.#z.parentElement?.getBoundingClientRect();if(!$)return;let V=$.width/3,W=Z.offsetLeft,J=Math.max(0,W-V);this.#z.style.transform=`translateX(-${J}px)`}clear(){if(this.#z)this.#z.innerHTML="",this.#z.style.transform=""}getContainer(){return this.#z}}class p{#z;#Z;#$=null;constructor(z,Z=""){this.#z=z,this.#Z=Z}setNextQuestionCallback(z){this.#$=z}render(z,Z=null){if(!this.#z)return;let $=Math.round(z.accuracy*100),V=(z.totalTime/1000).toFixed(1),W="";if(Z?.source)W=`
        <a href="${this.#Z+Z.source.path}" class="source-link" target="_blank">
          查看來源卡片：${Z.source.title} →
        </a>
      `;let J=this.#$?'<button class="next-btn" id="next-question-btn">下一題</button>':"";this.#z.innerHTML=`
      <div class="result-box">
        <h2>完成！</h2>
        <div class="result-stats">
          <div class="stat">
            <span class="stat-value">${$}%</span>
            <span class="stat-label">準確率</span>
          </div>
          <div class="stat">
            <span class="stat-value">${V}s</span>
            <span class="stat-label">時間</span>
          </div>
          <div class="stat">
            <span class="stat-value">${z.totalKeystrokes}</span>
            <span class="stat-label">按鍵數</span>
          </div>
        </div>
        ${W}
        <div class="result-actions">
          ${J}
          <button class="retry-btn" onclick="location.reload()">重新開始</button>
        </div>
      </div>
    `,this.#z.style.display="flex",this.#V()}#V(){if(!this.#$)return;let z=this.#z?.querySelector("#next-question-btn");if(z)z.addEventListener("click",()=>this.#$())}hide(){if(this.#z)this.#z.style.display="none"}dispose(){this.#$=null}getContainer(){return this.#z}}class l{#z;#Z;#$;#V;constructor(z,Z={}){this.#z=z,this.#Z=Z.successClass||"flash-success",this.#$=Z.errorClass||"flash-error",this.#V=Z.duration||200}flashSuccess(){this.#J(this.#Z)}flashError(){this.#J(this.#$)}#J(z){if(!this.#z)return;this.#z.classList.add(z),setTimeout(()=>{this.#z?.classList.remove(z)},this.#V)}setContainer(z){this.#z=z}getContainer(){return this.#z}}class d{#z;#Z;constructor(z){this.#z=z,this.#Z=null}highlightKey(z){if(this.#Z)this.#Z.classList.remove("key-target");if(!z){this.#Z=null;return}let Z=this.#z.querySelector(`[data-key="${z}"]`);if(Z)Z.classList.add("key-target"),this.#Z=Z}showKeyPress(z){let Z=this.#z.querySelector(`[data-key="${z}"]`);if(!Z)return;Z.classList.add("key-pressed"),setTimeout(()=>{Z.classList.remove("key-pressed")},100)}clearHighlights(){this.#z.querySelectorAll(".key").forEach((Z)=>{Z.classList.remove("key-target","key-pressed")}),this.#Z=null}}class T{constructor(z){if(!z){let $=window.location.pathname.match(/^(.*?)\/[^\/]+\/?$/);z=`${$?$[1]:""}/data/questions.json`}this.dataUrl=z,this.basePath=this.dataUrl.replace(/\/[^\/]+$/,""),this.questionBank=null,this.index=null,this.loadedBundles=new Set,this.loadingPromises=new Map,this.recentIds=new Set,this.maxRecentHistory=10,this.useProgressiveLoading=!1}async loadIndex(){if(this.index)return this.index;let z=`${this.basePath}/questions-index.json`;try{let Z=await fetch(z);if(!Z.ok)return null;return this.index=await Z.json(),console.log(`索引檔載入完成: ${Object.keys(this.index.bundles).length} 個分包`),this.index}catch(Z){return console.log("索引檔不存在，使用傳統載入模式"),null}}async loadInitial(){let z=await this.loadIndex();if(z)return this.useProgressiveLoading=!0,this.questionBank={version:z.version,generated:z.generated,questions:[],stats:z.stats},await this.loadBundle("init"),console.log(`初始載入完成: ${this.questionBank.questions.length} 題`),this.questionBank;return this.loadLegacy()}async loadBundle(z){if(this.loadedBundles.has(z))return;if(this.loadingPromises.has(z))return this.loadingPromises.get(z);if(!this.index)throw Error("索引檔尚未載入");let Z=this.index.bundles[z];if(!Z){console.warn(`分包不存在: ${z}`);return}let $=`${this.basePath}/${Z.path}`,V=(async()=>{try{let W=await fetch($);if(!W.ok)throw Error(`載入分包失敗: ${W.status}`);let J=await W.json();this.mergeQuestions(J.questions),this.loadedBundles.add(z),console.log(`分包載入完成: ${z} (${J.questions.length} 題)`)}catch(W){throw console.error(`載入分包 ${z} 失敗:`,W),W}finally{this.loadingPromises.delete(z)}})();return this.loadingPromises.set(z,V),V}mergeQuestions(z){if(!this.questionBank)return;let Z=new Set(this.questionBank.questions.map((V)=>V.id)),$=z.filter((V)=>!Z.has(V.id));this.questionBank.questions.push(...$)}async loadInBackground(z){for(let Z of z)if(!this.loadedBundles.has(Z)&&this.index?.bundles[Z])try{await this.loadBundle(Z)}catch($){console.warn(`背景載入 ${Z} 失敗，稍後重試`)}}isLevelLoaded(z){return this.loadedBundles.has(z)}getLoadingStatus(){let z=this.index?Object.keys(this.index.bundles).length:1;return{loadedBundles:[...this.loadedBundles],totalQuestions:this.questionBank?.questions.length||0,isFullyLoaded:this.loadedBundles.size>=z}}async loadLegacy(){try{let z=await fetch(this.dataUrl);if(!z.ok)throw Error(`載入題庫失敗: ${z.status} ${z.statusText}`);return this.questionBank=await z.json(),this.loadedBundles.add("legacy"),console.log(`題庫載入完成（傳統模式）: ${this.questionBank.questions.length} 題`),this.questionBank}catch(z){throw console.error("題庫載入錯誤:",z),z}}async load(){if(this.questionBank)return this.questionBank;return this.loadInitial()}isLoaded(){return this.questionBank!==null}getAllQuestions(){return this.questionBank?.questions||[]}filterQuestions(z={}){let Z=this.getAllQuestions();if(z.jlpt&&z.jlpt!=="all")Z=Z.filter(($)=>$.source.jlpt===z.jlpt);if(z.category&&z.category!=="all")Z=Z.filter(($)=>$.source.category===z.category);if(z.difficulty&&z.difficulty!=="all")Z=Z.filter(($)=>$.metadata.difficulty===z.difficulty);return Z}getRandomQuestion(z={}){let Z=this.filterQuestions(z);if(Z.length===0)return null;let $=Z.filter((J)=>!this.recentIds.has(J.id));if($.length===0)this.recentIds.clear(),$=Z;let V=Math.floor(Math.random()*$.length),W=$[V];if(this.recentIds.add(W.id),this.recentIds.size>this.maxRecentHistory){let J=this.recentIds.values().next().value;this.recentIds.delete(J)}return W}getQuestionById(z){return this.getAllQuestions().find((Z)=>Z.id===z)||null}getStats(){return this.questionBank?.stats||null}getJlptLevels(){let z=this.getStats();if(!z?.byJlpt)return["n5","n4","n3","n2","n1"];return Object.keys(z.byJlpt).sort()}getCategories(){let z=this.getStats();if(!z?.byCategory)return[];return Object.keys(z.byCategory).sort()}resetHistory(){this.recentIds.clear()}}var wZ=new T;class u{#z;#Z;#$;constructor(z={}){this.#z=z.lang||"ja-JP",this.#Z=z.rate||1,this.#$=z.speechSynthesis}get lang(){return this.#z}isSupported(){return this.#$!==void 0&&this.#$!==null}speak(z){return new Promise((Z,$)=>{if(!this.isSupported()){Z();return}let V=this.#V(z);V.lang=this.#z,V.rate=this.#Z,V.onend=()=>Z(),V.onerror=(W)=>$(W),this.#$.speak(V)})}cancel(){if(this.isSupported())this.#$.cancel()}#V(z){if(typeof SpeechSynthesisUtterance<"u")return new SpeechSynthesisUtterance(z);return{text:z,lang:"",rate:1,onend:null,onerror:null}}}var L={inputMode:"practice-input-mode",showRomajiHint:"practice-show-hint",jlptFilter:"practice-jlpt-filter"};class c{#z;constructor(z=null){this.#z=z||(typeof localStorage<"u"?localStorage:null)}load(){if(!this.#z)return null;try{let z=this.#z.getItem(L.inputMode),Z=this.#z.getItem(L.showRomajiHint),$=this.#z.getItem(L.jlptFilter);return{inputMode:z||"romaji",showRomajiHint:Z!=="false",filters:{jlpt:$||"all"}}}catch(z){return console.warn("Failed to load settings from localStorage:",z),null}}save(z){if(!this.#z)return;try{if(z.inputMode!==void 0)this.#z.setItem(L.inputMode,z.inputMode);if(z.showRomajiHint!==void 0)this.#z.setItem(L.showRomajiHint,z.showRomajiHint?"true":"false");if(z.filters?.jlpt!==void 0)this.#z.setItem(L.jlptFilter,z.filters.jlpt)}catch(Z){console.warn("Failed to save settings to localStorage:",Z)}}clear(){if(!this.#z)return;try{Object.values(L).forEach((z)=>{this.#z.removeItem(z)})}catch(z){console.warn("Failed to clear settings from localStorage:",z)}}get(z){if(!this.#z)return null;let Z=L[z];if(!Z)return null;try{return this.#z.getItem(Z)}catch($){return null}}set(z,Z){if(!this.#z)return;let $=L[z];if(!$)return;try{this.#z.setItem($,Z)}catch(V){console.warn(`Failed to save ${z} to localStorage:`,V)}}}class i{#z;#Z;#$={};#V=null;#J;#X=null;#F;#W;#Y;#G;constructor(z){this.#Z=z,this.#z=new q(r,a),this.#G=new T;let Z=new u;this.#W=new c,U.setDependencies({store:this.#z,questionLoader:this.#G,speechService:Z}),this.#N(),this.#Y=new d(z.keyboardContainer),this.#J=new y({keyboardRenderer:this.#Y,mobileInputElement:z.mobileInputElement}),this.#F=new l(z.textContainer),this.#D()}#N(){this.#$.text=new h(this.#Z.textContainer),this.#$.romaji=new m(this.#Z.romajiContainer),this.#$.result=new p(this.#Z.resultContainer,this.#_())}#_(){if(typeof window>"u")return"";let Z=window.location.pathname.match(/^(.*?)\/[^\/]+\/?$/);return Z?Z[1]:""}#D(){this.#z.subscribe((z,Z)=>{this.#O(z,Z)})}#O(z,Z){switch(Z.type){case"COMPLETE_SESSION":this.#M(z.result,z.currentQuestion);break;case"TOGGLE_ROMAJI_HINT":this.#B(z.uiSettings.showRomajiHint);break}}async initialize(){let z=this.#W.load();if(z){if(z.inputMode&&z.inputMode!=="romaji")this.#z.dispatch(Y.setInputMode(z.inputMode));if(z.filters?.jlpt)this.#z.dispatch(Y.setFilter("jlpt",z.filters.jlpt));if(z.showRomajiHint===!1)this.#z.dispatch(Y.toggleRomajiHint())}let Z=this.#P();if(Z.input==="direct"||Z.input==="mobile")this.#z.dispatch(Y.setInputMode("direct"));if(Z.text)await this.#A(Z.text);else{let $=Z.mode==="kana"?"kana":"question";await this.switchPracticeMode($)}this.#E()}#P(){if(typeof window>"u")return{};let z=new URLSearchParams(window.location.search);return{text:z.get("text"),mode:z.get("mode"),input:z.get("input")}}async#A(z){let{Question:Z}=await Promise.resolve().then(() => (M(),Fz)),$=Z.fromText(z);this.#z.dispatch(Y.loadQuestionSuccess({text:z})),this.#w($)}async switchPracticeMode(z){try{this.#z.dispatch(Y.setPracticeMode(z)),await U.switchMode(z),await this.loadNextQuestion()}catch(Z){console.error("Switch mode failed:",Z),this.#z.dispatch(Y.loadQuestionFailure(Z.message))}}switchInputMode(z){this.#z.dispatch(Y.setInputMode(z)),this.#W.save({inputMode:z}),this.#T("input",z==="direct"?"direct":null),this.#L(z),this.loadNextQuestion()}setFilter(z,Z){this.#z.dispatch(Y.setFilter(z,Z)),this.#W.save({filters:{[z]:Z}}),this.loadNextQuestion()}toggleRomajiHint(){this.#z.dispatch(Y.toggleRomajiHint());let z=this.#z.getState();this.#W.save({showRomajiHint:z.uiSettings.showRomajiHint})}async loadNextQuestion(){let z=U.getCurrentMode();if(!z)return;this.#U();try{this.#z.dispatch(Y.startLoading()),this.#$.result.hide();let Z=await z.loadNextQuestion();this.#w(Z)}catch(Z){console.error("Load question failed:",Z),this.#z.dispatch(Y.loadQuestionFailure(Z.message))}}#w(z){let Z=U.getCurrentMode(),$=Z?Z.createSession(z):this.#H(z);if(this.#X=$,Z)Z.setupSessionListeners($);$.on("CharacterCompleted",()=>{this.#F.flashSuccess(),this.#Q()}),$.on("CharacterMistaken",()=>{this.#F.flashError()}),$.on("RomajiMatched",(V)=>{this.#R(V.romaji)}),$.on("SessionCompleted",(V)=>{this.#z.dispatch(Y.completeSession(V))}),this.#K(this.#z.getState().inputMode),this.#Q()}async#H(z){let{TypingSession:Z}=await Promise.resolve().then(() => (j(),t));return new Z(z)}#U(){if(this.#V)this.#V.dispose(),this.#V=null;this.#X=null}#K(z){if(this.#V)this.#V.dispose();this.#V=this.#J.create(z),this.#V.setSession(this.#X),this.#V.setUpdateCallback(()=>this.#Q()),this.#V.activate(),this.#L(z)}#L(z){let Z=this.#Z.container,$=typeof document<"u"?document.body:null,V=typeof document<"u"?document.getElementById("mobile-input-section"):null,W=this.#Z.keyboardContainer;if(z==="direct"){if(Z?.classList.add("mode-direct"),$?.classList.add("mode-direct"),V)V.style.display="block";if(W)W.style.display="none"}else{if(Z?.classList.remove("mode-direct"),$?.classList.remove("mode-direct"),V)V.style.display="none";if(W)W.style.display=""}}#B(z){let Z=this.#Z.container;if(Z)Z.classList.toggle("hide-romaji-hint",!z)}#E(){let z=this.#z.getState();this.#B(z.uiSettings.showRomajiHint),this.#L(z.inputMode)}#Q(){if(!this.#X)return;let z=this.#z.getState(),Z=this.#X.question;if(this.#$.text.render(Z,z.currentQuestion),this.#$.romaji.render(Z),this.#V?.updateHighlight)this.#V.updateHighlight()}#R(z){let Z=this.#Z.bufferDisplay;if(Z)Z.textContent=z}#M(z,Z){this.#$.result.setNextQuestionCallback(()=>this.loadNextQuestion()),this.#$.result.render(z,Z)}#T(z,Z){if(typeof window>"u")return;let $=new URL(window.location);if(Z)$.searchParams.set(z,Z);else $.searchParams.delete(z);window.history.replaceState({},"",$)}getStore(){return this.#z}getState(){return this.#z.getState()}getQuestionLoader(){return this.#G}dispose(){this.#U(),Object.values(this.#$).forEach((z)=>z.dispose?.()),U.reset()}}var K=null;function Ez(z){let Z=document.querySelector(".practice-container");if(!Z)return;if(document.getElementById("practice-controls"))return;let $=z.getState(),V=$.inputMode==="romaji"?"手機模式":"鍵盤模式",W=$.uiSettings.showRomajiHint?"隱藏提示":"顯示提示",J=$.practiceMode==="question"?"假名模式":"題庫模式",X=$.practiceMode==="kana"?"none":"",F=document.createElement("div");F.id="practice-controls",F.className="practice-controls",F.innerHTML=`
    <div class="control-group" id="jlpt-filter-group" style="display: ${X}">
      <label for="jlpt-filter">JLPT 等級：</label>
      <select id="jlpt-filter">
        <option value="all">全部</option>
        <option value="n5">N5</option>
        <option value="n4">N4</option>
        <option value="n3">N3</option>
        <option value="n2">N2</option>
        <option value="n1">N1</option>
      </select>
    </div>
    <div class="control-group">
      <button id="btn-next" class="control-btn">下一題</button>
      <button id="btn-toggle-practice" class="control-btn secondary">${J}</button>
      <button id="btn-toggle-input" class="control-btn secondary">${V}</button>
      <button id="btn-toggle-hint" class="control-btn secondary">${W}</button>
    </div>
  `;let _=Z.querySelector(".practice-area")||Z.firstChild;Z.insertBefore(F,_),Rz(z)}function Rz(z){let Z=document.getElementById("jlpt-filter");if(Z){let X=z.getState();Z.value=X.filters.jlpt,Z.addEventListener("change",(F)=>{z.setFilter("jlpt",F.target.value)})}let $=document.getElementById("btn-next");if($)$.addEventListener("click",()=>{z.loadNextQuestion()});let V=document.getElementById("btn-toggle-practice");if(V)V.addEventListener("click",()=>{let F=z.getState().practiceMode==="question"?"kana":"question";z.switchPracticeMode(F),V.textContent=F==="question"?"假名模式":"題庫模式";let _=document.getElementById("jlpt-filter-group");if(_)_.style.display=F==="kana"?"none":""});let W=document.getElementById("btn-toggle-input");if(W)W.addEventListener("click",()=>{let F=z.getState().inputMode==="romaji"?"direct":"romaji";z.switchInputMode(F),W.textContent=F==="romaji"?"手機模式":"鍵盤模式"});let J=document.getElementById("btn-toggle-hint");if(J)J.addEventListener("click",()=>{z.toggleRomajiHint();let X=z.getState();J.textContent=X.uiSettings.showRomajiHint?"隱藏提示":"顯示提示"})}function Mz(z){if(z)z.innerHTML='<span class="loading">載入題庫中...</span>'}function Tz(z,Z){if(z)z.innerHTML=`
      <div class="error-message">
        <p>${Z}</p>
        <button onclick="location.reload()">重新載入</button>
      </div>
    `}async function o(){let z=document.getElementById("practice-text"),Z=document.getElementById("practice-romaji"),$=document.getElementById("keyboard"),V=document.querySelector(".practice-container");if(!z||!Z||!$){console.error("找不到必要的 DOM 元素");return}let W=document.getElementById("result-container");if(!W)W=document.createElement("div"),W.id="result-container",W.className="result-container",W.style.display="none",V?.appendChild(W);let J=document.getElementById("buffer-display");if(!J)J=document.createElement("div"),J.id="buffer-display",J.className="buffer-display",Z.parentNode?.insertBefore(J,Z.nextSibling);let X=document.getElementById("mobile-kana-input");Mz(z);try{K=new i({container:V,textContainer:z,romajiContainer:Z,resultContainer:W,bufferDisplay:J,keyboardContainer:$,mobileInputElement:X}),Ez(K),await K.initialize(),console.log("應用程式初始化完成")}catch(F){console.error("應用程式初始化失敗:",F),Tz(z,"應用程式初始化失敗")}if(typeof window<"u")window.__app=K}if(typeof document<"u")if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",o);else o();})();
