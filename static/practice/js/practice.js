var H={"あ":["a"],"い":["i"],"う":["u"],"え":["e"],"お":["o"],"ア":["a"],"イ":["i"],"ウ":["u"],"エ":["e"],"オ":["o"],"か":["ka"],"き":["ki"],"く":["ku"],"け":["ke"],"こ":["ko"],"カ":["ka"],"キ":["ki"],"ク":["ku"],"ケ":["ke"],"コ":["ko"],"さ":["sa"],"し":["si","shi"],"す":["su"],"せ":["se"],"そ":["so"],"サ":["sa"],"シ":["si","shi"],"ス":["su"],"セ":["se"],"ソ":["so"],"た":["ta"],"ち":["ti","chi"],"つ":["tu","tsu"],"て":["te"],"と":["to"],"タ":["ta"],"チ":["ti","chi"],"ツ":["tu","tsu"],"テ":["te"],"ト":["to"],"な":["na"],"に":["ni"],"ぬ":["nu"],"ね":["ne"],"の":["no"],"ナ":["na"],"ニ":["ni"],"ヌ":["nu"],"ネ":["ne"],"ノ":["no"],"は":["ha"],"ひ":["hi"],"ふ":["hu","fu"],"へ":["he"],"ほ":["ho"],"ハ":["ha"],"ヒ":["hi"],"フ":["hu","fu"],"ヘ":["he"],"ホ":["ho"],"ま":["ma"],"み":["mi"],"む":["mu"],"め":["me"],"も":["mo"],"マ":["ma"],"ミ":["mi"],"ム":["mu"],"メ":["me"],"モ":["mo"],"や":["ya"],"ゆ":["yu"],"よ":["yo"],"ヤ":["ya"],"ユ":["yu"],"ヨ":["yo"],"ら":["ra"],"り":["ri"],"る":["ru"],"れ":["re"],"ろ":["ro"],"ラ":["ra"],"リ":["ri"],"ル":["ru"],"レ":["re"],"ロ":["ro"],"わ":["wa"],"を":["wo"],"ん":["n","nn"],"ワ":["wa"],"ヲ":["wo"],"ン":["n","nn"],"が":["ga"],"ぎ":["gi"],"ぐ":["gu"],"げ":["ge"],"ご":["go"],"ガ":["ga"],"ギ":["gi"],"グ":["gu"],"ゲ":["ge"],"ゴ":["go"],"ざ":["za"],"じ":["zi","ji"],"ず":["zu"],"ぜ":["ze"],"ぞ":["zo"],"ザ":["za"],"ジ":["zi","ji"],"ズ":["zu"],"ゼ":["ze"],"ゾ":["zo"],"だ":["da"],"ぢ":["di"],"づ":["du","dzu"],"で":["de"],"ど":["do"],"ダ":["da"],"ヂ":["di"],"ヅ":["du","dzu"],"デ":["de"],"ド":["do"],"ば":["ba"],"び":["bi"],"ぶ":["bu"],"べ":["be"],"ぼ":["bo"],"バ":["ba"],"ビ":["bi"],"ブ":["bu"],"ベ":["be"],"ボ":["bo"],"ぱ":["pa"],"ぴ":["pi"],"ぷ":["pu"],"ぺ":["pe"],"ぽ":["po"],"パ":["pa"],"ピ":["pi"],"プ":["pu"],"ペ":["pe"],"ポ":["po"],"きゃ":["kya"],"きゅ":["kyu"],"きょ":["kyo"],"しゃ":["sya","sha"],"しゅ":["syu","shu"],"しょ":["syo","sho"],"ちゃ":["tya","cha"],"ちゅ":["tyu","chu"],"ちょ":["tyo","cho"],"にゃ":["nya"],"にゅ":["nyu"],"にょ":["nyo"],"ひゃ":["hya"],"ひゅ":["hyu"],"ひょ":["hyo"],"みゃ":["mya"],"みゅ":["myu"],"みょ":["myo"],"りゃ":["rya"],"りゅ":["ryu"],"りょ":["ryo"],"ぎゃ":["gya"],"ぎゅ":["gyu"],"ぎょ":["gyo"],"じゃ":["zya","ja","jya"],"じゅ":["zyu","ju","jyu"],"じょ":["zyo","jo","jyo"],"びゃ":["bya"],"びゅ":["byu"],"びょ":["byo"],"ぴゃ":["pya"],"ぴゅ":["pyu"],"ぴょ":["pyo"],"っ":["xtu","ltu","xtsu","ltsu"],"ッ":["xtu","ltu","xtsu","ltsu"],"ぁ":["xa","la"],"ぃ":["xi","li"],"ぅ":["xu","lu"],"ぇ":["xe","le"],"ぉ":["xo","lo"],"ゃ":["xya","lya"],"ゅ":["xyu","lyu"],"ょ":["xyo","lyo"],"、":[","],"。":["."],"？":["?"],"！":["!"],"「":["["],"」":["]"],"ー":["-"],"ティ":["thi","texi","teli"],"ディ":["dhi","dexi","deli"],"ファ":["fa","huxa","hula"],"フィ":["fi","huxi","huli"],"フェ":["fe","huxe","hule"],"フォ":["fo","huxo","hulo"],"ウィ":["wi","uxi","uli"],"ウェ":["we","uxe","ule"],"ウォ":["wo","uxo","ulo"],"ヴァ":["va","vuxa"],"ヴィ":["vi","vuxi"],"ヴ":["vu"],"ヴェ":["ve","vuxe"],"ヴォ":["vo","vuxo"],"ゐ":["wi"],"ヰ":["wi"],"ゑ":["we"],"ヱ":["we"]};function L(z){return H[z]||[]}function E(z,G){return G.some((V)=>V.startsWith(z))}function M(z,G){return G.includes(z)}var K=["っ","ッ"];function B(z){return K.includes(z)}function b(z){if(z.startsWith("ch"))return"c";if(z.startsWith("sh"))return"s";if(z.startsWith("ts"))return"t";if(z.startsWith("th"))return"t";if(z.startsWith("dh"))return"d";let G=z[0];return["a","i","u","e","o"].includes(G)?null:G}function _(z){return z.length>=2&&K.includes(z[0])}function R(z){if(!_(z))return[];let G=z.slice(1),V=L(G);if(V.length===0)return[];let Z=[];for(let F of V){let W=b(F);if(W)Z.push(W+F)}let $=["xtu","ltu"];for(let F of $)for(let W of V)Z.push(F+W);return Z}var Q={PENDING:"pending",CURRENT:"current",COMPLETED:"completed"};class A{#z;#G;#V;constructor(z,G=Q.PENDING,V=null){if(this.#z=z,V)this.#G=V;else if(_(z))this.#G=R(z);else this.#G=L(z);this.#V=G}get kana(){return this.#z}get romaji(){return this.#G}get state(){return this.#V}setCurrent(){return new A(this.#z,Q.CURRENT,this.#G)}setCompleted(){return new A(this.#z,Q.COMPLETED,this.#G)}matchesRomaji(z){return M(z,this.#G)}isPartialMatch(z){return E(z,this.#G)}}var O=["きゃ","きゅ","きょ","しゃ","しゅ","しょ","ちゃ","ちゅ","ちょ","にゃ","にゅ","にょ","ひゃ","ひゅ","ひょ","みゃ","みゅ","みょ","りゃ","りゅ","りょ","ぎゃ","ぎゅ","ぎょ","じゃ","じゅ","じょ","びゃ","びゅ","びょ","ぴゃ","ぴゅ","ぴょ","キャ","キュ","キョ","シャ","シュ","ショ","チャ","チュ","チョ","ニャ","ニュ","ニョ","ヒャ","ヒュ","ヒョ","ミャ","ミュ","ミョ","リャ","リュ","リョ","ギャ","ギュ","ギョ","ジャ","ジュ","ジョ","ビャ","ビュ","ビョ","ピャ","ピュ","ピョ","ティ","ディ","ファ","フィ","フェ","フォ","ウィ","ウェ","ウォ","ヴァ","ヴィ","ヴェ","ヴォ"];function T(z,G){if(G>=z.length)return null;if(G+1<z.length){let V=z.slice(G,G+2);if(O.includes(V)||H[V])return V}return z[G]}function I(z){let G=L(z);if(G.length===0)return!1;let V=["a","i","u","e","o"];return G.some((Z)=>!V.includes(Z[0]))}function v(z){let G=[],V=0;while(V<z.length){if(B(z[V])&&V+1<z.length){let Z=T(z,V+1);if(Z&&I(Z)){G.push(z[V]+Z),V+=1+Z.length;continue}}if(V+1<z.length){let Z=z.slice(V,V+2);if(O.includes(Z)||H[Z]){G.push(Z),V+=2;continue}}G.push(z[V]),V+=1}return G}var C=["な","に","ぬ","ね","の","にゃ","にゅ","にょ","あ","い","う","え","お","や","ゆ","よ","ナ","ニ","ヌ","ネ","ノ","ニャ","ニュ","ニョ","ア","イ","ウ","エ","オ","ヤ","ユ","ヨ"];function j(z){return z==="ん"||z==="ン"}function f(z){return C.includes(z)}class D{#z;#G;#V;constructor(z,G,V=0){this.#z=z,this.#G=G,this.#V=V}static fromText(z){let V=v(z).map((Z,$,F)=>{let W=null;if(j(Z))if($===F.length-1)W=["n","nn"];else{let w=F[$+1];if(f(w))W=["nn","n'"]}let J=new A(Z,Q.PENDING,W);return $===0?J.setCurrent():J});return new D(z,V,0)}get text(){return this.#z}get characters(){return this.#G}get currentIndex(){return this.#V}getCurrentCharacter(){if(this.#V>=this.#G.length)return null;return this.#G[this.#V]}advance(){if(this.isCompleted())return this;let z=this.#G.map((G,V)=>{if(V===this.#V)return G.setCompleted();else if(V===this.#V+1)return G.setCurrent();return G});return new D(this.#z,z,this.#V+1)}isCompleted(){return this.#V>=this.#G.length}getProgress(){if(this.#G.length===0)return 1;return this.#V/this.#G.length}}var X={COMPLETE:"COMPLETE",PARTIAL:"PARTIAL",MISMATCH:"MISMATCH"};class Y{#z;constructor(z=""){this.#z=z}get value(){return this.#z}get length(){return this.#z.length}isEmpty(){return this.#z.length===0}add(z){return new Y(this.#z+z)}reset(){return new Y}tryMatch(z){if(z.matchesRomaji(this.#z))return{type:X.COMPLETE};if(z.isPartialMatch(this.#z))return{type:X.PARTIAL};return{type:X.MISMATCH}}}class N{#z;#G;#V;#Z;#F;#W;constructor(z){this.#z=z,this.#G=new Y,this.#V=new Date,this.#Z=new Map,this.#F=0,this.#W=0}get question(){return this.#z}get startTime(){return this.#V}get inputBuffer(){return this.#G}on(z,G){if(!this.#Z.has(z))this.#Z.set(z,[]);this.#Z.get(z).push(G)}#$(z,G){let V=this.#Z.get(z);if(V)V.forEach((Z)=>Z(G))}handleKeyPress(z){if(this.#z.isCompleted())return;this.#F++,this.#$("KeyPressed",{key:z,timestamp:Date.now()});let G=this.#z.getCurrentCharacter();if(!G)return;let V=this.#G.add(z);switch(V.tryMatch(G).type){case X.COMPLETE:this.#Y(G,V);break;case X.PARTIAL:this.#J(V);break;case X.MISMATCH:this.#X(G,z);break}}#Y(z,G){if(this.#$("RomajiMatched",{romaji:G.value,isPartial:!1}),this.#z=this.#z.advance(),this.#G=new Y,this.#$("CharacterCompleted",{character:z,duration:Date.now()-this.#V.getTime()}),this.#$("SpeechRequested",{text:z.kana}),this.#z.isCompleted())this.#L()}#J(z){this.#G=z,this.#$("RomajiMatched",{romaji:z.value,isPartial:!0})}#X(z,G){this.#W++,this.#$("CharacterMistaken",{expected:z.romaji,actual:G}),this.#G=new Y}#L(){let G=new Date().getTime()-this.#V.getTime(),V=this.#F-this.#W,Z=this.#F>0?V/this.#F:1;this.#$("SessionCompleted",{totalTime:G,accuracy:Z,totalKeystrokes:this.#F,mistakes:this.#W})}getCurrentCharacter(){return this.#z.getCurrentCharacter()}getHintRomaji(){let z=this.getCurrentCharacter();if(!z||z.romaji.length===0)return"";return z.romaji[0]}getProgress(){return this.#z.getProgress()}}class P{#z;#G;#V;constructor(z={}){this.#z=z.lang||"ja-JP",this.#G=z.rate||1,this.#V=z.speechSynthesis}get lang(){return this.#z}isSupported(){return this.#V!==void 0&&this.#V!==null}speak(z){return new Promise((G,V)=>{if(!this.isSupported()){G();return}let Z=this.#Z(z);Z.lang=this.#z,Z.rate=this.#G,Z.onend=()=>G(),Z.onerror=($)=>V($),this.#V.speak(Z)})}cancel(){if(this.isSupported())this.#V.cancel()}#Z(z){if(typeof SpeechSynthesisUtterance!=="undefined")return new SpeechSynthesisUtterance(z);return{text:z,lang:"",rate:1,onend:null,onerror:null}}}class U{#z;#G;#V;#Z;constructor(z){let G=D.fromText(z.text);this.#z=new N(G),this.#G=new P({speechSynthesis:typeof speechSynthesis!=="undefined"?speechSynthesis:void 0}),this.#V=z.elements,this.#Z=z.keyboardRenderer,this.#F(),this.#W(),this.#$()}#F(){this.#z.on("RomajiMatched",(z)=>{this.#X(z.romaji)}),this.#z.on("CharacterCompleted",(z)=>{this.#$(),this.#Q()}),this.#z.on("SpeechRequested",(z)=>{this.#G.speak(z.text)}),this.#z.on("CharacterMistaken",(z)=>{this.#A(),this.#X("")}),this.#z.on("SessionCompleted",(z)=>{this.#D(z)})}#W(){document.addEventListener("keydown",(z)=>{if(z.ctrlKey||z.altKey||z.metaKey)return;if(z.key.length!==1)return;z.preventDefault();let G=z.key.toLowerCase();this.#Z?.showKeyPress(G),this.#z.handleKeyPress(G)})}#$(){this.#Y(),this.#J(),this.#L()}#Y(){let z=this.#V.textContainer;if(!z)return;let G=this.#z.question.characters;z.innerHTML=G.map((V,Z)=>{return`<span class="char ${`char-${V.state}`}">${V.kana}</span>`}).join("")}#J(){let z=this.#V.romajiContainer;if(!z)return;let G=this.#z.question.characters;z.innerHTML=G.map((V,Z)=>{let $=`romaji-${V.state}`,F=V.romaji[0]||"";return`<span class="romaji ${$}">${F}</span>`}).join("")}#X(z){let G=this.#V.bufferDisplay;if(G)G.textContent=z}#L(){if(!this.#Z)return;let z=this.#z.getHintRomaji(),G=z?z[0]:null;this.#Z.highlightKey(G)}#Q(){let z=this.#V.textContainer;if(!z)return;z.classList.add("flash-success"),setTimeout(()=>z.classList.remove("flash-success"),200)}#A(){let z=this.#V.textContainer;if(!z)return;z.classList.add("flash-error"),setTimeout(()=>z.classList.remove("flash-error"),200)}#D(z){let G=this.#V.resultContainer;if(!G)return;let V=Math.round(z.accuracy*100),Z=(z.totalTime/1000).toFixed(1);G.innerHTML=`
      <div class="result-box">
        <h2>完成！</h2>
        <div class="result-stats">
          <div class="stat">
            <span class="stat-value">${V}%</span>
            <span class="stat-label">準確率</span>
          </div>
          <div class="stat">
            <span class="stat-value">${Z}s</span>
            <span class="stat-label">時間</span>
          </div>
          <div class="stat">
            <span class="stat-value">${z.totalKeystrokes}</span>
            <span class="stat-label">按鍵數</span>
          </div>
        </div>
        <button class="retry-btn" onclick="location.reload()">再試一次</button>
      </div>
    `,G.style.display="flex"}getProgress(){return this.#z.getProgress()}}class q{#z;#G;constructor(z){this.#z=z,this.#G=null}highlightKey(z){if(this.#G)this.#G.classList.remove("key-target");if(!z){this.#G=null;return}let G=this.#z.querySelector(`[data-key="${z}"]`);if(G)G.classList.add("key-target"),this.#G=G}showKeyPress(z){let G=this.#z.querySelector(`[data-key="${z}"]`);if(!G)return;G.classList.add("key-pressed"),setTimeout(()=>{G.classList.remove("key-pressed")},100)}clearHighlights(){this.#z.querySelectorAll(".key").forEach((G)=>{G.classList.remove("key-target","key-pressed")}),this.#G=null}}var g=["あいうえお","かきくけこ","さしすせそ","たちつてと","なにぬねの","はひふへほ","まみむめも","やゆよ","らりるれろ","わをん","がぎぐげご","ざじずぜぞ","だぢづでど","ばびぶべぼ","ぱぴぷぺぽ","きゃきゅきょ","しゃしゅしょ","ちゃちゅちょ","こんにちは","ありがとう","おはよう","さようなら","いただきます","ごちそうさま"];function y(){let z=Math.floor(Math.random()*g.length);return g[z]}function S(){let z=document.getElementById("practice-text"),G=document.getElementById("practice-romaji"),V=document.getElementById("keyboard");if(!z||!G||!V){console.error("找不到必要的 DOM 元素");return}let Z=document.getElementById("result-container");if(!Z)Z=document.createElement("div"),Z.id="result-container",Z.className="result-container",Z.style.display="none",document.querySelector(".practice-container")?.appendChild(Z);let $=document.getElementById("buffer-display");if(!$)$=document.createElement("div"),$.id="buffer-display",$.className="buffer-display",G.parentNode?.insertBefore($,G.nextSibling);let F=new q(V),J=new URLSearchParams(window.location.search).get("text")||y(),w=new U({text:J,elements:{textContainer:z,romajiContainer:G,resultContainer:Z,bufferDisplay:$},keyboardRenderer:F});console.log("練習文字:",J)}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",S);else S();
