var I={"あ":["a"],"い":["i"],"う":["u"],"え":["e"],"お":["o"],"ア":["a"],"イ":["i"],"ウ":["u"],"エ":["e"],"オ":["o"],"か":["ka"],"き":["ki"],"く":["ku"],"け":["ke"],"こ":["ko"],"カ":["ka"],"キ":["ki"],"ク":["ku"],"ケ":["ke"],"コ":["ko"],"さ":["sa"],"し":["si","shi"],"す":["su"],"せ":["se"],"そ":["so"],"サ":["sa"],"シ":["si","shi"],"ス":["su"],"セ":["se"],"ソ":["so"],"た":["ta"],"ち":["ti","chi"],"つ":["tu","tsu"],"て":["te"],"と":["to"],"タ":["ta"],"チ":["ti","chi"],"ツ":["tu","tsu"],"テ":["te"],"ト":["to"],"な":["na"],"に":["ni"],"ぬ":["nu"],"ね":["ne"],"の":["no"],"ナ":["na"],"ニ":["ni"],"ヌ":["nu"],"ネ":["ne"],"ノ":["no"],"は":["ha"],"ひ":["hi"],"ふ":["hu","fu"],"へ":["he"],"ほ":["ho"],"ハ":["ha"],"ヒ":["hi"],"フ":["hu","fu"],"ヘ":["he"],"ホ":["ho"],"ま":["ma"],"み":["mi"],"む":["mu"],"め":["me"],"も":["mo"],"マ":["ma"],"ミ":["mi"],"ム":["mu"],"メ":["me"],"モ":["mo"],"や":["ya"],"ゆ":["yu"],"よ":["yo"],"ヤ":["ya"],"ユ":["yu"],"ヨ":["yo"],"ら":["ra"],"り":["ri"],"る":["ru"],"れ":["re"],"ろ":["ro"],"ラ":["ra"],"リ":["ri"],"ル":["ru"],"レ":["re"],"ロ":["ro"],"わ":["wa"],"を":["wo"],"ん":["nn","n"],"ワ":["wa"],"ヲ":["wo"],"ン":["nn","n"],"が":["ga"],"ぎ":["gi"],"ぐ":["gu"],"げ":["ge"],"ご":["go"],"ガ":["ga"],"ギ":["gi"],"グ":["gu"],"ゲ":["ge"],"ゴ":["go"],"ざ":["za"],"じ":["zi","ji"],"ず":["zu"],"ぜ":["ze"],"ぞ":["zo"],"ザ":["za"],"ジ":["zi","ji"],"ズ":["zu"],"ゼ":["ze"],"ゾ":["zo"],"だ":["da"],"ぢ":["di"],"づ":["du","dzu"],"で":["de"],"ど":["do"],"ダ":["da"],"ヂ":["di"],"ヅ":["du","dzu"],"デ":["de"],"ド":["do"],"ば":["ba"],"び":["bi"],"ぶ":["bu"],"べ":["be"],"ぼ":["bo"],"バ":["ba"],"ビ":["bi"],"ブ":["bu"],"ベ":["be"],"ボ":["bo"],"ぱ":["pa"],"ぴ":["pi"],"ぷ":["pu"],"ぺ":["pe"],"ぽ":["po"],"パ":["pa"],"ピ":["pi"],"プ":["pu"],"ペ":["pe"],"ポ":["po"],"きゃ":["kya"],"きゅ":["kyu"],"きょ":["kyo"],"しゃ":["sya","sha"],"しゅ":["syu","shu"],"しょ":["syo","sho"],"ちゃ":["tya","cha"],"ちゅ":["tyu","chu"],"ちょ":["tyo","cho"],"にゃ":["nya"],"にゅ":["nyu"],"にょ":["nyo"],"ひゃ":["hya"],"ひゅ":["hyu"],"ひょ":["hyo"],"みゃ":["mya"],"みゅ":["myu"],"みょ":["myo"],"りゃ":["rya"],"りゅ":["ryu"],"りょ":["ryo"],"ぎゃ":["gya"],"ぎゅ":["gyu"],"ぎょ":["gyo"],"じゃ":["zya","ja","jya"],"じゅ":["zyu","ju","jyu"],"じょ":["zyo","jo","jyo"],"びゃ":["bya"],"びゅ":["byu"],"びょ":["byo"],"ぴゃ":["pya"],"ぴゅ":["pyu"],"ぴょ":["pyo"],"っ":["xtu","ltu","xtsu","ltsu"],"ッ":["xtu","ltu","xtsu","ltsu"],"ぁ":["xa","la"],"ぃ":["xi","li"],"ぅ":["xu","lu"],"ぇ":["xe","le"],"ぉ":["xo","lo"],"ゃ":["xya","lya"],"ゅ":["xyu","lyu"],"ょ":["xyo","lyo"],"、":[","],"。":["."],"？":["?"],"！":["!"],"「":["["],"」":["]"],"ー":["-"],"〜":["~"],"ティ":["thi","texi","teli"],"ディ":["dhi","dexi","deli"],"ファ":["fa","huxa","hula"],"フィ":["fi","huxi","huli"],"フェ":["fe","huxe","hule"],"フォ":["fo","huxo","hulo"],"ウィ":["wi","uxi","uli"],"ウェ":["we","uxe","ule"],"ウォ":["wo","uxo","ulo"],"ヴァ":["va","vuxa"],"ヴィ":["vi","vuxi"],"ヴ":["vu"],"ヴェ":["ve","vuxe"],"ヴォ":["vo","vuxo"],"ゐ":["wi"],"ヰ":["wi"],"ゑ":["we"],"ヱ":["we"]};function M(z){return I[z]||[]}function m(z,G){return G.some((V)=>V.startsWith(z))}function h(z,G){return G.includes(z)}var p=["っ","ッ"],a=["、","。","？","！","「","」","（","）","(",")","ー","〜","～","*"];function d(z){return a.includes(z)}function l(z){return p.includes(z)}function n(z){if(z.startsWith("ch"))return"c";if(z.startsWith("sh"))return"s";if(z.startsWith("ts"))return"t";if(z.startsWith("th"))return"t";if(z.startsWith("dh"))return"d";let G=z[0];return["a","i","u","e","o"].includes(G)?null:G}function j(z){return z.length>=2&&p.includes(z[0])}function c(z){if(!j(z))return[];let G=z.slice(1),V=M(G);if(V.length===0)return[];let Z=[];for(let W of V){let X=n(W);if(X)Z.push(X+W)}let $=["xtu","ltu"];for(let W of $)for(let X of V)Z.push(W+X);return Z}var O={PENDING:"pending",CURRENT:"current",COMPLETED:"completed"};class B{#z;#G;#V;#Z;constructor(z,G=O.PENDING,V=null,Z=null){if(this.#z=z,this.#Z=Z||z,V)this.#G=V;else if(j(z))this.#G=c(z);else this.#G=M(z);this.#V=G}get kana(){return this.#z}get romaji(){return this.#G}get state(){return this.#V}get display(){return this.#Z}setCurrent(){return new B(this.#z,O.CURRENT,this.#G,this.#Z)}setCompleted(){return new B(this.#z,O.COMPLETED,this.#G,this.#Z)}matchesRomaji(z){return h(z,this.#G)}isPartialMatch(z){return m(z,this.#G)}isPunctuation(){return d(this.#z)}matchesKana(z){return this.#z===z}matchesDisplay(z){return this.#Z===z}}var u=["きゃ","きゅ","きょ","しゃ","しゅ","しょ","ちゃ","ちゅ","ちょ","にゃ","にゅ","にょ","ひゃ","ひゅ","ひょ","みゃ","みゅ","みょ","りゃ","りゅ","りょ","ぎゃ","ぎゅ","ぎょ","じゃ","じゅ","じょ","びゃ","びゅ","びょ","ぴゃ","ぴゅ","ぴょ","キャ","キュ","キョ","シャ","シュ","ショ","チャ","チュ","チョ","ニャ","ニュ","ニョ","ヒャ","ヒュ","ヒョ","ミャ","ミュ","ミョ","リャ","リュ","リョ","ギャ","ギュ","ギョ","ジャ","ジュ","ジョ","ビャ","ビュ","ビョ","ピャ","ピュ","ピョ","ティ","ディ","ファ","フィ","フェ","フォ","ウィ","ウェ","ウォ","ヴァ","ヴィ","ヴェ","ヴォ"];function r(z,G){if(G>=z.length)return null;if(G+1<z.length){let V=z.slice(G,G+2);if(u.includes(V)||I[V])return V}return z[G]}function t(z){let G=M(z);if(G.length===0)return!1;let V=["a","i","u","e","o"];return G.some((Z)=>!V.includes(Z[0]))}function e(z){let G=[],V=0;while(V<z.length){if(l(z[V])&&V+1<z.length){let Z=r(z,V+1);if(Z&&t(Z)){G.push(z[V]+Z),V+=1+Z.length;continue}}if(V+1<z.length){let Z=z.slice(V,V+2);if(u.includes(Z)||I[Z]){G.push(Z),V+=2;continue}}G.push(z[V]),V+=1}return G}var zz=["な","に","ぬ","ね","の","にゃ","にゅ","にょ","あ","い","う","え","お","や","ゆ","よ","ナ","ニ","ヌ","ネ","ノ","ニャ","ニュ","ニョ","ア","イ","ウ","エ","オ","ヤ","ユ","ヨ"];function Gz(z){return z==="ん"||z==="ン"}function Vz(z){return zz.includes(z)}class E{#z;#G;#V;constructor(z,G,V=0){this.#z=z,this.#G=G,this.#V=V}static fromText(z){let V=e(z).map((Z,$,W)=>{let X=null;if(Gz(Z))if($===W.length-1)X=["n","nn"];else{let A=W[$+1];if(Vz(A))X=["nn","n'"]}let J=new B(Z,O.PENDING,X);return $===0?J.setCurrent():J});return new E(z,V,0)}static fromQuestionData(z){let G=z.characters.map((Z,$)=>{let W=new B(Z.kana,O.PENDING,Z.romaji,Z.display);return $===0?W.setCurrent():W}),V=new E(z.text,G,0);return V._id=z.id,V._displayCharacters=z.characters,V._source=z.source,V._metadata=z.metadata,V}get id(){return this._id}get displayCharacters(){return this._displayCharacters}get source(){return this._source}get metadata(){return this._metadata}get text(){return this.#z}get characters(){return this.#G}get currentIndex(){return this.#V}getCurrentCharacter(){if(this.#V>=this.#G.length)return null;return this.#G[this.#V]}advance(){if(this.isCompleted())return this;let z=this.#G.map((G,V)=>{if(V===this.#V)return G.setCompleted();else if(V===this.#V+1)return G.setCurrent();return G});return new E(this.#z,z,this.#V+1)}isCompleted(){return this.#V>=this.#G.length}getProgress(){if(this.#G.length===0)return 1;return this.#V/this.#G.length}}var H={COMPLETE:"COMPLETE",PARTIAL:"PARTIAL",MISMATCH:"MISMATCH"};class Q{#z;constructor(z=""){this.#z=z}get value(){return this.#z}get length(){return this.#z.length}isEmpty(){return this.#z.length===0}add(z){return new Q(this.#z+z)}reset(){return new Q}tryMatch(z){if(z.matchesRomaji(this.#z))return{type:H.COMPLETE};if(z.isPartialMatch(this.#z))return{type:H.PARTIAL};return{type:H.MISMATCH}}}class q{#z;#G;#V;#Z;#$;#X;constructor(z){this.#z=z,this.#G=new Q,this.#V=new Date,this.#Z=new Map,this.#$=0,this.#X=0,this.#J()}#J(){let z=[];while(!this.#z.isCompleted()){let G=this.#z.getCurrentCharacter();if(!G||!G.isPunctuation())break;z.push(G),this.#z=this.#z.advance()}return z}get question(){return this.#z}get startTime(){return this.#V}get inputBuffer(){return this.#G}on(z,G){if(!this.#Z.has(z))this.#Z.set(z,[]);this.#Z.get(z).push(G)}#W(z,G){let V=this.#Z.get(z);if(V)V.forEach((Z)=>Z(G))}handleKeyPress(z){if(this.#z.isCompleted())return;this.#$++,this.#W("KeyPressed",{key:z,timestamp:Date.now()});let G=this.#z.getCurrentCharacter();if(!G)return;let V=this.#G.add(z);switch(V.tryMatch(G).type){case H.COMPLETE:this.#_(G,V);break;case H.PARTIAL:this.#Y(V);break;case H.MISMATCH:this.#F(G,z);break}}#_(z,G){this.#W("RomajiMatched",{romaji:G.value,isPartial:!1}),this.#z=this.#z.advance(),this.#G=new Q,this.#W("CharacterCompleted",{character:z,duration:Date.now()-this.#V.getTime()}),this.#W("SpeechRequested",{text:z.kana});let V=this.#J();for(let Z of V)this.#W("CharacterCompleted",{character:Z,duration:Date.now()-this.#V.getTime(),skipped:!0});if(this.#z.isCompleted())this.#A()}#Y(z){this.#G=z,this.#W("RomajiMatched",{romaji:z.value,isPartial:!0})}#F(z,G){this.#X++,this.#W("CharacterMistaken",{expected:z.romaji,actual:G}),this.#G=new Q}#A(){let G=new Date().getTime()-this.#V.getTime(),V=this.#$-this.#X,Z=this.#$>0?V/this.#$:1;this.#W("SessionCompleted",{totalTime:G,accuracy:Z,totalKeystrokes:this.#$,mistakes:this.#X})}getCurrentCharacter(){return this.#z.getCurrentCharacter()}getHintRomaji(){let z=this.getCurrentCharacter();if(!z||z.romaji.length===0)return"";return z.romaji[0]}getProgress(){return this.#z.getProgress()}handleDirectInput(z){if(!z||this.#z.isCompleted())return{matchedCount:0,consumedLength:0};let G=0,V=0;while(V<z.length&&!this.#z.isCompleted()){let Z=this.#z.getCurrentCharacter();if(!Z)break;let{kana:$,display:W}=Z,X=z.substring(V),J=!1,A=0;if(X.startsWith(W))J=!0,A=W.length;else if(X.startsWith($))J=!0,A=$.length;if(J){this.#$++,this.#z=this.#z.advance(),this.#W("CharacterCompleted",{character:Z,duration:Date.now()-this.#V.getTime()}),this.#W("SpeechRequested",{text:Z.kana});let P=this.#J();for(let _ of P)this.#W("CharacterCompleted",{character:_,duration:Date.now()-this.#V.getTime(),skipped:!0});G++,V+=A}else break}if(this.#z.isCompleted())this.#A();return{matchedCount:G,consumedLength:V}}}class C{#z;#G;#V;constructor(z={}){this.#z=z.lang||"ja-JP",this.#G=z.rate||1,this.#V=z.speechSynthesis}get lang(){return this.#z}isSupported(){return this.#V!==void 0&&this.#V!==null}speak(z){return new Promise((G,V)=>{if(!this.isSupported()){G();return}let Z=this.#Z(z);Z.lang=this.#z,Z.rate=this.#G,Z.onend=()=>G(),Z.onerror=($)=>V($),this.#V.speak(Z)})}cancel(){if(this.isSupported())this.#V.cancel()}#Z(z){if(typeof SpeechSynthesisUtterance<"u")return new SpeechSynthesisUtterance(z);return{text:z,lang:"",rate:1,onend:null,onerror:null}}}var S=null;class K{#z;#G;#V;#Z;#$;#X;#J;#W;#_;#Y;constructor(z){let G;if(z.questionData)G=E.fromQuestionData(z.questionData),this.#$=z.questionData;else G=E.fromText(z.text),this.#$=null;this.#z=new q(G),this.#G=new C({speechSynthesis:typeof speechSynthesis<"u"?speechSynthesis:void 0}),this.#V=z.elements,this.#Z=z.keyboardRenderer,this.#X=z.onNextQuestion||null,this.#_=z.inputMode||"romaji";let Z=(typeof window<"u"?window.location.pathname:"").match(/^(.*?)\/[^\/]+\/?$/);if(this.#W=Z?Z[1]:"",this.#F(),this.#_==="direct")this.#H();else this.#A();this.#U()}#F(){this.#z.on("RomajiMatched",(z)=>{this.#E(z.romaji)}),this.#z.on("CharacterCompleted",(z)=>{this.#U(),this.#S()}),this.#z.on("SpeechRequested",(z)=>{this.#G.speak(z.text)}),this.#z.on("CharacterMistaken",(z)=>{this.#L(),this.#E("")}),this.#z.on("SessionCompleted",(z)=>{this.#T(z)})}#A(){if(S)document.removeEventListener("keydown",S);document.body.classList.remove("mode-direct");let z=document.querySelector(".practice-container");if(z)z.classList.remove("mode-direct");let G=document.getElementById("mobile-input-section");if(G)G.style.display="none";let V=document.getElementById("keyboard");if(V)V.style.display="";this.#J=(Z)=>{if(Z.ctrlKey||Z.altKey||Z.metaKey)return;if(Z.key.length!==1)return;Z.preventDefault();let $=Z.key.toLowerCase();this.#Z?.showKeyPress($),this.#z.handleKeyPress($)},document.addEventListener("keydown",this.#J),S=this.#J}#H(){if(S)document.removeEventListener("keydown",S),S=null;if(this.#Y=document.getElementById("mobile-kana-input"),!this.#Y){console.warn("Mobile input element not found");return}let z=document.getElementById("mobile-input-section");if(z)z.style.display="block";let G=document.getElementById("keyboard");if(G)G.style.display="none";let V=document.querySelector(".practice-container");if(V)V.classList.add("mode-direct");document.body.classList.add("mode-direct"),this.#Y.addEventListener("input",(Z)=>{this.#N(Z)}),this.#Y.addEventListener("compositionend",(Z)=>{this.#N(Z)}),setTimeout(()=>{this.#Y.focus()},100)}#N(z){let G=this.#Y.value;if(!G)return;let V=this.#z.handleDirectInput(G);if(V.matchedCount>0)this.#Y.value=G.substring(V.consumedLength),this.#U()}#U(){this.#Q(),this.#D(),this.#B()}#Q(){let z=this.#V.textContainer;if(!z)return;let G=this.#z.question.characters,V;if(this.#$)V=this.#$.characters.map(($,W)=>{let X=G[W];return`<span class="char ${X?`char-${X.state}`:"char-pending"}" data-index="${W}">${$.display}</span>`}).join("");else V=G.map((Z,$)=>{return`<span class="char ${`char-${Z.state}`}" data-index="${$}">${Z.kana}</span>`}).join("");z.innerHTML=V,this.#w()}#w(){let z=this.#V.textContainer;if(!z)return;let G=this.#z.question.currentIndex,V=z.querySelector(`[data-index="${G}"]`);if(V){let Z=z.parentElement?.getBoundingClientRect(),$=V.getBoundingClientRect();if(Z){let W=Z.width/3,X=V.offsetLeft,J=Math.max(0,X-W);z.style.transform=`translateX(-${J}px)`}}}#D(){let z=this.#V.romajiContainer;if(!z)return;let G=this.#z.question.characters;z.innerHTML=G.map((V,Z)=>{let $=`romaji-${V.state}`,W=V.romaji[0]||"";return`<span class="romaji ${$}" data-index="${Z}">${W}</span>`}).join(""),this.#O()}#O(){let z=this.#V.romajiContainer;if(!z)return;let G=this.#z.question.currentIndex,V=z.querySelector(`[data-index="${G}"]`);if(V){let Z=z.parentElement?.getBoundingClientRect();if(Z){let $=Z.width/3,W=V.offsetLeft,X=Math.max(0,W-$);z.style.transform=`translateX(-${X}px)`}}}#E(z){let G=this.#V.bufferDisplay;if(G)G.textContent=z}#B(){if(!this.#Z)return;let z=this.#z.getHintRomaji(),G=null;if(z){for(let V of z)if(/[a-z]/i.test(V)){G=V.toLowerCase();break}}this.#Z.highlightKey(G)}#S(){let z=this.#V.textContainer;if(!z)return;z.classList.add("flash-success"),setTimeout(()=>z.classList.remove("flash-success"),200)}#L(){let z=this.#V.textContainer;if(!z)return;z.classList.add("flash-error"),setTimeout(()=>z.classList.remove("flash-error"),200)}#T(z){let G=this.#V.resultContainer;if(!G)return;let V=Math.round(z.accuracy*100),Z=(z.totalTime/1000).toFixed(1),$="";if(this.#$?.source){let X=this.#$.source;$=`
        <a href="${this.#W+X.path}" class="source-link" target="_blank">
          查看來源卡片：${X.title} →
        </a>
      `}let W=this.#X?'<button class="next-btn" id="next-question-btn">下一題</button>':"";if(G.innerHTML=`
      <div class="result-box">
        <h2>完成！</h2>
        <div class="result-stats">
          <div class="stat">
            <span class="stat-value">${V}%</span>
            <span class="stat-label">準確率</span>
          </div>
          <div class="stat">
            <span class="stat-value">${Z}s</span>
            <span class="stat-label">時間</span>
          </div>
          <div class="stat">
            <span class="stat-value">${z.totalKeystrokes}</span>
            <span class="stat-label">按鍵數</span>
          </div>
        </div>
        ${$}
        <div class="result-actions">
          ${W}
          <button class="retry-btn" onclick="location.reload()">重新開始</button>
        </div>
      </div>
    `,G.style.display="flex",this.#X){let X=document.getElementById("next-question-btn");if(X)X.addEventListener("click",()=>{this.#X()})}}getProgress(){return this.#z.getProgress()}}class b{#z;#G;constructor(z){this.#z=z,this.#G=null}highlightKey(z){if(this.#G)this.#G.classList.remove("key-target");if(!z){this.#G=null;return}let G=this.#z.querySelector(`[data-key="${z}"]`);if(G)G.classList.add("key-target"),this.#G=G}showKeyPress(z){let G=this.#z.querySelector(`[data-key="${z}"]`);if(!G)return;G.classList.add("key-pressed"),setTimeout(()=>{G.classList.remove("key-pressed")},100)}clearHighlights(){this.#z.querySelectorAll(".key").forEach((G)=>{G.classList.remove("key-target","key-pressed")}),this.#G=null}}class v{constructor(z){if(!z){let V=window.location.pathname.match(/^(.*?)\/[^\/]+\/?$/);z=`${V?V[1]:""}/data/questions.json`}this.dataUrl=z,this.basePath=this.dataUrl.replace(/\/[^\/]+$/,""),this.questionBank=null,this.index=null,this.loadedBundles=new Set,this.loadingPromises=new Map,this.recentIds=new Set,this.maxRecentHistory=10,this.useProgressiveLoading=!1}async loadIndex(){if(this.index)return this.index;let z=`${this.basePath}/questions-index.json`;try{let G=await fetch(z);if(!G.ok)return null;return this.index=await G.json(),console.log(`索引檔載入完成: ${Object.keys(this.index.bundles).length} 個分包`),this.index}catch(G){return console.log("索引檔不存在，使用傳統載入模式"),null}}async loadInitial(){let z=await this.loadIndex();if(z)return this.useProgressiveLoading=!0,this.questionBank={version:z.version,generated:z.generated,questions:[],stats:z.stats},await this.loadBundle("init"),console.log(`初始載入完成: ${this.questionBank.questions.length} 題`),this.questionBank;return this.loadLegacy()}async loadBundle(z){if(this.loadedBundles.has(z))return;if(this.loadingPromises.has(z))return this.loadingPromises.get(z);if(!this.index)throw Error("索引檔尚未載入");let G=this.index.bundles[z];if(!G){console.warn(`分包不存在: ${z}`);return}let V=`${this.basePath}/${G.path}`,Z=(async()=>{try{let $=await fetch(V);if(!$.ok)throw Error(`載入分包失敗: ${$.status}`);let W=await $.json();this.mergeQuestions(W.questions),this.loadedBundles.add(z),console.log(`分包載入完成: ${z} (${W.questions.length} 題)`)}catch($){throw console.error(`載入分包 ${z} 失敗:`,$),$}finally{this.loadingPromises.delete(z)}})();return this.loadingPromises.set(z,Z),Z}mergeQuestions(z){if(!this.questionBank)return;let G=new Set(this.questionBank.questions.map((Z)=>Z.id)),V=z.filter((Z)=>!G.has(Z.id));this.questionBank.questions.push(...V)}async loadInBackground(z){for(let G of z)if(!this.loadedBundles.has(G)&&this.index?.bundles[G])try{await this.loadBundle(G)}catch(V){console.warn(`背景載入 ${G} 失敗，稍後重試`)}}isLevelLoaded(z){return this.loadedBundles.has(z)}getLoadingStatus(){let z=this.index?Object.keys(this.index.bundles).length:1;return{loadedBundles:[...this.loadedBundles],totalQuestions:this.questionBank?.questions.length||0,isFullyLoaded:this.loadedBundles.size>=z}}async loadLegacy(){try{let z=await fetch(this.dataUrl);if(!z.ok)throw Error(`載入題庫失敗: ${z.status} ${z.statusText}`);return this.questionBank=await z.json(),this.loadedBundles.add("legacy"),console.log(`題庫載入完成（傳統模式）: ${this.questionBank.questions.length} 題`),this.questionBank}catch(z){throw console.error("題庫載入錯誤:",z),z}}async load(){if(this.questionBank)return this.questionBank;return this.loadInitial()}isLoaded(){return this.questionBank!==null}getAllQuestions(){return this.questionBank?.questions||[]}filterQuestions(z={}){let G=this.getAllQuestions();if(z.jlpt&&z.jlpt!=="all")G=G.filter((V)=>V.source.jlpt===z.jlpt);if(z.category&&z.category!=="all")G=G.filter((V)=>V.source.category===z.category);if(z.difficulty&&z.difficulty!=="all")G=G.filter((V)=>V.metadata.difficulty===z.difficulty);return G}getRandomQuestion(z={}){let G=this.filterQuestions(z);if(G.length===0)return null;let V=G.filter((W)=>!this.recentIds.has(W.id));if(V.length===0)this.recentIds.clear(),V=G;let Z=Math.floor(Math.random()*V.length),$=V[Z];if(this.recentIds.add($.id),this.recentIds.size>this.maxRecentHistory){let W=this.recentIds.values().next().value;this.recentIds.delete(W)}return $}getQuestionById(z){return this.getAllQuestions().find((G)=>G.id===z)||null}getStats(){return this.questionBank?.stats||null}getJlptLevels(){let z=this.getStats();if(!z?.byJlpt)return["n5","n4","n3","n2","n1"];return Object.keys(z.byJlpt).sort()}getCategories(){let z=this.getStats();if(!z?.byCategory)return[];return Object.keys(z.byCategory).sort()}resetHistory(){this.recentIds.clear()}}var Rz=new v;var s=["あいうえお","かきくけこ","さしすせそ","たちつてと","なにぬねの","はひふへほ","まみむめも","やゆよ","らりるれろ","わをん","がぎぐげご","ざじずぜぞ","だぢづでど","ばびぶべぼ","ぱぴぷぺぽ","きゃきゅきょ","しゃしゅしょ","ちゃちゅちょ","こんにちは","ありがとう","おはよう","さようなら","いただきます","ごちそうさま"],Y=null,f=null,g=null,U={},w={jlpt:"all"},F="romaji",N=!0,D="question";function Zz(){let z=Math.floor(Math.random()*s.length);return s[z]}function k(){let z=U.textContainer;if(z)z.innerHTML='<span class="loading">載入題庫中...</span>'}function y(z){let G=U.textContainer;if(G)G.innerHTML=`
      <div class="error-message">
        <p>${z}</p>
        <button onclick="location.reload()">重新載入</button>
      </div>
    `}function $z(){let z=document.querySelector(".practice-container");if(!z)return;if(document.getElementById("practice-controls"))return;let G=document.createElement("div");G.id="practice-controls",G.className="practice-controls";let V=F==="romaji"?"手機模式":"鍵盤模式",Z=N?"隱藏提示":"顯示提示",$=D==="question"?"假名模式":"題庫模式";G.innerHTML=`
    <div class="control-group">
      <label for="jlpt-filter">JLPT 等級：</label>
      <select id="jlpt-filter">
        <option value="all">全部</option>
        <option value="n5">N5</option>
        <option value="n4">N4</option>
        <option value="n3">N3</option>
        <option value="n2">N2</option>
        <option value="n1">N1</option>
      </select>
    </div>
    <div class="control-group">
      <button id="btn-next" class="control-btn">下一題</button>
      <button id="btn-toggle-practice" class="control-btn secondary">${$}</button>
      <button id="btn-toggle-input" class="control-btn secondary">${V}</button>
      <button id="btn-toggle-hint" class="control-btn secondary">${Z}</button>
    </div>
  `;let W=z.querySelector(".practice-area")||z.firstChild;z.insertBefore(G,W);let X=document.getElementById("jlpt-filter");if(X){let R=localStorage.getItem("practice-jlpt-filter");if(R)X.value=R,w.jlpt=R;X.addEventListener("change",(x)=>{w.jlpt=x.target.value,localStorage.setItem("practice-jlpt-filter",x.target.value),L()})}let J=document.getElementById("btn-next");if(J)J.addEventListener("click",()=>{if(D==="kana")T();else L()});let A=document.getElementById("btn-toggle-practice");if(A)A.addEventListener("click",()=>{Wz()});let P=document.getElementById("btn-toggle-input");if(P)P.addEventListener("click",()=>{Xz()});let _=document.getElementById("btn-toggle-hint");if(_)_.addEventListener("click",()=>{Yz()})}function Wz(){if(D==="question")T();else _z()}function i(){let z=document.getElementById("btn-toggle-practice");if(z)z.textContent=D==="question"?"假名模式":"題庫模式"}function Xz(){F=F==="romaji"?"direct":"romaji",localStorage.setItem("practice-input-mode",F);let z=new URL(window.location);if(F==="direct")z.searchParams.set("input","direct");else z.searchParams.delete("input");window.history.replaceState({},"",z);let G=document.getElementById("btn-toggle-input");if(G)G.textContent=F==="romaji"?"手機模式":"鍵盤模式";if(D==="kana")T();else L()}function Yz(){N=!N,localStorage.setItem("practice-show-hint",N?"true":"false");let z=document.getElementById("btn-toggle-hint");if(z)z.textContent=N?"隱藏提示":"顯示提示";let G=document.querySelector(".practice-container");if(G)if(N)G.classList.remove("hide-romaji-hint");else G.classList.add("hide-romaji-hint")}function Jz(z){let G=["n5","n4","n3","n2","n1"];if(!z||z==="all")return G;return[z,...G.filter((V)=>V!==z)]}async function L(){if(!Y||!Y.isLoaded()){console.error("題庫尚未載入");return}if(U.resultContainer)U.resultContainer.style.display="none";let z=Y.getRandomQuestion(w);if(!z&&w.jlpt!=="all"){if(Y.useProgressiveLoading&&!Y.isLevelLoaded(w.jlpt)){k();try{await Y.loadBundle(w.jlpt),z=Y.getRandomQuestion(w)}catch(G){console.error("按需載入失敗:",G)}}}if(!z){y("找不到符合條件的題目");return}f=new K({questionData:z,elements:U,keyboardRenderer:g,onNextQuestion:L,inputMode:F}),console.log("載入題目:",z.id,z.text.substring(0,30)+"...")}function T(){if(D="kana",i(),U.resultContainer)U.resultContainer.style.display="none";let z=Zz();f=new K({text:z,elements:U,keyboardRenderer:g,onNextQuestion:T,inputMode:F}),console.log("假名模式:",z)}async function _z(){if(D="question",i(),!Y||!Y.isLoaded()){k();try{Y=new v,await Y.load(),console.log("題庫載入完成:",Y.getLoadingStatus())}catch(z){console.error("題庫載入失敗:",z),y("題庫載入失敗");return}}L()}async function o(){let z=document.getElementById("practice-text"),G=document.getElementById("practice-romaji"),V=document.getElementById("keyboard");if(!z||!G||!V){console.error("找不到必要的 DOM 元素");return}let Z=document.getElementById("result-container");if(!Z)Z=document.createElement("div"),Z.id="result-container",Z.className="result-container",Z.style.display="none",document.querySelector(".practice-container")?.appendChild(Z);let $=document.getElementById("buffer-display");if(!$)$=document.createElement("div"),$.id="buffer-display",$.className="buffer-display",G.parentNode?.insertBefore($,G.nextSibling);U={textContainer:z,romajiContainer:G,resultContainer:Z,bufferDisplay:$},g=new b(V);let W=new URLSearchParams(window.location.search),X=W.get("text"),J=W.get("mode"),A=W.get("input");if(A==="direct"||A==="mobile")F="direct";else if(localStorage.getItem("practice-input-mode")==="direct")F="direct";if(localStorage.getItem("practice-show-hint")==="false")N=!1;if($z(),!N){let _=document.querySelector(".practice-container");if(_)_.classList.add("hide-romaji-hint")}if(X){f=new K({text:X,elements:U,keyboardRenderer:g,inputMode:F}),console.log("URL 模式:",X);return}if(J==="kana"){T();return}k();try{if(Y=new v,await Y.load(),console.log("題庫載入完成:",Y.getLoadingStatus()),L(),Y.useProgressiveLoading){let _=localStorage.getItem("practice-jlpt-filter"),R=Jz(_);Y.loadInBackground(R).then(()=>{console.log("背景載入完成:",Y.getLoadingStatus())})}}catch(_){console.error("題庫載入失敗:",_),y("題庫載入失敗，切換到假名模式"),setTimeout(()=>{T()},2000)}}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",o);else o();
