var S={"あ":["a"],"い":["i"],"う":["u"],"え":["e"],"お":["o"],"ア":["a"],"イ":["i"],"ウ":["u"],"エ":["e"],"オ":["o"],"か":["ka"],"き":["ki"],"く":["ku"],"け":["ke"],"こ":["ko"],"カ":["ka"],"キ":["ki"],"ク":["ku"],"ケ":["ke"],"コ":["ko"],"さ":["sa"],"し":["si","shi"],"す":["su"],"せ":["se"],"そ":["so"],"サ":["sa"],"シ":["si","shi"],"ス":["su"],"セ":["se"],"ソ":["so"],"た":["ta"],"ち":["ti","chi"],"つ":["tu","tsu"],"て":["te"],"と":["to"],"タ":["ta"],"チ":["ti","chi"],"ツ":["tu","tsu"],"テ":["te"],"ト":["to"],"な":["na"],"に":["ni"],"ぬ":["nu"],"ね":["ne"],"の":["no"],"ナ":["na"],"ニ":["ni"],"ヌ":["nu"],"ネ":["ne"],"ノ":["no"],"は":["ha"],"ひ":["hi"],"ふ":["hu","fu"],"へ":["he"],"ほ":["ho"],"ハ":["ha"],"ヒ":["hi"],"フ":["hu","fu"],"ヘ":["he"],"ホ":["ho"],"ま":["ma"],"み":["mi"],"む":["mu"],"め":["me"],"も":["mo"],"マ":["ma"],"ミ":["mi"],"ム":["mu"],"メ":["me"],"モ":["mo"],"や":["ya"],"ゆ":["yu"],"よ":["yo"],"ヤ":["ya"],"ユ":["yu"],"ヨ":["yo"],"ら":["ra"],"り":["ri"],"る":["ru"],"れ":["re"],"ろ":["ro"],"ラ":["ra"],"リ":["ri"],"ル":["ru"],"レ":["re"],"ロ":["ro"],"わ":["wa"],"を":["wo"],"ん":["n","nn"],"ワ":["wa"],"ヲ":["wo"],"ン":["n","nn"],"が":["ga"],"ぎ":["gi"],"ぐ":["gu"],"げ":["ge"],"ご":["go"],"ガ":["ga"],"ギ":["gi"],"グ":["gu"],"ゲ":["ge"],"ゴ":["go"],"ざ":["za"],"じ":["zi","ji"],"ず":["zu"],"ぜ":["ze"],"ぞ":["zo"],"ザ":["za"],"ジ":["zi","ji"],"ズ":["zu"],"ゼ":["ze"],"ゾ":["zo"],"だ":["da"],"ぢ":["di"],"づ":["du","dzu"],"で":["de"],"ど":["do"],"ダ":["da"],"ヂ":["di"],"ヅ":["du","dzu"],"デ":["de"],"ド":["do"],"ば":["ba"],"び":["bi"],"ぶ":["bu"],"べ":["be"],"ぼ":["bo"],"バ":["ba"],"ビ":["bi"],"ブ":["bu"],"ベ":["be"],"ボ":["bo"],"ぱ":["pa"],"ぴ":["pi"],"ぷ":["pu"],"ぺ":["pe"],"ぽ":["po"],"パ":["pa"],"ピ":["pi"],"プ":["pu"],"ペ":["pe"],"ポ":["po"],"きゃ":["kya"],"きゅ":["kyu"],"きょ":["kyo"],"しゃ":["sya","sha"],"しゅ":["syu","shu"],"しょ":["syo","sho"],"ちゃ":["tya","cha"],"ちゅ":["tyu","chu"],"ちょ":["tyo","cho"],"にゃ":["nya"],"にゅ":["nyu"],"にょ":["nyo"],"ひゃ":["hya"],"ひゅ":["hyu"],"ひょ":["hyo"],"みゃ":["mya"],"みゅ":["myu"],"みょ":["myo"],"りゃ":["rya"],"りゅ":["ryu"],"りょ":["ryo"],"ぎゃ":["gya"],"ぎゅ":["gyu"],"ぎょ":["gyo"],"じゃ":["zya","ja","jya"],"じゅ":["zyu","ju","jyu"],"じょ":["zyo","jo","jyo"],"びゃ":["bya"],"びゅ":["byu"],"びょ":["byo"],"ぴゃ":["pya"],"ぴゅ":["pyu"],"ぴょ":["pyo"],"っ":["xtu","ltu","xtsu","ltsu"],"ッ":["xtu","ltu","xtsu","ltsu"],"ぁ":["xa","la"],"ぃ":["xi","li"],"ぅ":["xu","lu"],"ぇ":["xe","le"],"ぉ":["xo","lo"],"ゃ":["xya","lya"],"ゅ":["xyu","lyu"],"ょ":["xyo","lyo"],"、":[","],"。":["."],"？":["?"],"！":["!"],"「":["["],"」":["]"],"ー":["-"],"〜":["~"],"ティ":["thi","texi","teli"],"ディ":["dhi","dexi","deli"],"ファ":["fa","huxa","hula"],"フィ":["fi","huxi","huli"],"フェ":["fe","huxe","hule"],"フォ":["fo","huxo","hulo"],"ウィ":["wi","uxi","uli"],"ウェ":["we","uxe","ule"],"ウォ":["wo","uxo","ulo"],"ヴァ":["va","vuxa"],"ヴィ":["vi","vuxi"],"ヴ":["vu"],"ヴェ":["ve","vuxe"],"ヴォ":["vo","vuxo"],"ゐ":["wi"],"ヰ":["wi"],"ゑ":["we"],"ヱ":["we"]};function L(z){return S[z]||[]}function q(z,G){return G.some((V)=>V.startsWith(z))}function b(z,G){return G.includes(z)}var C=["っ","ッ"],l=["、","。","？","！","「","」","（","）","(",")","ー","〜","～","*"];function f(z){return l.includes(z)}function k(z){return C.includes(z)}function u(z){if(z.startsWith("ch"))return"c";if(z.startsWith("sh"))return"s";if(z.startsWith("ts"))return"t";if(z.startsWith("th"))return"t";if(z.startsWith("dh"))return"d";let G=z[0];return["a","i","u","e","o"].includes(G)?null:G}function K(z){return z.length>=2&&C.includes(z[0])}function y(z){if(!K(z))return[];let G=z.slice(1),V=L(G);if(V.length===0)return[];let Z=[];for(let W of V){let X=u(W);if(X)Z.push(X+W)}let $=["xtu","ltu"];for(let W of $)for(let X of V)Z.push(W+X);return Z}var E={PENDING:"pending",CURRENT:"current",COMPLETED:"completed"};class D{#z;#G;#V;constructor(z,G=E.PENDING,V=null){if(this.#z=z,V)this.#G=V;else if(K(z))this.#G=y(z);else this.#G=L(z);this.#V=G}get kana(){return this.#z}get romaji(){return this.#G}get state(){return this.#V}setCurrent(){return new D(this.#z,E.CURRENT,this.#G)}setCompleted(){return new D(this.#z,E.COMPLETED,this.#G)}matchesRomaji(z){return b(z,this.#G)}isPartialMatch(z){return q(z,this.#G)}isPunctuation(){return f(this.#z)}matchesKana(z){return this.#z===z}}var x=["きゃ","きゅ","きょ","しゃ","しゅ","しょ","ちゃ","ちゅ","ちょ","にゃ","にゅ","にょ","ひゃ","ひゅ","ひょ","みゃ","みゅ","みょ","りゃ","りゅ","りょ","ぎゃ","ぎゅ","ぎょ","じゃ","じゅ","じょ","びゃ","びゅ","びょ","ぴゃ","ぴゅ","ぴょ","キャ","キュ","キョ","シャ","シュ","ショ","チャ","チュ","チョ","ニャ","ニュ","ニョ","ヒャ","ヒュ","ヒョ","ミャ","ミュ","ミョ","リャ","リュ","リョ","ギャ","ギュ","ギョ","ジャ","ジュ","ジョ","ビャ","ビュ","ビョ","ピャ","ピュ","ピョ","ティ","ディ","ファ","フィ","フェ","フォ","ウィ","ウェ","ウォ","ヴァ","ヴィ","ヴェ","ヴォ"];function o(z,G){if(G>=z.length)return null;if(G+1<z.length){let V=z.slice(G,G+2);if(x.includes(V)||S[V])return V}return z[G]}function s(z){let G=L(z);if(G.length===0)return!1;let V=["a","i","u","e","o"];return G.some((Z)=>!V.includes(Z[0]))}function i(z){let G=[],V=0;while(V<z.length){if(k(z[V])&&V+1<z.length){let Z=o(z,V+1);if(Z&&s(Z)){G.push(z[V]+Z),V+=1+Z.length;continue}}if(V+1<z.length){let Z=z.slice(V,V+2);if(x.includes(Z)||S[Z]){G.push(Z),V+=2;continue}}G.push(z[V]),V+=1}return G}var a=["な","に","ぬ","ね","の","にゃ","にゅ","にょ","あ","い","う","え","お","や","ゆ","よ","ナ","ニ","ヌ","ネ","ノ","ニャ","ニュ","ニョ","ア","イ","ウ","エ","オ","ヤ","ユ","ヨ"];function n(z){return z==="ん"||z==="ン"}function r(z){return a.includes(z)}class w{#z;#G;#V;constructor(z,G,V=0){this.#z=z,this.#G=G,this.#V=V}static fromText(z){let V=i(z).map((Z,$,W)=>{let X=null;if(n(Z))if($===W.length-1)X=["n","nn"];else{let H=W[$+1];if(r(H))X=["nn","n'"]}let J=new D(Z,E.PENDING,X);return $===0?J.setCurrent():J});return new w(z,V,0)}static fromQuestionData(z){let G=z.characters.map((Z,$)=>{let W=new D(Z.kana,E.PENDING,Z.romaji);return $===0?W.setCurrent():W}),V=new w(z.text,G,0);return V._id=z.id,V._displayCharacters=z.characters,V._source=z.source,V._metadata=z.metadata,V}get id(){return this._id}get displayCharacters(){return this._displayCharacters}get source(){return this._source}get metadata(){return this._metadata}get text(){return this.#z}get characters(){return this.#G}get currentIndex(){return this.#V}getCurrentCharacter(){if(this.#V>=this.#G.length)return null;return this.#G[this.#V]}advance(){if(this.isCompleted())return this;let z=this.#G.map((G,V)=>{if(V===this.#V)return G.setCompleted();else if(V===this.#V+1)return G.setCurrent();return G});return new w(this.#z,z,this.#V+1)}isCompleted(){return this.#V>=this.#G.length}getProgress(){if(this.#G.length===0)return 1;return this.#V/this.#G.length}}var N={COMPLETE:"COMPLETE",PARTIAL:"PARTIAL",MISMATCH:"MISMATCH"};class U{#z;constructor(z=""){this.#z=z}get value(){return this.#z}get length(){return this.#z.length}isEmpty(){return this.#z.length===0}add(z){return new U(this.#z+z)}reset(){return new U}tryMatch(z){if(z.matchesRomaji(this.#z))return{type:N.COMPLETE};if(z.isPartialMatch(this.#z))return{type:N.PARTIAL};return{type:N.MISMATCH}}}class g{#z;#G;#V;#W;#Z;#X;constructor(z){this.#z=z,this.#G=new U,this.#V=new Date,this.#W=new Map,this.#Z=0,this.#X=0,this.#J()}#J(){let z=[];while(!this.#z.isCompleted()){let G=this.#z.getCurrentCharacter();if(!G||!G.isPunctuation())break;z.push(G),this.#z=this.#z.advance()}return z}get question(){return this.#z}get startTime(){return this.#V}get inputBuffer(){return this.#G}on(z,G){if(!this.#W.has(z))this.#W.set(z,[]);this.#W.get(z).push(G)}#$(z,G){let V=this.#W.get(z);if(V)V.forEach((Z)=>Z(G))}handleKeyPress(z){if(this.#z.isCompleted())return;this.#Z++,this.#$("KeyPressed",{key:z,timestamp:Date.now()});let G=this.#z.getCurrentCharacter();if(!G)return;let V=this.#G.add(z);switch(V.tryMatch(G).type){case N.COMPLETE:this.#_(G,V);break;case N.PARTIAL:this.#Y(V);break;case N.MISMATCH:this.#H(G,z);break}}#_(z,G){this.#$("RomajiMatched",{romaji:G.value,isPartial:!1}),this.#z=this.#z.advance(),this.#G=new U,this.#$("CharacterCompleted",{character:z,duration:Date.now()-this.#V.getTime()}),this.#$("SpeechRequested",{text:z.kana});let V=this.#J();for(let Z of V)this.#$("CharacterCompleted",{character:Z,duration:Date.now()-this.#V.getTime(),skipped:!0});if(this.#z.isCompleted())this.#A()}#Y(z){this.#G=z,this.#$("RomajiMatched",{romaji:z.value,isPartial:!0})}#H(z,G){this.#X++,this.#$("CharacterMistaken",{expected:z.romaji,actual:G}),this.#G=new U}#A(){let G=new Date().getTime()-this.#V.getTime(),V=this.#Z-this.#X,Z=this.#Z>0?V/this.#Z:1;this.#$("SessionCompleted",{totalTime:G,accuracy:Z,totalKeystrokes:this.#Z,mistakes:this.#X})}getCurrentCharacter(){return this.#z.getCurrentCharacter()}getHintRomaji(){let z=this.getCurrentCharacter();if(!z||z.romaji.length===0)return"";return z.romaji[0]}getProgress(){return this.#z.getProgress()}handleDirectInput(z){if(!z||this.#z.isCompleted())return{matchedCount:0,consumedLength:0};let G=0,V=0;while(V<z.length&&!this.#z.isCompleted()){let Z=this.#z.getCurrentCharacter();if(!Z)break;let $=Z.kana;if(z.substring(V).startsWith($)){this.#Z++,this.#z=this.#z.advance(),this.#$("CharacterCompleted",{character:Z,duration:Date.now()-this.#V.getTime()}),this.#$("SpeechRequested",{text:Z.kana});let W=this.#J();for(let X of W)this.#$("CharacterCompleted",{character:X,duration:Date.now()-this.#V.getTime(),skipped:!0});G++,V+=$.length}else{this.#Z++,this.#X++,this.#$("CharacterMistaken",{expected:Z.kana,actual:z.substring(V,V+1)});break}}if(this.#z.isCompleted())this.#A();return{matchedCount:G,consumedLength:V}}}class I{#z;#G;#V;constructor(z={}){this.#z=z.lang||"ja-JP",this.#G=z.rate||1,this.#V=z.speechSynthesis}get lang(){return this.#z}isSupported(){return this.#V!==void 0&&this.#V!==null}speak(z){return new Promise((G,V)=>{if(!this.isSupported()){G();return}let Z=this.#W(z);Z.lang=this.#z,Z.rate=this.#G,Z.onend=()=>G(),Z.onerror=($)=>V($),this.#V.speak(Z)})}cancel(){if(this.isSupported())this.#V.cancel()}#W(z){if(typeof SpeechSynthesisUtterance!=="undefined")return new SpeechSynthesisUtterance(z);return{text:z,lang:"",rate:1,onend:null,onerror:null}}}var B=null;class O{#z;#G;#V;#W;#Z;#X;#J;#$;#_;#Y;constructor(z){let G;if(z.questionData)G=w.fromQuestionData(z.questionData),this.#Z=z.questionData;else G=w.fromText(z.text),this.#Z=null;this.#z=new g(G),this.#G=new I({speechSynthesis:typeof speechSynthesis!=="undefined"?speechSynthesis:void 0}),this.#V=z.elements,this.#W=z.keyboardRenderer,this.#X=z.onNextQuestion||null,this.#_=z.inputMode||"romaji";let Z=(typeof window!=="undefined"?window.location.pathname:"").match(/^(.*?)\/[^\/]+\/?$/);if(this.#$=Z?Z[1]:"",this.#H(),this.#_==="direct")this.#U();else this.#A();this.#F()}#H(){this.#z.on("RomajiMatched",(z)=>{this.#N(z.romaji)}),this.#z.on("CharacterCompleted",(z)=>{this.#F(),this.#O()}),this.#z.on("SpeechRequested",(z)=>{this.#G.speak(z.text)}),this.#z.on("CharacterMistaken",(z)=>{this.#P(),this.#N("")}),this.#z.on("SessionCompleted",(z)=>{this.#S(z)})}#A(){if(B)document.removeEventListener("keydown",B);this.#J=(z)=>{if(z.ctrlKey||z.altKey||z.metaKey)return;if(z.key.length!==1)return;z.preventDefault();let G=z.key.toLowerCase();this.#W?.showKeyPress(G),this.#z.handleKeyPress(G)},document.addEventListener("keydown",this.#J),B=this.#J}#U(){if(B)document.removeEventListener("keydown",B),B=null;if(this.#Y=document.getElementById("mobile-kana-input"),!this.#Y){console.warn("Mobile input element not found");return}let z=document.getElementById("mobile-input-section");if(z)z.style.display="block";let G=document.getElementById("keyboard");if(G)G.style.display="none";let V=document.querySelector(".practice-container");if(V)V.classList.add("mode-direct");this.#Y.addEventListener("input",(Z)=>{this.#w(Z)}),this.#Y.addEventListener("compositionend",(Z)=>{this.#w(Z)}),setTimeout(()=>{this.#Y.focus()},100)}#w(z){let G=this.#Y.value;if(!G)return;let V=this.#z.handleDirectInput(G);if(V.matchedCount>0)this.#Y.value=G.substring(V.consumedLength),this.#F()}#F(){this.#Q(),this.#D(),this.#L()}#Q(){let z=this.#V.textContainer;if(!z)return;let G=this.#z.question.characters,V;if(this.#Z)V=this.#Z.characters.map(($,W)=>{let X=G[W];return`<span class="char ${X?`char-${X.state}`:"char-pending"}" data-index="${W}">${$.display}</span>`}).join("");else V=G.map((Z,$)=>{return`<span class="char ${`char-${Z.state}`}" data-index="${$}">${Z.kana}</span>`}).join("");z.innerHTML=V,this.#E()}#E(){let z=this.#V.textContainer;if(!z)return;let G=this.#z.question.currentIndex,V=z.querySelector(`[data-index="${G}"]`);if(V){let Z=z.parentElement?.getBoundingClientRect(),$=V.getBoundingClientRect();if(Z){let W=Z.width/3,X=V.offsetLeft,J=Math.max(0,X-W);z.style.transform=`translateX(-${J}px)`}}}#D(){let z=this.#V.romajiContainer;if(!z)return;let G=this.#z.question.characters;z.innerHTML=G.map((V,Z)=>{let $=`romaji-${V.state}`,W=V.romaji[0]||"";return`<span class="romaji ${$}" data-index="${Z}">${W}</span>`}).join(""),this.#B()}#B(){let z=this.#V.romajiContainer;if(!z)return;let G=this.#z.question.currentIndex,V=z.querySelector(`[data-index="${G}"]`);if(V){let Z=z.parentElement?.getBoundingClientRect();if(Z){let $=Z.width/3,W=V.offsetLeft,X=Math.max(0,W-$);z.style.transform=`translateX(-${X}px)`}}}#N(z){let G=this.#V.bufferDisplay;if(G)G.textContent=z}#L(){if(!this.#W)return;let z=this.#z.getHintRomaji(),G=null;if(z){for(let V of z)if(/[a-z]/i.test(V)){G=V.toLowerCase();break}}this.#W.highlightKey(G)}#O(){let z=this.#V.textContainer;if(!z)return;z.classList.add("flash-success"),setTimeout(()=>z.classList.remove("flash-success"),200)}#P(){let z=this.#V.textContainer;if(!z)return;z.classList.add("flash-error"),setTimeout(()=>z.classList.remove("flash-error"),200)}#S(z){let G=this.#V.resultContainer;if(!G)return;let V=Math.round(z.accuracy*100),Z=(z.totalTime/1000).toFixed(1),$="";if(this.#Z?.source){let X=this.#Z.source;$=`
        <a href="${this.#$+X.path}" class="source-link" target="_blank">
          查看來源卡片：${X.title} →
        </a>
      `}let W=this.#X?'<button class="next-btn" id="next-question-btn">下一題</button>':"";if(G.innerHTML=`
      <div class="result-box">
        <h2>完成！</h2>
        <div class="result-stats">
          <div class="stat">
            <span class="stat-value">${V}%</span>
            <span class="stat-label">準確率</span>
          </div>
          <div class="stat">
            <span class="stat-value">${Z}s</span>
            <span class="stat-label">時間</span>
          </div>
          <div class="stat">
            <span class="stat-value">${z.totalKeystrokes}</span>
            <span class="stat-label">按鍵數</span>
          </div>
        </div>
        ${$}
        <div class="result-actions">
          ${W}
          <button class="retry-btn" onclick="location.reload()">重新開始</button>
        </div>
      </div>
    `,G.style.display="flex",this.#X){let X=document.getElementById("next-question-btn");if(X)X.addEventListener("click",()=>{this.#X()})}}getProgress(){return this.#z.getProgress()}}class v{#z;#G;constructor(z){this.#z=z,this.#G=null}highlightKey(z){if(this.#G)this.#G.classList.remove("key-target");if(!z){this.#G=null;return}let G=this.#z.querySelector(`[data-key="${z}"]`);if(G)G.classList.add("key-target"),this.#G=G}showKeyPress(z){let G=this.#z.querySelector(`[data-key="${z}"]`);if(!G)return;G.classList.add("key-pressed"),setTimeout(()=>{G.classList.remove("key-pressed")},100)}clearHighlights(){this.#z.querySelectorAll(".key").forEach((G)=>{G.classList.remove("key-target","key-pressed")}),this.#G=null}}class R{constructor(z){if(!z){let V=window.location.pathname.match(/^(.*?)\/[^\/]+\/?$/);z=`${V?V[1]:""}/data/questions.json`}this.dataUrl=z,this.basePath=this.dataUrl.replace(/\/[^\/]+$/,""),this.questionBank=null,this.index=null,this.loadedBundles=new Set,this.loadingPromises=new Map,this.recentIds=new Set,this.maxRecentHistory=10,this.useProgressiveLoading=!1}async loadIndex(){if(this.index)return this.index;let z=`${this.basePath}/questions-index.json`;try{let G=await fetch(z);if(!G.ok)return null;return this.index=await G.json(),console.log(`索引檔載入完成: ${Object.keys(this.index.bundles).length} 個分包`),this.index}catch(G){return console.log("索引檔不存在，使用傳統載入模式"),null}}async loadInitial(){let z=await this.loadIndex();if(z)return this.useProgressiveLoading=!0,this.questionBank={version:z.version,generated:z.generated,questions:[],stats:z.stats},await this.loadBundle("init"),console.log(`初始載入完成: ${this.questionBank.questions.length} 題`),this.questionBank;return this.loadLegacy()}async loadBundle(z){if(this.loadedBundles.has(z))return;if(this.loadingPromises.has(z))return this.loadingPromises.get(z);if(!this.index)throw new Error("索引檔尚未載入");let G=this.index.bundles[z];if(!G){console.warn(`分包不存在: ${z}`);return}let V=`${this.basePath}/${G.path}`,Z=(async()=>{try{let $=await fetch(V);if(!$.ok)throw new Error(`載入分包失敗: ${$.status}`);let W=await $.json();this.mergeQuestions(W.questions),this.loadedBundles.add(z),console.log(`分包載入完成: ${z} (${W.questions.length} 題)`)}catch($){throw console.error(`載入分包 ${z} 失敗:`,$),$}finally{this.loadingPromises.delete(z)}})();return this.loadingPromises.set(z,Z),Z}mergeQuestions(z){if(!this.questionBank)return;let G=new Set(this.questionBank.questions.map((Z)=>Z.id)),V=z.filter((Z)=>!G.has(Z.id));this.questionBank.questions.push(...V)}async loadInBackground(z){for(let G of z)if(!this.loadedBundles.has(G)&&this.index?.bundles[G])try{await this.loadBundle(G)}catch(V){console.warn(`背景載入 ${G} 失敗，稍後重試`)}}isLevelLoaded(z){return this.loadedBundles.has(z)}getLoadingStatus(){let z=this.index?Object.keys(this.index.bundles).length:1;return{loadedBundles:[...this.loadedBundles],totalQuestions:this.questionBank?.questions.length||0,isFullyLoaded:this.loadedBundles.size>=z}}async loadLegacy(){try{let z=await fetch(this.dataUrl);if(!z.ok)throw new Error(`載入題庫失敗: ${z.status} ${z.statusText}`);return this.questionBank=await z.json(),this.loadedBundles.add("legacy"),console.log(`題庫載入完成（傳統模式）: ${this.questionBank.questions.length} 題`),this.questionBank}catch(z){throw console.error("題庫載入錯誤:",z),z}}async load(){if(this.questionBank)return this.questionBank;return this.loadInitial()}isLoaded(){return this.questionBank!==null}getAllQuestions(){return this.questionBank?.questions||[]}filterQuestions(z={}){let G=this.getAllQuestions();if(z.jlpt&&z.jlpt!=="all")G=G.filter((V)=>V.source.jlpt===z.jlpt);if(z.category&&z.category!=="all")G=G.filter((V)=>V.source.category===z.category);if(z.difficulty&&z.difficulty!=="all")G=G.filter((V)=>V.metadata.difficulty===z.difficulty);return G}getRandomQuestion(z={}){let G=this.filterQuestions(z);if(G.length===0)return null;let V=G.filter((W)=>!this.recentIds.has(W.id));if(V.length===0)this.recentIds.clear(),V=G;let Z=Math.floor(Math.random()*V.length),$=V[Z];if(this.recentIds.add($.id),this.recentIds.size>this.maxRecentHistory){let W=this.recentIds.values().next().value;this.recentIds.delete(W)}return $}getQuestionById(z){return this.getAllQuestions().find((G)=>G.id===z)||null}getStats(){return this.questionBank?.stats||null}getJlptLevels(){let z=this.getStats();if(!z?.byJlpt)return["n5","n4","n3","n2","n1"];return Object.keys(z.byJlpt).sort()}getCategories(){let z=this.getStats();if(!z?.byCategory)return[];return Object.keys(z.byCategory).sort()}resetHistory(){this.recentIds.clear()}}var Ez=new R;var m=["あいうえお","かきくけこ","さしすせそ","たちつてと","なにぬねの","はひふへほ","まみむめも","やゆよ","らりるれろ","わをん","がぎぐげご","ざじずぜぞ","だぢづでど","ばびぶべぼ","ぱぴぷぺぽ","きゃきゅきょ","しゃしゅしょ","ちゃちゅちょ","こんにちは","ありがとう","おはよう","さようなら","いただきます","ごちそうさま"],Y=null,j=null,M=null,A={},Q={jlpt:"all"},_="romaji";function t(){let z=Math.floor(Math.random()*m.length);return m[z]}function p(){let z=A.textContainer;if(z)z.innerHTML='<span class="loading">載入題庫中...</span>'}function d(z){let G=A.textContainer;if(G)G.innerHTML=`
      <div class="error-message">
        <p>${z}</p>
        <button onclick="location.reload()">重新載入</button>
      </div>
    `}function e(){let z=document.querySelector(".practice-container");if(!z)return;if(document.getElementById("practice-controls"))return;let G=document.createElement("div");G.id="practice-controls",G.className="practice-controls";let V=_==="romaji"?"手機模式":"鍵盤模式";G.innerHTML=`
    <div class="control-group">
      <label for="jlpt-filter">JLPT 等級：</label>
      <select id="jlpt-filter">
        <option value="all">全部</option>
        <option value="n5">N5</option>
        <option value="n4">N4</option>
        <option value="n3">N3</option>
        <option value="n2">N2</option>
        <option value="n1">N1</option>
      </select>
    </div>
    <div class="control-group">
      <button id="btn-next" class="control-btn">下一題</button>
      <button id="btn-kana-mode" class="control-btn secondary">假名模式</button>
      <button id="btn-toggle-input" class="control-btn secondary">${V}</button>
    </div>
  `;let Z=z.querySelector(".practice-area")||z.firstChild;z.insertBefore(G,Z);let $=document.getElementById("jlpt-filter");if($){let H=localStorage.getItem("practice-jlpt-filter");if(H)$.value=H,Q.jlpt=H;$.addEventListener("change",(F)=>{Q.jlpt=F.target.value,localStorage.setItem("practice-jlpt-filter",F.target.value),P()})}let W=document.getElementById("btn-next");if(W)W.addEventListener("click",P);let X=document.getElementById("btn-kana-mode");if(X)X.addEventListener("click",()=>{T()});let J=document.getElementById("btn-toggle-input");if(J)J.addEventListener("click",()=>{zz()})}function zz(){_=_==="romaji"?"direct":"romaji",localStorage.setItem("practice-input-mode",_);let z=new URL(window.location);if(_==="direct")z.searchParams.set("input","direct");else z.searchParams.delete("input");window.history.replaceState({},"",z);let G=document.getElementById("btn-toggle-input");if(G)G.textContent=_==="romaji"?"手機模式":"鍵盤模式";P()}function Gz(z){let G=["n5","n4","n3","n2","n1"];if(!z||z==="all")return G;return[z,...G.filter((V)=>V!==z)]}async function P(){if(!Y||!Y.isLoaded()){console.error("題庫尚未載入");return}if(A.resultContainer)A.resultContainer.style.display="none";let z=Y.getRandomQuestion(Q);if(!z&&Q.jlpt!=="all"){if(Y.useProgressiveLoading&&!Y.isLevelLoaded(Q.jlpt)){p();try{await Y.loadBundle(Q.jlpt),z=Y.getRandomQuestion(Q)}catch(G){console.error("按需載入失敗:",G)}}}if(!z){d("找不到符合條件的題目");return}j=new O({questionData:z,elements:A,keyboardRenderer:M,onNextQuestion:P,inputMode:_}),console.log("載入題目:",z.id,z.text.substring(0,30)+"...")}function T(){if(A.resultContainer)A.resultContainer.style.display="none";let z=t();j=new O({text:z,elements:A,keyboardRenderer:M,onNextQuestion:T,inputMode:_}),console.log("假名模式:",z)}async function h(){let z=document.getElementById("practice-text"),G=document.getElementById("practice-romaji"),V=document.getElementById("keyboard");if(!z||!G||!V){console.error("找不到必要的 DOM 元素");return}let Z=document.getElementById("result-container");if(!Z)Z=document.createElement("div"),Z.id="result-container",Z.className="result-container",Z.style.display="none",document.querySelector(".practice-container")?.appendChild(Z);let $=document.getElementById("buffer-display");if(!$)$=document.createElement("div"),$.id="buffer-display",$.className="buffer-display",G.parentNode?.insertBefore($,G.nextSibling);A={textContainer:z,romajiContainer:G,resultContainer:Z,bufferDisplay:$},M=new v(V);let W=new URLSearchParams(window.location.search),X=W.get("text"),J=W.get("mode"),H=W.get("input");if(H==="direct"||H==="mobile")_="direct";else if(localStorage.getItem("practice-input-mode")==="direct")_="direct";if(e(),X){j=new O({text:X,elements:A,keyboardRenderer:M,inputMode:_}),console.log("URL 模式:",X);return}if(J==="kana"){T();return}p();try{if(Y=new R,await Y.load(),console.log("題庫載入完成:",Y.getLoadingStatus()),P(),Y.useProgressiveLoading){let F=localStorage.getItem("practice-jlpt-filter"),c=Gz(F);Y.loadInBackground(c).then(()=>{console.log("背景載入完成:",Y.getLoadingStatus())})}}catch(F){console.error("題庫載入失敗:",F),d("題庫載入失敗，切換到假名模式"),setTimeout(()=>{T()},2000)}}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",h);else h();
