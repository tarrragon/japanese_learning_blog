(()=>{var{defineProperty:y,getOwnPropertyNames:R8,getOwnPropertyDescriptor:A8}=Object,q8=Object.prototype.hasOwnProperty;var Y8=new WeakMap,j8=(z)=>{var J=Y8.get(z),W;if(J)return J;if(J=y({},"__esModule",{value:!0}),z&&typeof z==="object"||typeof z==="function")R8(z).map((Z)=>!q8.call(J,Z)&&y(J,Z,{get:()=>z[Z],enumerable:!(W=A8(z,Z))||W.enumerable}));return Y8.set(z,J),J};var m=(z,J)=>{for(var W in J)y(z,W,{get:J[W],enumerable:!0,configurable:!0,set:(Z)=>J[W]=()=>Z})};var O=(z,J)=>()=>(z&&(J=z(z=0)),J);var N;var C=O(()=>{N={KEY_PRESSED:"KeyPressed",ROMAJI_MATCHED:"RomajiMatched",CHARACTER_COMPLETED:"CharacterCompleted",CHARACTER_MISTAKEN:"CharacterMistaken",SPEECH_REQUESTED:"SpeechRequested",SESSION_COMPLETED:"SessionCompleted"}});class L{#z;constructor(z=""){this.#z=z}get value(){return this.#z}get length(){return this.#z.length}isEmpty(){return this.#z.length===0}add(z){return new L(this.#z+z)}reset(){return new L}tryMatch(z){if(z.matchesRomaji(this.#z))return{type:D.COMPLETE};if(z.isPartialMatch(this.#z))return{type:D.PARTIAL};return{type:D.MISMATCH}}}var D;var Q8=O(()=>{D={COMPLETE:"COMPLETE",PARTIAL:"PARTIAL",MISMATCH:"MISMATCH"}});var N8={};m(N8,{TypingSession:()=>S});class S{#z;#J;#W;#Z;#$;#V;constructor(z){this.#z=z,this.#J=new L,this.#W=new Date,this.#Z=new Map,this.#$=0,this.#V=0,this.#F()}#F(){let z=[];while(!this.#z.isCompleted()){let J=this.#z.getCurrentCharacter();if(!J||!J.isPunctuation())break;z.push(J),this.#z=this.#z.advance()}return z}get question(){return this.#z}get startTime(){return this.#W}get inputBuffer(){return this.#J}on(z,J){if(!this.#Z.has(z))this.#Z.set(z,[]);return this.#Z.get(z).push(J),()=>{let W=this.#Z.get(z);if(W){let Z=W.indexOf(J);if(Z>-1)W.splice(Z,1)}}}#X(z,J){let W=this.#Z.get(z);if(W)W.forEach((Z)=>Z(J))}handleKeyPress(z){if(this.#z.isCompleted())return;this.#$++,this.#X(N.KEY_PRESSED,{key:z,timestamp:Date.now()});let J=this.#z.getCurrentCharacter();if(!J)return;let W=this.#J.add(z);switch(W.tryMatch(J).type){case D.COMPLETE:this.#N(J,W);break;case D.PARTIAL:this.#Y(W);break;case D.MISMATCH:this.#w(J,z);break}}#N(z,J){this.#X(N.ROMAJI_MATCHED,{romaji:J.value,isPartial:!1}),this.#z=this.#z.advance(),this.#J=new L,this.#X(N.CHARACTER_COMPLETED,{character:z,duration:Date.now()-this.#W.getTime()}),this.#X(N.SPEECH_REQUESTED,{text:z.kana});let W=this.#F();for(let Z of W)this.#X(N.CHARACTER_COMPLETED,{character:Z,duration:Date.now()-this.#W.getTime(),skipped:!0});if(this.#z.isCompleted())this.#Q()}#Y(z){this.#J=z,this.#X(N.ROMAJI_MATCHED,{romaji:z.value,isPartial:!0})}#w(z,J){this.#V++,this.#X(N.CHARACTER_MISTAKEN,{expected:z.romaji,actual:J}),this.#J=new L}#Q(){let J=new Date().getTime()-this.#W.getTime(),W=this.#$-this.#V,Z=this.#$>0?W/this.#$:1;this.#X(N.SESSION_COMPLETED,{totalTime:J,accuracy:Z,totalKeystrokes:this.#$,mistakes:this.#V})}getCurrentCharacter(){return this.#z.getCurrentCharacter()}getHintRomaji(){let z=this.getCurrentCharacter();if(!z||z.romaji.length===0)return"";return z.romaji[0]}getProgress(){return this.#z.getProgress()}handleDirectInput(z){if(!z||this.#z.isCompleted())return{matchedCount:0,consumedLength:0};let J=0,W=0;while(W<z.length&&!this.#z.isCompleted()){let Z=this.#z.getCurrentCharacter();if(!Z)break;let{kana:$,display:X}=Z,Y=z.substring(W),w=!1,_=0;if(Y.startsWith(X))w=!0,_=X.length;else if(Y.startsWith($))w=!0,_=$.length;if(w){this.#$++,this.#z=this.#z.advance(),this.#X(N.CHARACTER_COMPLETED,{character:Z,duration:Date.now()-this.#W.getTime()}),this.#X(N.SPEECH_REQUESTED,{text:Z.kana});let G=this.#F();for(let P of G)this.#X(N.CHARACTER_COMPLETED,{character:P,duration:Date.now()-this.#W.getTime(),skipped:!0});J++,W+=_}else break}if(this.#z.isCompleted())this.#Q();return{matchedCount:J,consumedLength:W}}}var u=O(()=>{Q8();C()});function v(z){return T[z]||[]}function w8(z,J){return J.some((W)=>W.startsWith(z))}function _8(z,J){return J.includes(z)}function B8(z){return C8.includes(z)}function H8(z){return G8.includes(z)}function v8(z){if(z.startsWith("ch"))return"c";if(z.startsWith("sh"))return"s";if(z.startsWith("ts"))return"t";if(z.startsWith("th"))return"t";if(z.startsWith("dh"))return"d";let J=z[0];return["a","i","u","e","o"].includes(J)?null:J}function c(z){return z.length>=2&&G8.includes(z[0])}function D8(z){if(!c(z))return[];let J=z.slice(1),W=v(J);if(W.length===0)return[];let Z=[];for(let X of W){let Y=v8(X);if(Y)Z.push(Y+X)}let $=["xtu","ltu"];for(let X of $)for(let Y of W)Z.push(X+Y);return Z}var T,G8,C8;var o=O(()=>{T={"あ":["a"],"い":["i"],"う":["u"],"え":["e"],"お":["o"],"ア":["a"],"イ":["i"],"ウ":["u"],"エ":["e"],"オ":["o"],"か":["ka"],"き":["ki"],"く":["ku"],"け":["ke"],"こ":["ko"],"カ":["ka"],"キ":["ki"],"ク":["ku"],"ケ":["ke"],"コ":["ko"],"さ":["sa"],"し":["si","shi"],"す":["su"],"せ":["se"],"そ":["so"],"サ":["sa"],"シ":["si","shi"],"ス":["su"],"セ":["se"],"ソ":["so"],"た":["ta"],"ち":["ti","chi"],"つ":["tu","tsu"],"て":["te"],"と":["to"],"タ":["ta"],"チ":["ti","chi"],"ツ":["tu","tsu"],"テ":["te"],"ト":["to"],"な":["na"],"に":["ni"],"ぬ":["nu"],"ね":["ne"],"の":["no"],"ナ":["na"],"ニ":["ni"],"ヌ":["nu"],"ネ":["ne"],"ノ":["no"],"は":["ha"],"ひ":["hi"],"ふ":["hu","fu"],"へ":["he"],"ほ":["ho"],"ハ":["ha"],"ヒ":["hi"],"フ":["hu","fu"],"ヘ":["he"],"ホ":["ho"],"ま":["ma"],"み":["mi"],"む":["mu"],"め":["me"],"も":["mo"],"マ":["ma"],"ミ":["mi"],"ム":["mu"],"メ":["me"],"モ":["mo"],"や":["ya"],"ゆ":["yu"],"よ":["yo"],"ヤ":["ya"],"ユ":["yu"],"ヨ":["yo"],"ら":["ra"],"り":["ri"],"る":["ru"],"れ":["re"],"ろ":["ro"],"ラ":["ra"],"リ":["ri"],"ル":["ru"],"レ":["re"],"ロ":["ro"],"わ":["wa"],"を":["wo"],"ん":["nn","n"],"ワ":["wa"],"ヲ":["wo"],"ン":["nn","n"],"が":["ga"],"ぎ":["gi"],"ぐ":["gu"],"げ":["ge"],"ご":["go"],"ガ":["ga"],"ギ":["gi"],"グ":["gu"],"ゲ":["ge"],"ゴ":["go"],"ざ":["za"],"じ":["zi","ji"],"ず":["zu"],"ぜ":["ze"],"ぞ":["zo"],"ザ":["za"],"ジ":["zi","ji"],"ズ":["zu"],"ゼ":["ze"],"ゾ":["zo"],"だ":["da"],"ぢ":["di"],"づ":["du","dzu"],"で":["de"],"ど":["do"],"ダ":["da"],"ヂ":["di"],"ヅ":["du","dzu"],"デ":["de"],"ド":["do"],"ば":["ba"],"び":["bi"],"ぶ":["bu"],"べ":["be"],"ぼ":["bo"],"バ":["ba"],"ビ":["bi"],"ブ":["bu"],"ベ":["be"],"ボ":["bo"],"ぱ":["pa"],"ぴ":["pi"],"ぷ":["pu"],"ぺ":["pe"],"ぽ":["po"],"パ":["pa"],"ピ":["pi"],"プ":["pu"],"ペ":["pe"],"ポ":["po"],"きゃ":["kya"],"きゅ":["kyu"],"きょ":["kyo"],"しゃ":["sya","sha"],"しゅ":["syu","shu"],"しょ":["syo","sho"],"ちゃ":["tya","cha"],"ちゅ":["tyu","chu"],"ちょ":["tyo","cho"],"にゃ":["nya"],"にゅ":["nyu"],"にょ":["nyo"],"ひゃ":["hya"],"ひゅ":["hyu"],"ひょ":["hyo"],"みゃ":["mya"],"みゅ":["myu"],"みょ":["myo"],"りゃ":["rya"],"りゅ":["ryu"],"りょ":["ryo"],"ぎゃ":["gya"],"ぎゅ":["gyu"],"ぎょ":["gyo"],"じゃ":["zya","ja","jya"],"じゅ":["zyu","ju","jyu"],"じょ":["zyo","jo","jyo"],"びゃ":["bya"],"びゅ":["byu"],"びょ":["byo"],"ぴゃ":["pya"],"ぴゅ":["pyu"],"ぴょ":["pyo"],"っ":["xtu","ltu","xtsu","ltsu"],"ッ":["xtu","ltu","xtsu","ltsu"],"ぁ":["xa","la"],"ぃ":["xi","li"],"ぅ":["xu","lu"],"ぇ":["xe","le"],"ぉ":["xo","lo"],"ゃ":["xya","lya"],"ゅ":["xyu","lyu"],"ょ":["xyo","lyo"],"、":[","],"。":["."],"？":["?"],"！":["!"],"「":["["],"」":["]"],"ー":["-"],"〜":["~"],"ティ":["thi","texi","teli"],"ディ":["dhi","dexi","deli"],"ファ":["fa","huxa","hula"],"フィ":["fi","huxi","huli"],"フェ":["fe","huxe","hule"],"フォ":["fo","huxo","hulo"],"ウィ":["wi","uxi","uli"],"ウェ":["we","uxe","ule"],"ウォ":["wo","uxo","ulo"],"ヴァ":["va","vuxa"],"ヴィ":["vi","vuxi"],"ヴ":["vu"],"ヴェ":["ve","vuxe"],"ヴォ":["vo","vuxo"],"ゐ":["wi"],"ヰ":["wi"],"ゑ":["we"],"ヱ":["we"]};G8=["っ","ッ"],C8=["、","。","？","！","「","」","（","）","(",")","ー","〜","～","*"]});class R{#z;#J;#W;#Z;constructor(z,J=M.PENDING,W=null,Z=null){if(this.#z=z,this.#Z=Z||z,W)this.#J=W;else if(c(z))this.#J=D8(z);else this.#J=v(z);this.#W=J}get kana(){return this.#z}get romaji(){return this.#J}get state(){return this.#W}get display(){return this.#Z}setCurrent(){return new R(this.#z,M.CURRENT,this.#J,this.#Z)}setCompleted(){return new R(this.#z,M.COMPLETED,this.#J,this.#Z)}matchesRomaji(z){return _8(z,this.#J)}isPartialMatch(z){return w8(z,this.#J)}isPunctuation(){return B8(this.#z)}matchesKana(z){return this.#z===z}matchesDisplay(z){return this.#Z===z}}var M;var L8=O(()=>{o();M={PENDING:"pending",CURRENT:"current",COMPLETED:"completed"}});var P8={};m(P8,{Question:()=>B});function E8(z,J){if(J>=z.length)return null;if(J+1<z.length){let W=z.slice(J,J+2);if(U8.includes(W)||T[W])return W}return z[J]}function I8(z){let J=v(z);if(J.length===0)return!1;let W=["a","i","u","e","o"];return J.some((Z)=>!W.includes(Z[0]))}function f8(z){let J=[],W=0;while(W<z.length){if(H8(z[W])&&W+1<z.length){let Z=E8(z,W+1);if(Z&&I8(Z)){J.push(z[W]+Z),W+=1+Z.length;continue}}if(W+1<z.length){let Z=z.slice(W,W+2);if(U8.includes(Z)||T[Z]){J.push(Z),W+=2;continue}}J.push(z[W]),W+=1}return J}function T8(z){return z==="ん"||z==="ン"}function b8(z){return S8.includes(z)}class B{#z;#J;#W;constructor(z,J,W=0){this.#z=z,this.#J=J,this.#W=W}static fromText(z){let W=f8(z).map((Z,$,X)=>{let Y=null;if(T8(Z))if($===X.length-1)Y=["n","nn"];else{let _=X[$+1];if(b8(_))Y=["nn","n'"]}let w=new R(Z,M.PENDING,Y);return $===0?w.setCurrent():w});return new B(z,W,0)}static fromQuestionData(z){let J=z.characters.map((Z,$)=>{let X=new R(Z.kana,M.PENDING,Z.romaji,Z.display);return $===0?X.setCurrent():X}),W=new B(z.text,J,0);return W._id=z.id,W._displayCharacters=z.characters,W._source=z.source,W._metadata=z.metadata,W}get id(){return this._id}get displayCharacters(){return this._displayCharacters}get source(){return this._source}get metadata(){return this._metadata}get text(){return this.#z}get characters(){return this.#J}get currentIndex(){return this.#W}getCurrentCharacter(){if(this.#W>=this.#J.length)return null;return this.#J[this.#W]}advance(){if(this.isCompleted())return this;let z=this.#J.map((J,W)=>{if(W===this.#W)return J.setCompleted();else if(W===this.#W+1)return J.setCurrent();return J});return new B(this.#z,z,this.#W+1)}isCompleted(){return this.#W>=this.#J.length}getProgress(){if(this.#J.length===0)return 1;return this.#W/this.#J.length}}var U8,S8;var b=O(()=>{L8();o();U8=["きゃ","きゅ","きょ","しゃ","しゅ","しょ","ちゃ","ちゅ","ちょ","にゃ","にゅ","にょ","ひゃ","ひゅ","ひょ","みゃ","みゅ","みょ","りゃ","りゅ","りょ","ぎゃ","ぎゅ","ぎょ","じゃ","じゅ","じょ","びゃ","びゅ","びょ","ぴゃ","ぴゅ","ぴょ","キャ","キュ","キョ","シャ","シュ","ショ","チャ","チュ","チョ","ニャ","ニュ","ニョ","ヒャ","ヒュ","ヒョ","ミャ","ミュ","ミョ","リャ","リュ","リョ","ギャ","ギュ","ギョ","ジャ","ジュ","ジョ","ビャ","ビュ","ビョ","ピャ","ピュ","ピョ","ティ","ディ","ファ","フィ","フェ","フォ","ウィ","ウェ","ウォ","ヴァ","ヴィ","ヴェ","ヴォ"];S8=["な","に","ぬ","ね","の","にゃ","にゅ","にょ","あ","い","う","え","お","や","ゆ","よ","ナ","ニ","ヌ","ネ","ノ","ニャ","ニュ","ニョ","ア","イ","ウ","エ","オ","ヤ","ユ","ヨ"]});var m8={};m(m8,{init:()=>F8,app:()=>E});class I{#z;#J;#W;constructor(z,J){this.#z=J,this.#J=new Set,this.#W=z}getState(){return this.#z}dispatch(z){if(!z||typeof z.type!=="string")throw Error("Action must have a type property");let J=this.#z;if(this.#z=this.#W(this.#z,z),J!==this.#z)this.#Z(z)}subscribe(z){if(typeof z!=="function")throw Error("Listener must be a function");return this.#J.add(z),()=>{this.#J.delete(z)}}#Z(z){this.#J.forEach((J)=>{try{J(this.#z,z)}catch(W){console.error("Store listener error:",W)}})}getListenerCount(){return this.#J.size}}var F={SET_PRACTICE_MODE:"SET_PRACTICE_MODE",SET_INPUT_MODE:"SET_INPUT_MODE",TOGGLE_ROMAJI_HINT:"TOGGLE_ROMAJI_HINT",TOGGLE_KEYBOARD:"TOGGLE_KEYBOARD",SET_FILTER:"SET_FILTER",START_LOADING:"START_LOADING",LOAD_QUESTION_SUCCESS:"LOAD_QUESTION_SUCCESS",LOAD_QUESTION_FAILURE:"LOAD_QUESTION_FAILURE",COMPLETE_SESSION:"COMPLETE_SESSION",RESET_SESSION:"RESET_SESSION",KEY_PRESS:"KEY_PRESS",ROMAJI_MATCH:"ROMAJI_MATCH",CHARACTER_COMPLETE:"CHARACTER_COMPLETE",CHARACTER_MISTAKE:"CHARACTER_MISTAKE",SPEECH_REQUEST:"SPEECH_REQUEST"},Q={setPracticeMode:(z)=>({type:F.SET_PRACTICE_MODE,payload:z}),setInputMode:(z)=>({type:F.SET_INPUT_MODE,payload:z}),toggleRomajiHint:()=>({type:F.TOGGLE_ROMAJI_HINT}),toggleKeyboard:()=>({type:F.TOGGLE_KEYBOARD}),setFilter:(z,J)=>({type:F.SET_FILTER,payload:{key:z,value:J}}),startLoading:()=>({type:F.START_LOADING}),loadQuestionSuccess:(z)=>({type:F.LOAD_QUESTION_SUCCESS,payload:z}),loadQuestionFailure:(z)=>({type:F.LOAD_QUESTION_FAILURE,payload:z}),completeSession:(z)=>({type:F.COMPLETE_SESSION,payload:z}),resetSession:()=>({type:F.RESET_SESSION}),keyPress:(z)=>({type:F.KEY_PRESS,payload:{key:z,timestamp:Date.now()}}),romajiMatch:(z,J)=>({type:F.ROMAJI_MATCH,payload:{romaji:z,isPartial:J}}),characterComplete:(z,J)=>({type:F.CHARACTER_COMPLETE,payload:{character:z,duration:J}}),characterMistake:(z,J)=>({type:F.CHARACTER_MISTAKE,payload:{expected:z,actual:J}}),speechRequest:(z)=>({type:F.SPEECH_REQUEST,payload:{text:z}})};function p(z,J){switch(J.type){case F.SET_PRACTICE_MODE:return{...z,practiceMode:J.payload};case F.SET_INPUT_MODE:return{...z,inputMode:J.payload};case F.TOGGLE_ROMAJI_HINT:return{...z,uiSettings:{...z.uiSettings,showRomajiHint:!z.uiSettings.showRomajiHint}};case F.TOGGLE_KEYBOARD:return{...z,uiSettings:{...z.uiSettings,showKeyboard:!z.uiSettings.showKeyboard}};case F.SET_FILTER:return{...z,filters:{...z.filters,[J.payload.key]:J.payload.value}};case F.START_LOADING:return{...z,status:"loading",error:null};case F.LOAD_QUESTION_SUCCESS:return{...z,status:"practicing",currentQuestion:J.payload,error:null};case F.LOAD_QUESTION_FAILURE:return{...z,status:"error",error:J.payload};case F.COMPLETE_SESSION:return{...z,status:"completed",result:J.payload};case F.RESET_SESSION:return{...z,status:"idle",currentQuestion:null,result:null,error:null,session:{inputBuffer:"",currentIndex:0,keystrokes:0,mistakes:0,startTime:null}};case F.KEY_PRESS:return{...z,session:{...z.session,keystrokes:z.session.keystrokes+1,startTime:z.session.startTime??J.payload.timestamp}};case F.ROMAJI_MATCH:return{...z,session:{...z.session,inputBuffer:J.payload.romaji}};case F.CHARACTER_COMPLETE:return{...z,session:{...z.session,inputBuffer:"",currentIndex:z.session.currentIndex+1}};case F.CHARACTER_MISTAKE:return{...z,session:{...z.session,inputBuffer:"",mistakes:z.session.mistakes+1}};case F.SPEECH_REQUEST:return z;default:return z}}var l={practiceMode:"question",inputMode:"romaji",uiSettings:{showRomajiHint:!0,showKeyboard:!0},filters:{jlpt:"all"},status:"idle",currentQuestion:null,result:null,error:null,session:{inputBuffer:"",currentIndex:0,keystrokes:0,mistakes:0,startTime:null}};function d(z){let{speechService:J,flashEffect:W}=z;return(Z,$)=>{switch($.type){case F.CHARACTER_COMPLETE:W?.flashSuccess();break;case F.CHARACTER_MISTAKE:W?.flashError();break;case F.SPEECH_REQUEST:J?.speak($.payload.text);break}}}C();class f{#z;#J;#W=[];constructor(z,J){this.#z=z,this.#J=J,this.#Z()}#Z(){this.#$(N.KEY_PRESSED,(z)=>{this.#J.dispatch(Q.keyPress(z.key))}),this.#$(N.ROMAJI_MATCHED,(z)=>{this.#J.dispatch(Q.romajiMatch(z.romaji,z.isPartial))}),this.#$(N.CHARACTER_COMPLETED,(z)=>{this.#J.dispatch(Q.characterComplete(z.character,z.duration))}),this.#$(N.CHARACTER_MISTAKEN,(z)=>{this.#J.dispatch(Q.characterMistake(z.expected,z.actual))}),this.#$(N.SPEECH_REQUESTED,(z)=>{this.#J.dispatch(Q.speechRequest(z.text))})}#$(z,J){let W=this.#z.on(z,J);this.#W.push(W)}dispose(){this.#W.forEach((z)=>z()),this.#W=[]}}u();C();class K{static get id(){throw Error("Must implement static id getter")}static get displayName(){throw Error("Must implement static displayName getter")}static get description(){return""}static get requiresQuestionLoader(){return!1}static get supportedInputModes(){return["romaji","direct"]}constructor(z){if(new.target===K)throw Error("PracticeMode is abstract and cannot be instantiated directly");this.store=z.store,this.questionLoader=z.questionLoader,this.speechService=z.speechService,this.session=null}async initialize(){throw Error("Must implement initialize()")}async loadNextQuestion(){throw Error("Must implement loadNextQuestion()")}createSession(z){return this.session=new S(z),this.session}setupSessionListeners(z){z.on(N.SPEECH_REQUESTED,(J)=>{this.speechService?.speak(J.text)}),z.on(N.SESSION_COMPLETED,(J)=>{this.onSessionCompleted(J)}),z.on(N.CHARACTER_MISTAKEN,(J)=>{this.onCharacterMistaken(J)})}onCharacterCompleted(z){}onSessionCompleted(z){this.store.dispatch(Q.completeSession(z))}onCharacterMistaken(z){}dispose(){this.session=null}getUIConfig(){return{showFilters:!1,showSourceLink:!1}}}b();class i extends K{static get id(){return"question"}static get displayName(){return"題庫模式"}static get description(){return"從卡片庫中隨機選取例句練習"}static get requiresQuestionLoader(){return!0}async initialize(){if(!this.questionLoader)throw Error("QuestionMode requires a QuestionLoader");if(!this.questionLoader.isLoaded())this.store.dispatch(Q.startLoading()),await this.questionLoader.load()}async loadNextQuestion(){let J=this.store.getState().filters,W=this.questionLoader.getRandomQuestion(J);if(!W)throw Error("找不到符合條件的題目");return this.store.dispatch(Q.loadQuestionSuccess(W)),B.fromQuestionData(W)}getUIConfig(){return{showFilters:!0,showSourceLink:!0}}}b();var r=["あいうえお","かきくけこ","さしすせそ","たちつてと","なにぬねの","はひふへほ","まみむめも","やゆよ","らりるれろ","わをん","がぎぐげご","ざじずぜぞ","だぢづでど","ばびぶべぼ","ぱぴぷぺぽ","きゃきゅきょ","しゃしゅしょ","ちゃちゅちょ","こんにちは","ありがとう","おはよう","さようなら","いただきます","ごちそうさま"];class s extends K{static get id(){return"kana"}static get displayName(){return"假名模式"}static get description(){return"練習基礎假名輸入"}static get requiresQuestionLoader(){return!1}async initialize(){}async loadNextQuestion(){let z=this.#z();return this.store.dispatch(Q.loadQuestionSuccess({text:z})),B.fromText(z)}#z(){let z=Math.floor(Math.random()*r.length);return r[z]}getUIConfig(){return{showFilters:!1,showSourceLink:!1}}static getPracticeTexts(){return[...r]}}class O8{#z=new Map;#J=null;#W=null;constructor(){this.register(i),this.register(s)}register(z){if(!z.id)throw Error("Mode class must have a static id property");this.#z.set(z.id,z)}unregister(z){this.#z.delete(z)}setDependencies(z){this.#W=z}getAvailableModes(){return Array.from(this.#z.values()).map((z)=>({id:z.id,displayName:z.displayName,description:z.description}))}hasMode(z){return this.#z.has(z)}getModeClass(z){return this.#z.get(z)}async switchMode(z){if(!this.#W)throw Error("Dependencies not set. Call setDependencies() first.");if(this.#J)this.#J.dispose(),this.#J=null;let J=this.#z.get(z);if(!J)throw Error(`Unknown mode: ${z}`);return this.#J=new J(this.#W),await this.#J.initialize(),this.#J}getCurrentMode(){return this.#J}getCurrentModeId(){if(!this.#J)return null;return this.#J.constructor.id}reset(){if(this.#J)this.#J.dispose(),this.#J=null;this.#W=null}}var U=new O8;class A{#z=null;#J=null;constructor(){if(new.target===A)throw Error("InputHandler is abstract and cannot be instantiated directly");this.isActive=!1}setSession(z){this.#z=z}get session(){return this.#z}setUpdateCallback(z){this.#J=z}triggerUpdate(){if(this.#J)this.#J()}activate(){this.isActive=!0}deactivate(){this.isActive=!1}dispose(){this.deactivate(),this.#z=null,this.#J=null}updateHighlight(){}}class a extends A{#z;#J=null;constructor(z=null){super();this.#z=z}activate(){if(this.deactivate(),super.activate(),typeof document>"u")return;this.#J=this.#W.bind(this),document.addEventListener("keydown",this.#J)}deactivate(){if(super.deactivate(),this.#J&&typeof document<"u")document.removeEventListener("keydown",this.#J),this.#J=null}#W(z){if(!this.isActive||!this.session)return;if(z.ctrlKey||z.altKey||z.metaKey)return;if(z.key.length!==1)return;z.preventDefault();let J=z.key.toLowerCase();this.#z?.showKeyPress(J),this.session.handleKeyPress(J),this.triggerUpdate()}updateHighlight(){if(!this.session||!this.#z)return;let z=this.session.getHintRomaji(),J=null;if(z){for(let W of z)if(/[a-z]/i.test(W)){J=W.toLowerCase();break}}this.#z.highlightKey(J)}dispose(){this.deactivate(),this.#z?.highlightKey(null),super.dispose()}setKeyboardRenderer(z){this.#z=z}}class n extends A{#z;#J=null;#W=null;constructor(z=null){super();this.#z=z}setInputElement(z){this.#z=z}activate(){if(this.deactivate(),super.activate(),!this.#z){console.warn("DirectInputHandler: Input element not set");return}this.#J=this.#Z.bind(this),this.#W=this.#Z.bind(this),this.#z.addEventListener("input",this.#J),this.#z.addEventListener("compositionend",this.#W),this.#z.value="",setTimeout(()=>{this.#z?.focus()},100)}deactivate(){if(super.deactivate(),this.#z){if(this.#J)this.#z.removeEventListener("input",this.#J);if(this.#W)this.#z.removeEventListener("compositionend",this.#W)}this.#J=null,this.#W=null}#Z(z){if(!this.isActive||!this.session||!this.#z)return;let J=this.#z.value;if(!J)return;let W=this.session.handleDirectInput(J);if(W.matchedCount>0)this.#z.value=J.substring(W.consumedLength),this.triggerUpdate()}dispose(){if(this.deactivate(),this.#z)this.#z.value="";super.dispose()}focus(){this.#z?.focus()}getInputElement(){return this.#z}}class t{#z;#J;constructor(z={}){this.#z=z.keyboardRenderer||null,this.#J=z.mobileInputElement||null}setKeyboardRenderer(z){this.#z=z}setMobileInputElement(z){this.#J=z}create(z){switch(z){case"romaji":return new a(this.#z);case"direct":return new n(this.#J);default:throw Error(`Unknown input mode: ${z}`)}}static getSupportedModes(){return["romaji","direct"]}}class e{#z;constructor(z){this.#z=z}render(z,J=null){if(!this.#z||!z)return;let W=z.characters,Z;if(J?.characters)Z=J.characters.map(($,X)=>{let Y=W[X];return`<span class="char ${Y?`char-${Y.state}`:"char-pending"}" data-index="${X}">${$.display}</span>`}).join("");else Z=W.map(($,X)=>{return`<span class="char ${`char-${$.state}`}" data-index="${X}">${$.kana}</span>`}).join("");this.#z.innerHTML=Z,this.#J(z.currentIndex)}#J(z){let J=this.#z?.querySelector(`[data-index="${z}"]`);if(!J)return;let W=this.#z.parentElement?.getBoundingClientRect();if(!W)return;let Z=W.width/3,$=J.offsetLeft,X=Math.max(0,$-Z);this.#z.style.transform=`translateX(-${X}px)`}clear(){if(this.#z)this.#z.innerHTML="",this.#z.style.transform=""}getContainer(){return this.#z}}class z8{#z;constructor(z){this.#z=z}render(z){if(!this.#z||!z)return;let W=z.characters.map((Z,$)=>{let X=`romaji-${Z.state}`,Y=Z.romaji[0]||"";return`<span class="romaji ${X}" data-index="${$}">${Y}</span>`}).join("");this.#z.innerHTML=W,this.#J(z.currentIndex)}#J(z){let J=this.#z?.querySelector(`[data-index="${z}"]`);if(!J)return;let W=this.#z.parentElement?.getBoundingClientRect();if(!W)return;let Z=W.width/3,$=J.offsetLeft,X=Math.max(0,$-Z);this.#z.style.transform=`translateX(-${X}px)`}clear(){if(this.#z)this.#z.innerHTML="",this.#z.style.transform=""}getContainer(){return this.#z}}var k={"zh-TW":{pageTitle:"日文輸入練習",siteName:"日文學習卡片盒",backToCards:"← 返回卡片盒",mobileNotice:"請使用桌面瀏覽器搭配實體鍵盤進行練習",backButton:"返回卡片盒",jlptLabel:"JLPT 等級：",jlptAll:"全部",nextQuestion:"下一題",mobileMode:"手機模式",keyboardMode:"鍵盤模式",kanaMode:"假名模式",questionMode:"題庫模式",hideHint:"隱藏提示",showHint:"顯示提示",inputHint:"使用實體鍵盤輸入羅馬拼音",mobileInputPlaceholder:"ここに入力",mobileInputHint:"日本語入力で直接かなを入力",loading:"載入中...",loadingQuestions:"載入題庫中...",complete:"完成！",accuracy:"準確率",time:"時間",keystrokes:"按鍵數",viewSourceCard:"查看來源卡片：",retry:"重新開始",initFailed:"應用程式初始化失敗",reload:"重新載入"},en:{pageTitle:"Japanese Typing Practice",siteName:"Japanese Learning Cards",backToCards:"← Back to Cards",mobileNotice:"Please use a desktop browser with a physical keyboard",backButton:"Back to Cards",jlptLabel:"JLPT Level:",jlptAll:"All",nextQuestion:"Next",mobileMode:"Mobile Mode",keyboardMode:"Keyboard Mode",kanaMode:"Kana Mode",questionMode:"Question Mode",hideHint:"Hide Hint",showHint:"Show Hint",inputHint:"Type romaji using your keyboard",mobileInputPlaceholder:"Type here",mobileInputHint:"Input kana directly using Japanese IME",loading:"Loading...",loadingQuestions:"Loading questions...",complete:"Complete!",accuracy:"Accuracy",time:"Time",keystrokes:"Keystrokes",viewSourceCard:"View source card:",retry:"Retry",initFailed:"Failed to initialize application",reload:"Reload"},ja:{pageTitle:"日本語入力練習",siteName:"日本語学習カード",backToCards:"← カードへ戻る",mobileNotice:"デスクトップブラウザと物理キーボードをご使用ください",backButton:"カードへ戻る",jlptLabel:"JLPTレベル：",jlptAll:"すべて",nextQuestion:"次へ",mobileMode:"スマホモード",keyboardMode:"キーボードモード",kanaMode:"かなモード",questionMode:"問題モード",hideHint:"ヒントを隠す",showHint:"ヒントを表示",inputHint:"キーボードでローマ字を入力",mobileInputPlaceholder:"ここに入力",mobileInputHint:"日本語入力で直接かなを入力",loading:"読み込み中...",loadingQuestions:"問題を読み込み中...",complete:"完了！",accuracy:"正確率",time:"時間",keystrokes:"キー数",viewSourceCard:"ソースカードを見る：",retry:"やり直す",initFailed:"アプリの初期化に失敗しました",reload:"再読み込み"}};var j={ZH_TW:"zh-TW",EN:"en",JA:"ja"},K8="practice_language",q=Object.values(j),x=j.ZH_TW;class M8{#z;#J=[];constructor(){this.#z=this.#W()}#W(){if(typeof window>"u")return x;let z=localStorage.getItem(K8);if(z&&q.includes(z))return z;let W=new URLSearchParams(window.location.search).get("lang");if(W&&q.includes(W))return W;let Z=navigator.language||navigator.userLanguage;if(Z){if(q.includes(Z))return Z;let $=Z.split("-")[0],X=q.find((Y)=>Y.startsWith($)||Y===$);if(X)return X}return x}getLanguage(){return this.#z}getSupportedLanguages(){return[...q]}setLanguage(z){if(!q.includes(z)){console.warn(`Unsupported language: ${z}`);return}if(this.#z=z,typeof localStorage<"u")localStorage.setItem(K8,z);if(typeof window<"u"){let J=new URL(window.location);if(z!==x)J.searchParams.set("lang",z);else J.searchParams.delete("lang");window.history.replaceState({},"",J)}this.#J.forEach((J)=>J(z))}t(z,J={}){let W=k[this.#z];if(!W)return console.warn(`No translations for language: ${this.#z}`),z;let Z=W[z];if(Z===void 0){if(Z=k[x]?.[z],Z===void 0)return console.warn(`Missing translation for key: ${z}`),z}return Object.keys(J).forEach(($)=>{Z=Z.replace(new RegExp(`{{${$}}}`,"g"),J[$])}),Z}subscribe(z){return this.#J.push(z),()=>{let J=this.#J.indexOf(z);if(J>-1)this.#J.splice(J,1)}}getLanguageName(z){return{[j.ZH_TW]:"繁體中文",[j.EN]:"English",[j.JA]:"日本語"}[z]||z}}var V=new M8;class J8{#z;#J;#W=null;constructor(z,J=""){this.#z=z,this.#J=J}setNextQuestionCallback(z){this.#W=z}render(z,J=null){if(!this.#z)return;let W=Math.round(z.accuracy*100),Z=(z.totalTime/1000).toFixed(1),$="";if(J?.source)$=`
        <a href="${this.#J+J.source.path}" class="source-link" target="_blank">
          ${V.t("viewSourceCard")}${J.source.title} →
        </a>
      `;let X=this.#W?`<button class="next-btn" id="next-question-btn">${V.t("nextQuestion")}</button>`:"";this.#z.innerHTML=`
      <div class="result-box">
        <h2>${V.t("complete")}</h2>
        <div class="result-stats">
          <div class="stat">
            <span class="stat-value">${W}%</span>
            <span class="stat-label">${V.t("accuracy")}</span>
          </div>
          <div class="stat">
            <span class="stat-value">${Z}s</span>
            <span class="stat-label">${V.t("time")}</span>
          </div>
          <div class="stat">
            <span class="stat-value">${z.totalKeystrokes}</span>
            <span class="stat-label">${V.t("keystrokes")}</span>
          </div>
        </div>
        ${$}
        <div class="result-actions">
          ${X}
          <button class="retry-btn" onclick="location.reload()">${V.t("retry")}</button>
        </div>
      </div>
    `,this.#z.style.display="flex",this.#Z()}#Z(){if(!this.#W)return;let z=this.#z?.querySelector("#next-question-btn");if(z)z.addEventListener("click",()=>this.#W())}hide(){if(this.#z)this.#z.style.display="none"}dispose(){this.#W=null}getContainer(){return this.#z}}class W8{#z;#J;#W;#Z;constructor(z,J={}){this.#z=z,this.#J=J.successClass||"flash-success",this.#W=J.errorClass||"flash-error",this.#Z=J.duration||200}flashSuccess(){this.#$(this.#J)}flashError(){this.#$(this.#W)}#$(z){if(!this.#z)return;this.#z.classList.add(z),setTimeout(()=>{this.#z?.classList.remove(z)},this.#Z)}setContainer(z){this.#z=z}getContainer(){return this.#z}}class Z8{#z;#J;constructor(z){this.#z=z,this.#J=null}highlightKey(z){if(this.#J)this.#J.classList.remove("key-target");if(!z){this.#J=null;return}let J=this.#z.querySelector(`[data-key="${z}"]`);if(J)J.classList.add("key-target"),this.#J=J}showKeyPress(z){let J=this.#z.querySelector(`[data-key="${z}"]`);if(!J)return;J.classList.add("key-pressed"),setTimeout(()=>{J.classList.remove("key-pressed")},100)}clearHighlights(){this.#z.querySelectorAll(".key").forEach((J)=>{J.classList.remove("key-target","key-pressed")}),this.#J=null}}class g{constructor(z){if(!z){let W=window.location.pathname.match(/^(.*?)\/[^\/]+\/?$/);z=`${W?W[1]:""}/data/questions.json`}this.dataUrl=z,this.basePath=this.dataUrl.replace(/\/[^\/]+$/,""),this.questionBank=null,this.index=null,this.loadedBundles=new Set,this.loadingPromises=new Map,this.recentIds=new Set,this.maxRecentHistory=10,this.useProgressiveLoading=!1}async loadIndex(){if(this.index)return this.index;let z=`${this.basePath}/questions-index.json`;try{let J=await fetch(z);if(!J.ok)return null;return this.index=await J.json(),console.log(`索引檔載入完成: ${Object.keys(this.index.bundles).length} 個分包`),this.index}catch(J){return console.log("索引檔不存在，使用傳統載入模式"),null}}async loadInitial(){let z=await this.loadIndex();if(z)return this.useProgressiveLoading=!0,this.questionBank={version:z.version,generated:z.generated,questions:[],stats:z.stats},await this.loadBundle("init"),console.log(`初始載入完成: ${this.questionBank.questions.length} 題`),this.questionBank;return this.loadLegacy()}async loadBundle(z){if(this.loadedBundles.has(z))return;if(this.loadingPromises.has(z))return this.loadingPromises.get(z);if(!this.index)throw Error("索引檔尚未載入");let J=this.index.bundles[z];if(!J){console.warn(`分包不存在: ${z}`);return}let W=`${this.basePath}/${J.path}`,Z=(async()=>{try{let $=await fetch(W);if(!$.ok)throw Error(`載入分包失敗: ${$.status}`);let X=await $.json();this.mergeQuestions(X.questions),this.loadedBundles.add(z),console.log(`分包載入完成: ${z} (${X.questions.length} 題)`)}catch($){throw console.error(`載入分包 ${z} 失敗:`,$),$}finally{this.loadingPromises.delete(z)}})();return this.loadingPromises.set(z,Z),Z}mergeQuestions(z){if(!this.questionBank)return;let J=new Set(this.questionBank.questions.map((Z)=>Z.id)),W=z.filter((Z)=>!J.has(Z.id));this.questionBank.questions.push(...W)}async loadInBackground(z){for(let J of z)if(!this.loadedBundles.has(J)&&this.index?.bundles[J])try{await this.loadBundle(J)}catch(W){console.warn(`背景載入 ${J} 失敗，稍後重試`)}}isLevelLoaded(z){return this.loadedBundles.has(z)}getLoadingStatus(){let z=this.index?Object.keys(this.index.bundles).length:1;return{loadedBundles:[...this.loadedBundles],totalQuestions:this.questionBank?.questions.length||0,isFullyLoaded:this.loadedBundles.size>=z}}async loadLegacy(){try{let z=await fetch(this.dataUrl);if(!z.ok)throw Error(`載入題庫失敗: ${z.status} ${z.statusText}`);return this.questionBank=await z.json(),this.loadedBundles.add("legacy"),console.log(`題庫載入完成（傳統模式）: ${this.questionBank.questions.length} 題`),this.questionBank}catch(z){throw console.error("題庫載入錯誤:",z),z}}async load(){if(this.questionBank)return this.questionBank;return this.loadInitial()}isLoaded(){return this.questionBank!==null}getAllQuestions(){return this.questionBank?.questions||[]}filterQuestions(z={}){let J=this.getAllQuestions();if(z.jlpt&&z.jlpt!=="all")J=J.filter((W)=>W.source.jlpt===z.jlpt);if(z.category&&z.category!=="all")J=J.filter((W)=>W.source.category===z.category);if(z.difficulty&&z.difficulty!=="all")J=J.filter((W)=>W.metadata.difficulty===z.difficulty);return J}getRandomQuestion(z={}){let J=this.filterQuestions(z);if(J.length===0)return null;let W=J.filter((X)=>!this.recentIds.has(X.id));if(W.length===0)this.recentIds.clear(),W=J;let Z=Math.floor(Math.random()*W.length),$=W[Z];if(this.recentIds.add($.id),this.recentIds.size>this.maxRecentHistory){let X=this.recentIds.values().next().value;this.recentIds.delete(X)}return $}getQuestionById(z){return this.getAllQuestions().find((J)=>J.id===z)||null}getStats(){return this.questionBank?.stats||null}getJlptLevels(){let z=this.getStats();if(!z?.byJlpt)return["n5","n4","n3","n2","n1"];return Object.keys(z.byJlpt).sort()}getCategories(){let z=this.getStats();if(!z?.byCategory)return[];return Object.keys(z.byCategory).sort()}resetHistory(){this.recentIds.clear()}}var tz=new g;class $8{#z;#J;#W;constructor(z={}){this.#z=z.lang||"ja-JP",this.#J=z.rate||1,this.#W=z.speechSynthesis||(typeof window<"u"?window.speechSynthesis:void 0)}get lang(){return this.#z}isSupported(){return this.#W!==void 0&&this.#W!==null}speak(z){return new Promise((J,W)=>{if(!this.isSupported()){J();return}let Z=this.#Z(z);Z.lang=this.#z,Z.rate=this.#J,Z.onend=()=>J(),Z.onerror=($)=>W($),this.#W.speak(Z)})}cancel(){if(this.isSupported())this.#W.cancel()}#Z(z){if(typeof SpeechSynthesisUtterance<"u")return new SpeechSynthesisUtterance(z);return{text:z,lang:"",rate:1,onend:null,onerror:null}}}var H={inputMode:"practice-input-mode",showRomajiHint:"practice-show-hint",jlptFilter:"practice-jlpt-filter"};class X8{#z;constructor(z=null){this.#z=z||(typeof localStorage<"u"?localStorage:null)}load(){if(!this.#z)return null;try{let z=this.#z.getItem(H.inputMode),J=this.#z.getItem(H.showRomajiHint),W=this.#z.getItem(H.jlptFilter);return{inputMode:z||"romaji",showRomajiHint:J!=="false",filters:{jlpt:W||"all"}}}catch(z){return console.warn("Failed to load settings from localStorage:",z),null}}save(z){if(!this.#z)return;try{if(z.inputMode!==void 0)this.#z.setItem(H.inputMode,z.inputMode);if(z.showRomajiHint!==void 0)this.#z.setItem(H.showRomajiHint,z.showRomajiHint?"true":"false");if(z.filters?.jlpt!==void 0)this.#z.setItem(H.jlptFilter,z.filters.jlpt)}catch(J){console.warn("Failed to save settings to localStorage:",J)}}clear(){if(!this.#z)return;try{Object.values(H).forEach((z)=>{this.#z.removeItem(z)})}catch(z){console.warn("Failed to clear settings from localStorage:",z)}}get(z){if(!this.#z)return null;let J=H[z];if(!J)return null;try{return this.#z.getItem(J)}catch(W){return null}}set(z,J){if(!this.#z)return;let W=H[z];if(!W)return;try{this.#z.setItem(W,J)}catch(Z){console.warn(`Failed to save ${z} to localStorage:`,Z)}}}C();class V8{#z;#J;#W={};#Z=null;#$;#V=null;#F=null;#X;#N;#Y;#w;#Q;constructor(z){this.#J=z,this.#z=new I(p,l),this.#Q=new g,this.#N=new $8,this.#Y=new X8,U.setDependencies({store:this.#z,questionLoader:this.#Q,speechService:this.#N}),this.#U(),this.#w=new Z8(z.keyboardContainer),this.#$=new t({keyboardRenderer:this.#w,mobileInputElement:z.mobileInputElement}),this.#X=new W8(z.textContainer),this.#O();let J=d({speechService:this.#N,flashEffect:this.#X});this.#z.subscribe(J)}#U(){this.#W.text=new e(this.#J.textContainer),this.#W.romaji=new z8(this.#J.romajiContainer),this.#W.result=new J8(this.#J.resultContainer,this.#P())}#P(){if(typeof window>"u")return"";let J=window.location.pathname.match(/^(.*?)\/[^\/]+\/?$/);return J?J[1]:""}#O(){this.#z.subscribe((z,J)=>{this.#K(z,J)})}#K(z,J){switch(J.type){case F.COMPLETE_SESSION:this.#v(z.result,z.currentQuestion);break;case F.TOGGLE_ROMAJI_HINT:this.#L(z.uiSettings.showRomajiHint);break;case F.TOGGLE_KEYBOARD:this.#G(z.uiSettings.showKeyboard);break;case F.ROMAJI_MATCH:this.#C(z.session.inputBuffer);break;case F.CHARACTER_COMPLETE:this.#B();break}}async initialize(){let z=this.#Y.load();if(z){if(z.inputMode&&z.inputMode!=="romaji")this.#z.dispatch(Q.setInputMode(z.inputMode));if(z.filters?.jlpt)this.#z.dispatch(Q.setFilter("jlpt",z.filters.jlpt));if(z.showRomajiHint===!1)this.#z.dispatch(Q.toggleRomajiHint());if(z.showKeyboard===!1)this.#z.dispatch(Q.toggleKeyboard())}let J=this.#M();if(J.input==="direct"||J.input==="mobile")this.#z.dispatch(Q.setInputMode("direct"));if(J.text)await this.#R(J.text);else{let W=J.mode==="kana"?"kana":"question";await this.switchPracticeMode(W)}this.#j()}#M(){if(typeof window>"u")return{};let z=new URLSearchParams(window.location.search);return{text:z.get("text"),mode:z.get("mode"),input:z.get("input")}}async#R(z){let{Question:J}=await Promise.resolve().then(() => (b(),P8)),W=J.fromText(z);this.#z.dispatch(Q.loadQuestionSuccess({text:z})),this.#H(W)}async switchPracticeMode(z){try{this.#z.dispatch(Q.setPracticeMode(z)),await U.switchMode(z),await this.loadNextQuestion()}catch(J){console.error("Switch mode failed:",J),this.#z.dispatch(Q.loadQuestionFailure(J.message))}}switchInputMode(z){this.#z.dispatch(Q.setInputMode(z)),this.#Y.save({inputMode:z}),this.#E("input",z==="direct"?"direct":null),this.#_(z),this.loadNextQuestion()}setFilter(z,J){this.#z.dispatch(Q.setFilter(z,J)),this.#Y.save({filters:{[z]:J}}),this.loadNextQuestion()}toggleRomajiHint(){this.#z.dispatch(Q.toggleRomajiHint());let z=this.#z.getState();this.#Y.save({showRomajiHint:z.uiSettings.showRomajiHint})}toggleKeyboard(){if(this.#z.getState().inputMode==="romaji"){this.#z.dispatch(Q.toggleKeyboard());let J=this.#z.getState();this.#Y.save({showKeyboard:J.uiSettings.showKeyboard})}}async loadNextQuestion(){let z=U.getCurrentMode();if(!z)return;this.#D();try{this.#z.dispatch(Q.startLoading()),this.#W.result.hide();let J=await z.loadNextQuestion();this.#H(J)}catch(J){console.error("Load question failed:",J),this.#z.dispatch(Q.loadQuestionFailure(J.message))}}#H(z){let J=U.getCurrentMode(),W=J?J.createSession(z):this.#A(z);if(this.#V=W,this.#F=new f(W,this.#z),J)J.setupSessionListeners(W);if(!J)W.on(N.SESSION_COMPLETED,(Z)=>{this.#z.dispatch(Q.completeSession(Z))});this.#q(this.#z.getState().inputMode),this.#B()}async#A(z){let{TypingSession:J}=await Promise.resolve().then(() => (u(),N8));return new J(z)}#D(){if(this.#Z)this.#Z.dispose(),this.#Z=null;if(this.#F)this.#F.dispose(),this.#F=null;this.#V=null}#q(z){if(this.#Z)this.#Z.dispose();this.#Z=this.#$.create(z),this.#Z.setSession(this.#V),this.#Z.setUpdateCallback(()=>this.#B()),this.#Z.activate(),this.#_(z)}#_(z){let J=this.#J.container,W=typeof document<"u"?document.body:null,Z=typeof document<"u"?document.getElementById("mobile-input-section"):null;if(z==="direct"){if(J?.classList.add("mode-direct"),W?.classList.add("mode-direct"),Z)Z.style.display="block";this.#G(!1)}else{if(J?.classList.remove("mode-direct"),W?.classList.remove("mode-direct"),Z)Z.style.display="none";let $=this.#z.getState();this.#G($.uiSettings.showKeyboard)}}#G(z){let J=this.#J.keyboardContainer;if(J)J.style.display=z?"":"none"}#L(z){let J=this.#J.container;if(J)J.classList.toggle("hide-romaji-hint",!z)}#j(){let z=this.#z.getState();this.#L(z.uiSettings.showRomajiHint),this.#_(z.inputMode)}#B(){if(!this.#V)return;let z=this.#z.getState(),J=this.#V.question;if(this.#W.text.render(J,z.currentQuestion),this.#W.romaji.render(J),this.#Z?.updateHighlight)this.#Z.updateHighlight()}#C(z){let J=this.#J.bufferDisplay;if(J)J.textContent=z}#v(z,J){this.#W.result.setNextQuestionCallback(()=>this.loadNextQuestion()),this.#W.result.render(z,J)}#E(z,J){if(typeof window>"u")return;let W=new URL(window.location);if(J)W.searchParams.set(z,J);else W.searchParams.delete(z);window.history.replaceState({},"",W)}getStore(){return this.#z}getState(){return this.#z.getState()}getQuestionLoader(){return this.#Q}dispose(){this.#D(),Object.values(this.#W).forEach((z)=>z.dispose?.()),U.reset()}}var E=null;function k8(z){let J=document.querySelector(".practice-container");if(!J)return;if(document.getElementById("practice-controls"))return;let W=z.getState(),Z=W.inputMode==="romaji"?V.t("mobileMode"):V.t("keyboardMode"),$=W.uiSettings.showRomajiHint?V.t("hideHint"):V.t("showHint"),X=W.practiceMode==="question"?V.t("kanaMode"):V.t("questionMode"),Y=W.practiceMode==="kana"?"none":"",w=V.getLanguage(),_=V.getSupportedLanguages().map((h)=>{return`<option value="${h}" ${h===w?"selected":""}>${V.getLanguageName(h)}</option>`}).join(""),G=document.createElement("div");G.id="practice-controls",G.className="practice-controls"+(W.practiceMode==="kana"?" controls-centered":""),G.innerHTML=`
    <div class="control-group" id="jlpt-filter-group" style="display: ${Y}">
      <label for="jlpt-filter">${V.t("jlptLabel")}</label>
      <select id="jlpt-filter">
        <option value="all">${V.t("jlptAll")}</option>
        <option value="n5">N5</option>
        <option value="n4">N4</option>
        <option value="n3">N3</option>
        <option value="n2">N2</option>
        <option value="n1">N1</option>
      </select>
    </div>
    <div class="control-group">
      <button id="btn-next" class="control-btn">${V.t("nextQuestion")}</button>
      <button id="btn-toggle-practice" class="control-btn secondary">${X}</button>
      <button id="btn-toggle-input" class="control-btn secondary">${Z}</button>
      <button id="btn-toggle-hint" class="control-btn secondary">${$}</button>
      <select id="lang-selector" class="lang-selector">${_}</select>
    </div>
  `;let P=J.querySelector(".practice-area")||J.firstChild;J.insertBefore(G,P),x8(z)}function x8(z){let J=document.getElementById("jlpt-filter");if(J){let w=z.getState();J.value=w.filters.jlpt,J.addEventListener("change",(_)=>{z.setFilter("jlpt",_.target.value)})}let W=document.getElementById("btn-next");if(W)W.addEventListener("click",()=>{z.loadNextQuestion()});let Z=document.getElementById("btn-toggle-practice");if(Z)Z.addEventListener("click",()=>{let _=z.getState().practiceMode==="question"?"kana":"question";z.switchPracticeMode(_),Z.textContent=_==="question"?V.t("kanaMode"):V.t("questionMode");let G=document.getElementById("jlpt-filter-group"),P=document.getElementById("practice-controls");if(G)G.style.display=_==="kana"?"none":"";if(P)P.classList.toggle("controls-centered",_==="kana")});let $=document.getElementById("btn-toggle-input");if($)$.addEventListener("click",()=>{let _=z.getState().inputMode==="romaji"?"direct":"romaji";z.switchInputMode(_),$.textContent=_==="romaji"?V.t("mobileMode"):V.t("keyboardMode")});let X=document.getElementById("btn-toggle-hint");if(X)X.addEventListener("click",()=>{z.toggleRomajiHint();let w=z.getState();X.textContent=w.uiSettings.showRomajiHint?V.t("hideHint"):V.t("showHint")});let Y=document.getElementById("lang-selector");if(Y)Y.addEventListener("change",(w)=>{V.setLanguage(w.target.value),location.reload()})}function g8(){document.title=`${V.t("pageTitle")} | ${V.t("siteName")}`;let z=document.querySelector(".back-link");if(z)z.textContent=V.t("backToCards");let J=document.querySelector(".mobile-notice p");if(J)J.textContent=V.t("mobileNotice");let W=document.querySelector(".mobile-notice .back-btn");if(W)W.textContent=V.t("backButton");let Z=document.querySelector(".practice-title");if(Z)Z.textContent=V.t("pageTitle");let $=document.getElementById("mobile-kana-input");if($)$.placeholder=V.t("mobileInputPlaceholder");let X=document.querySelector(".mobile-input-hint");if(X)X.textContent=V.t("mobileInputHint");let Y=document.querySelector(".practice-footer .hint");if(Y)Y.textContent=V.t("inputHint");document.documentElement.lang=V.getLanguage()}function h8(z){if(z)z.innerHTML=`<span class="loading">${V.t("loadingQuestions")}</span>`}function y8(z,J){if(z)z.innerHTML=`
      <div class="error-message">
        <p>${J}</p>
        <button onclick="location.reload()">${V.t("reload")}</button>
      </div>
    `}async function F8(){g8();let z=document.getElementById("practice-text"),J=document.getElementById("practice-romaji"),W=document.getElementById("keyboard"),Z=document.querySelector(".practice-container");if(!z||!J||!W){console.error("找不到必要的 DOM 元素");return}let $=document.getElementById("result-container");if(!$)$=document.createElement("div"),$.id="result-container",$.className="result-container",$.style.display="none",Z?.appendChild($);let X=document.getElementById("buffer-display");if(!X)X=document.createElement("div"),X.id="buffer-display",X.className="buffer-display",J.parentNode?.insertBefore(X,J.nextSibling);let Y=document.getElementById("mobile-kana-input");h8(z);try{E=new V8({container:Z,textContainer:z,romajiContainer:J,resultContainer:$,bufferDisplay:X,keyboardContainer:W,mobileInputElement:Y}),await E.initialize(),k8(E),console.log("應用程式初始化完成")}catch(w){console.error("應用程式初始化失敗:",w),y8(z,V.t("initFailed"))}if(typeof window<"u")window.__app=E}if(typeof document<"u")if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",F8);else F8();})();
